 = type;

    const [requests, total] = await Promise.all([
      this.prisma.leaveRequest.findMany({
        where,
        orderBy: { createdAt: 'desc' },
        skip: (page - 1) * limit,
        take: limit,
        include: {
          approver: { select: { firstName: true, lastName: true } },
        },
      }),
      this.prisma.leaveRequest.count({ where }),
    ]);

    return {
      data: requests,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
      },
    };
  }

  async getLeaveRequestById(id: string, userId?: string) {
    const leaveRequest = await this.prisma.leaveRequest.findUnique({
      where: { id },
      include: {
        user: {
          select: { id: true, firstName: true, lastName: true, employeeCode: true },
        },
        approver: { select: { firstName: true, lastName: true } },
      },
    });

    if (!leaveRequest) {
      throw new NotFoundException('طلب الإجازة غير موجود');
    }

    // Check permission
    if (userId && leaveRequest.userId !== userId) {
      const user = await this.prisma.user.findUnique({ where: { id: userId } });
      if (user?.role === 'EMPLOYEE') {
        throw new ForbiddenException('غير مصرح بالوصول لهذا الطلب');
      }
    }

    return leaveRequest;
  }

  async cancelLeaveRequest(id: string, userId: string) {
    const leaveRequest = await this.prisma.leaveRequest.findUnique({
      where: { id },
  