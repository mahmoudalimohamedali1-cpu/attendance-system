// Prisma Schema للنظام الحضور والانصراف
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== الشركات (Tenant) ====================

model Company {
  id       String  @id @default(uuid())
  name     String  @unique
  nameEn   String? @map("name_en")
  crNumber String? @unique @map("cr_number") // رقم السجل التجاري
  taxId    String? @unique @map("tax_id") // الرقم الضريبي
  logo     String?
  address  String?
  phone    String?
  email    String?
  website  String?

  // روابط العلاقات
  users                User[]
  branches             Branch[]
  jobTitles            JobTitle[]
  costCenters          CostCenter[]
  salaryComponents     SalaryComponent[]
  salaryStructures     SalaryStructure[]
  policies             Policy[]
  payrollPeriods       PayrollPeriod[]
  payrollRuns          PayrollRun[]
  holidays             Holiday[]
  gosiConfigs          GosiConfig[]
  departments          Department[]
  workSchedules        WorkSchedule[]
  attendances          Attendance[]
  leaveRequests        LeaveRequest[]
  letterRequests       LetterRequest[]
  notifications        Notification[]
  auditLogs            AuditLog[]
  advanceRequests      AdvanceRequest[]
  retroPays            RetroPay[]
  suspiciousAttempts   SuspiciousAttempt[]
  workFromHomes        WorkFromHome[]
  approvalLogs         ApprovalLog[]
  payslips             Payslip[]
  systemSettings       SystemSetting[]
  permissionAuditLogs  PermissionAuditLog[]
  raiseRequests        RaiseRequest[]
  userPermissions      UserPermission[]
  mudadSubmissions     MudadSubmission[]
  wpsSubmissions       WpsSubmission[]
  submissionStatusLogs SubmissionStatusLog[]
  approvalChainConfigs ApprovalChainConfig[]
  companyBankAccounts  CompanyBankAccount[]
  disciplinaryCases    DisciplinaryCase[]
  disciplinaryPolicy   CompanyDisciplinaryPolicy?
  payrollAdjustments   PayrollAdjustment[]
  payrollSettings      PayrollSettings?

  // العهد (Custody)
  custodyCategories   CustodyCategory[]
  custodyItems        CustodyItem[]
  custodyAssignments  CustodyAssignment[]
  custodyReturns      CustodyReturn[]
  custodyTransfers    CustodyTransfer[]
  custodyMaintenances CustodyMaintenance[]

  // نظام الإجازات المتقدم
  leaveTypeConfigs LeaveTypeConfig[]
  leaveBalances    LeaveBalance[]

  // السياسات الذكية (AI-Powered)
  smartPolicies SmartPolicy[]

  // نظام تتبع الموقع (Location Tracking)
  employeeLocationLogs EmployeeLocationLog[]
  geofenceExitEvents   GeofenceExitEvent[]

  // نظام الترحيب (Onboarding)
  onboardingTemplates OnboardingTemplate[]
  onboardingProcesses OnboardingProcess[]

  // التحليلات التنبؤية (AI Predictive Analytics)
  absencePredictions   AbsencePrediction[]
  predictionAccuracies PredictionAccuracy[]
  absencePatterns      AbsencePattern[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("companies")
}

// ==================== إعدادات الرواتب (Payroll Settings) ====================

// قاعدة حساب يوم العمل
enum WorkDayCalculationBase {
  CALENDAR_DAYS // حساب على أساس أيام التقويم (30 يوم)
  ACTUAL_WORKING_DAYS // حساب على أساس أيام العمل الفعلية
  FIXED_30_DAYS // ثابت 30 يوم
}

// طريقة حساب التوظيف وإنهاء الخدمات
enum HireTerminationMethod {
  EXCLUDE_WEEKENDS // استثناء عطلات نهاية الأسبوع
  INCLUDE_ALL_DAYS // شمول جميع الأيام
  PRORATE_BY_CALENDAR // التناسب حسب التقويم
}

// طريقة حساب الإجازات غير المدفوعة
enum UnpaidLeaveMethod {
  BASED_ON_SHIFTS // على أساس مناوبات العمل
  BASED_ON_CALENDAR // على أساس التقويم
  BASED_ON_WORKING_DAYS // على أساس أيام العمل فقط
}

// طريقة حساب العمل الإضافي
enum OvertimeCalculationMethod {
  BASED_ON_SHIFTS // على أساس مناوبات العمل
  BASED_ON_BASIC_ONLY // على أساس الراتب الأساسي فقط
  BASED_ON_TOTAL // على أساس إجمالي الراتب
  BASED_ON_ELIGIBLE_COMPONENTS // على أساس البدلات الخاضعة للإضافي
}

// طريقة حساب بدل الإجازة
enum LeaveAllowanceMethod {
  BASIC_SALARY // الراتب الأساسي
  BASIC_PLUS_HOUSING // الراتب الأساسي + بدل السكن
  TOTAL_SALARY // إجمالي الراتب
}

model PayrollSettings {
  id        String  @id @default(uuid())
  companyId String  @unique @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // ========== تاريخ إغلاق الرواتب ==========
  payrollClosingDay Int @default(25) @map("payroll_closing_day") // 0-28

  // ========== حساب التوظيف وإنهاء الخدمات ==========
  hireTerminationCalcBase WorkDayCalculationBase @default(CALENDAR_DAYS) @map("hire_termination_calc_base")
  hireTerminationMethod   HireTerminationMethod  @default(EXCLUDE_WEEKENDS) @map("hire_termination_method")

  // ========== حساب الإجازات غير المدفوعة ==========
  unpaidLeaveCalcBase      WorkDayCalculationBase @default(ACTUAL_WORKING_DAYS) @map("unpaid_leave_calc_base")
  unpaidLeaveMethod        UnpaidLeaveMethod      @default(BASED_ON_SHIFTS) @map("unpaid_leave_method")
  splitUnpaidByClosingDate Boolean                @default(false) @map("split_unpaid_by_closing_date") // تقسيم بناءً على تاريخ الإغلاق

  // ========== حساب ساعات العمل الإضافي ==========
  overtimeCalcBase WorkDayCalculationBase    @default(ACTUAL_WORKING_DAYS) @map("overtime_calc_base")
  overtimeMethod   OvertimeCalculationMethod @default(BASED_ON_SHIFTS) @map("overtime_method")

  // ========== حساب بدل أيام الإجازة ==========
  leaveAllowanceCalcBase WorkDayCalculationBase @default(CALENDAR_DAYS) @map("leave_allowance_calc_base")
  leaveAllowanceMethod   LeaveAllowanceMethod   @default(BASIC_PLUS_HOUSING) @map("leave_allowance_method")

  // ========== إعدادات قسيمة الراتب ==========
  showCompanyContributions Boolean @default(true) @map("show_company_contributions") // إظهار مساهمات الشركة
  showClosingDateOnPayslip Boolean @default(true) @map("show_closing_date_on_payslip") // إظهار تاريخ الإغلاق
  deductAbsenceFromBasic   Boolean @default(true) @map("deduct_absence_from_basic") // اقتطاع الغياب من الأساسي
  showActualAbsenceDays    Boolean @default(false) @map("show_actual_absence_days") // إظهار حساب أيام الغياب الفعلي

  // ========== أرصدة الرواتب السلبية ==========
  enableNegativeBalanceCarryover Boolean @default(false) @map("enable_negative_balance_carryover") // ترحيل الرصيد السلبي
  settleNegativeAsTransaction    Boolean @default(false) @map("settle_negative_as_transaction") // تسوية كحركة خارجية

  // ========== إعدادات إضافية ==========
  roundSalaryToNearest       Int @default(0) @map("round_salary_to_nearest") // تقريب الراتب (0 = بدون تقريب)
  defaultWorkingDaysPerMonth Int @default(30) @map("default_working_days_per_month")
  leaveDailyRateDivisor      Int @default(30) @map("leave_daily_rate_divisor") // مقسم الراتب اليومي للإجازات

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payroll_settings")
}

// ==================== المستخدمين والأدوار ====================

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
  HR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ContractType {
  PERMANENT // عقد دائم (غير محدد المدة)
  FIXED_TERM // عقد محدد المدة
  PART_TIME // دوام جزئي
  SEASONAL // موسمي
  PROBATION // فترة تجربة
}

enum ContractStatus {
  DRAFT // مسودة
  PENDING_EMPLOYEE // بانتظار توقيع الموظف
  PENDING_EMPLOYER // بانتظار توقيع صاحب العمل
  PENDING_QIWA // بانتظار التوثيق في قوى
  ACTIVE // ساري
  EXPIRED // منتهي
  TERMINATED // منهي
  RENEWED // مجدد
  SUSPENDED // موقوف
  REJECTED // مرفوض من قوى
}

enum QiwaAuthStatus {
  NOT_SUBMITTED // لم يرسل لقوى
  PENDING // بانتظار التوثيق
  AUTHENTICATED // موثق في قوى
  REJECTED // مرفوض
  EXPIRED // منتهي التوثيق
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  phone        String?    @unique
  password     String
  firstName    String     @map("first_name")
  lastName     String     @map("last_name")
  avatar       String?
  employeeCode String?    @map("employee_code")
  jobTitle     String?    @map("job_title") // Legacy - مسمى وظيفي نصي
  role         Role       @default(EMPLOYEE)
  status       UserStatus @default(ACTIVE)
  salary       Decimal?   @db.Decimal(10, 2)
  hireDate     DateTime?  @map("hire_date")
  nationality  String?    @map("nationality")
  isSaudi      Boolean    @default(true) @map("is_saudi")
  fcmToken     String?    @map("fcm_token")
  nationalId   String?    @unique @map("national_id") // رقم الهوية أو الإقامة

  // بيانات الإقامة والجواز (للأجانب) - متطلبات قوى
  iqamaNumber        String?   @map("iqama_number") // رقم الإقامة
  iqamaExpiryDate    DateTime? @map("iqama_expiry_date") @db.Date
  borderNumber       String?   @map("border_number") // رقم الحدود
  passportNumber     String?   @map("passport_number") // رقم الجواز
  passportExpiryDate DateTime? @map("passport_expiry_date") @db.Date
  professionCode     String?   @map("profession_code") // كود المهنة في قوى
  profession         String?   @map("profession") // اسم المهنة

  // بيانات GOSI/HRSD - متطلبات التأمينات ووزارة الموارد البشرية
  dateOfBirth   DateTime? @map("date_of_birth") @db.Date // تاريخ الميلاد
  gender        String? // MALE, FEMALE - الجنس
  gosiNumber    String?   @unique @map("gosi_number") // رقم التأمينات الاجتماعية
  maritalStatus String?   @map("marital_status") // SINGLE, MARRIED, DIVORCED, WIDOWED

  // Super Admin - يتخطى كل الـ guards
  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // الدرجة الوظيفية (الجديد)
  jobTitleId  String?   @map("job_title_id")
  jobTitleRef JobTitle? @relation(fields: [jobTitleId], references: [id])

  // رصيد الإجازات
  annualLeaveDays    Int @default(21) @map("annual_leave_days") // إجمالي أيام الإجازة السنوية
  usedLeaveDays      Int @default(0) @map("used_leave_days") // الأيام المستخدمة
  remainingLeaveDays Int @default(21) @map("remaining_leave_days") // الأيام المتبقية

  // بيانات التعرف على الوجه
  faceRegistered Boolean   @default(false) @map("face_registered")
  faceData       FaceData?

  // العلاقات
  companyId    String?     @map("company_id")
  company      Company?    @relation(fields: [companyId], references: [id])
  branchId     String?     @map("branch_id")
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])
  managerId    String?     @map("manager_id")
  manager      User?       @relation("ManagerEmployees", fields: [managerId], references: [id])
  employees    User[]      @relation("ManagerEmployees")

  // السجلات
  attendances             Attendance[]
  leaveRequests           LeaveRequest[]   @relation("EmployeeLeaveRequests")
  approvedLeaves          LeaveRequest[]   @relation("ApproverLeaveRequests")
  managerApprovedLeaves   LeaveRequest[]   @relation("ManagerApproverLeaveRequests")
  hrApprovedLeaves        LeaveRequest[]   @relation("HRApproverLeaveRequests")
  letterRequests          LetterRequest[]  @relation("EmployeeLetterRequests")
  approvedLetters         LetterRequest[]  @relation("ApproverLetterRequests")
  managerApprovedLetters  LetterRequest[]  @relation("ManagerApproverLetterRequests")
  hrApprovedLetters       LetterRequest[]  @relation("HRApproverLetterRequests")
  raiseRequests           RaiseRequest[]   @relation("EmployeeRaiseRequests")
  managerApprovedRaises   RaiseRequest[]   @relation("ManagerApproverRaiseRequests")
  hrApprovedRaises        RaiseRequest[]   @relation("HRApproverRaiseRequests")
  financeApprovedRaises   RaiseRequest[]   @relation("FinanceApproverRaiseRequests")
  ceoApprovedRaises       RaiseRequest[]   @relation("CEOApproverRaiseRequests")
  advanceRequests         AdvanceRequest[] @relation("EmployeeAdvanceRequests")
  managerApprovedAdvances AdvanceRequest[] @relation("ManagerApproverAdvanceRequests")
  hrApprovedAdvances      AdvanceRequest[] @relation("HRApproverAdvanceRequests")
  financeApprovedAdvances AdvanceRequest[] @relation("FinanceApproverAdvanceRequests")
  ceoApprovedAdvances     AdvanceRequest[] @relation("CEOApproverAdvanceRequests")
  notifications           Notification[]
  refreshTokens           RefreshToken[]
  auditLogs               AuditLog[]

  // إعدادات العمل من المنزل
  workFromHome WorkFromHome[]

  // المحاولات المشبوهة
  suspiciousAttempts SuspiciousAttempt[]

  // الأجهزة المسجلة
  registeredDevices RegisteredDevice[]

  // صلاحيات المستخدم
  userPermissions UserPermission[]

  // سجل الموافقات (Audit)
  approvalLogs ApprovalLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // روابط الرواتب والموارد البشرية الجديدة
  bankAccounts      EmployeeBankAccount[]
  contracts         Contract[]
  salaryAssignments EmployeeSalaryAssignment[] @relation("EmployeeSalaryAssignments")
  payslips          Payslip[]
  costCenterId      String?                    @map("cost_center_id")
  costCenter        CostCenter?                @relation(fields: [costCenterId], references: [id])
  retroPays         RetroPay[]
  policyTargets     Policy[]                   @relation("PolicyTargetEmployee")

  // Disciplinary Relations
  createdDisciplinaryCases DisciplinaryCase[]           @relation("ManagerCreatedCases")
  disciplinaryCases        DisciplinaryCase[]           @relation("EmployeeDisciplinaryCases")
  disciplinaryRecords      EmployeeDisciplinaryRecord[]
  payrollAdjustments       PayrollAdjustment[]

  // العهد (Custody Relations)
  custodyAssignments        CustodyAssignment[]  @relation("EmployeeCustody")
  custodyAssignedBy         CustodyAssignment[]  @relation("CustodyAssigner")
  custodyApproved           CustodyAssignment[]  @relation("CustodyApprover")
  custodyReturns            CustodyReturn[]      @relation("CustodyReturner")
  custodyReturnReviews      CustodyReturn[]      @relation("CustodyReturnReviewer")
  custodyTransfersFrom      CustodyTransfer[]    @relation("CustodyTransferFrom")
  custodyTransfersTo        CustodyTransfer[]    @relation("CustodyTransferTo")
  custodyTransferInitiated  CustodyTransfer[]    @relation("CustodyTransferInitiator")
  custodyTransferApproved   CustodyTransfer[]    @relation("CustodyTransferApprover")
  custodyMaintenanceReports CustodyMaintenance[] @relation("MaintenanceReporter")

  // حقول مخصصة (للاستيراد الذكي)
  customFields UserCustomField[]

  // وثائق الموظف
  employeeDocuments EmployeeDocument[]

  // أرصدة الإجازات المتقدمة
  leaveBalances LeaveBalance[]

  // نظام تتبع الموقع (Location Tracking)
  locationLogs       EmployeeLocationLog[]
  geofenceExitEvents GeofenceExitEvent[]

  // نظام الترحيب (Onboarding)
  onboardingProcesses OnboardingProcess[]

  // التحليلات التنبؤية (AI Predictive Analytics)
  absencePredictions AbsencePrediction[]

  @@unique([companyId, employeeCode])
  @@index([companyId, status])
  @@map("users")
}

// ==================== حقول مخصصة للموظفين (Smart Import) ====================

model UserCustomField {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fieldName  String @map("field_name") // اسم الحقل (مثل "راتب_الدوام")
  fieldValue String @map("field_value") @db.Text // القيمة
  fieldType  String @default("text") @map("field_type") // text, number, date, etc.

  // مصدر الحقل
  sourceHeader String?  @map("source_header") // اسم العمود الأصلي في ملف الاستيراد
  importedAt   DateTime @default(now()) @map("imported_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, fieldName])
  @@index([userId])
  @@index([fieldName])
  @@map("user_custom_fields")
}

// ==================== الدرجات الوظيفية ====================

model JobTitle {
  id              String   @id @default(uuid())
  companyId       String?  @map("company_id")
  company         Company? @relation(fields: [companyId], references: [id])
  name            String
  nameEn          String?  @map("name_en") // الاسم بالإنجليزية (اختياري)
  level           Role     @default(EMPLOYEE) // الدرجة: ADMIN, MANAGER, EMPLOYEE
  isDirectManager Boolean  @default(false) @map("is_direct_manager") // هل يمكن أن يكون مدير مباشر؟
  isActive        Boolean  @default(true) @map("is_active") // للحذف الناعم

  // الموظفين بهذه الدرجة
  users User[]

  // الصلاحيات الافتراضية لهذه الدرجة
  defaultPermissions JobTitlePermission[]
  policies           Policy[] // سياسات على مستوى الدرجة

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name])
  @@index([companyId, isActive])
  @@map("job_titles")
}

// ==================== الأجهزة المسجلة للموظفين ====================

enum DeviceStatus {
  ACTIVE // نشط ومعتمد
  PENDING // في انتظار الموافقة
  BLOCKED // محظور
  INACTIVE // غير نشط
}

enum DevicePlatform {
  ANDROID
  IOS
  WEB
  UNKNOWN
}

model RegisteredDevice {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // معرف الجهاز الفريد
  deviceId          String  @map("device_id") // Unique device identifier
  deviceFingerprint String? @map("device_fingerprint") // Hash of device info

  // معلومات الجهاز
  deviceName  String?        @map("device_name") // e.g., "iPhone 14 Pro"
  deviceModel String?        @map("device_model") // e.g., "iPhone14,3"
  deviceBrand String?        @map("device_brand") // e.g., "Apple"
  platform    DevicePlatform @default(UNKNOWN)
  osVersion   String?        @map("os_version") // e.g., "iOS 17.2"
  appVersion  String?        @map("app_version") // e.g., "1.0.0"

  // حالة الجهاز
  status       DeviceStatus @default(PENDING)
  isMainDevice Boolean      @default(false) @map("is_main_device") // الجهاز الرئيسي

  // الموافقة
  approvedBy    String?   @map("approved_by")
  approvedAt    DateTime? @map("approved_at")
  blockedReason String?   @map("blocked_reason")

  // إحصائيات الاستخدام
  lastUsedAt DateTime? @map("last_used_at")
  usageCount Int       @default(0) @map("usage_count")

  // سجل المحاولات
  deviceLogs DeviceAccessLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, deviceId])
  @@index([deviceId])
  @@index([userId, status])
  @@map("registered_devices")
}

// سجل محاولات الوصول من الأجهزة
model DeviceAccessLog {
  id       String            @id @default(uuid())
  deviceId String?           @map("device_id")
  device   RegisteredDevice? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  userId            String @map("user_id")
  attemptedDeviceId String @map("attempted_device_id") // معرف الجهاز المستخدم

  // نوع المحاولة
  actionType    String  @map("action_type") // CHECK_IN, CHECK_OUT, LOGIN
  isSuccess     Boolean @map("is_success")
  isKnownDevice Boolean @map("is_known_device")

  // معلومات إضافية
  deviceInfo String? @map("device_info") @db.Text // JSON with full device info
  ipAddress  String? @map("ip_address")
  location   String? // lat,lng

  // سبب الفشل
  failureReason String? @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([attemptedDeviceId])
  @@map("device_access_logs")
}

// ==================== طلبات تحديث بيانات الحضور ====================

enum UpdateRequestStatus {
  PENDING // في انتظار المراجعة
  APPROVED // تمت الموافقة
  REJECTED // مرفوض
  CANCELLED // ملغي من الموظف
}

enum UpdateRequestType {
  FACE_UPDATE // تحديث بيانات الوجه فقط
  DEVICE_UPDATE // تحديث بيانات الجهاز فقط
  BOTH // تحديث كليهما
  DEVICE_CHANGE // تغيير جهاز (موبايل جديد)
  PROFILE_UPDATE // تحديث بيانات الملف الشخصي
}

model DataUpdateRequest {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // نوع التحديث
  requestType UpdateRequestType   @map("request_type")
  status      UpdateRequestStatus @default(PENDING)

  // سبب الطلب من الموظف
  reason String? @db.Text

  // ============ بيانات الوجه الجديدة ============
  newFaceEmbedding String? @map("new_face_embedding") @db.Text
  newFaceImage     String? @map("new_face_image") @db.Text // صورة Base64
  faceImageQuality Float?  @map("face_image_quality")

  // ============ بيانات الجهاز الجديد ============
  newDeviceId          String?         @map("new_device_id")
  newDeviceFingerprint String?         @map("new_device_fingerprint")
  newDeviceName        String?         @map("new_device_name")
  newDeviceModel       String?         @map("new_device_model")
  newDeviceBrand       String?         @map("new_device_brand")
  newDevicePlatform    DevicePlatform? @map("new_device_platform")
  newDeviceOsVersion   String?         @map("new_device_os_version")
  newDeviceAppVersion  String?         @map("new_device_app_version")

  // ============ بيانات المراجعة ============
  reviewedBy      String?   @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNote      String?   @map("review_note") // ملاحظة المسؤول
  rejectionReason String?   @map("rejection_reason")

  // ============ بيانات الملف الشخصي الجديدة ============
  newData Json? @map("new_data")

  // ============ معلومات إضافية ============
  oldDeviceId String? @map("old_device_id") // الجهاز القديم للمقارنة

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("data_update_requests")
}

// ==================== بيانات التعرف على الوجه ====================

model FaceData {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Face Embeddings - مصفوفة الأرقام التي تمثل ملامح الوجه
  faceEmbedding String @map("face_embedding") @db.Text // JSON array of floats

  // صورة الوجه المرجعية (Base64 مشفرة)
  faceImage String? @map("face_image") @db.Text

  // معلومات إضافية
  registeredAt      DateTime  @default(now()) @map("registered_at")
  lastVerifiedAt    DateTime? @map("last_verified_at")
  verificationCount Int       @default(0) @map("verification_count")

  // جودة الصورة والتحقق
  imageQuality Float? @map("image_quality") // 0-1
  confidence   Float? // ثقة التسجيل

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("face_data")
}

model RefreshToken {
  id         String   @id @default(uuid())
  token      String   @unique
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

// ==================== الفروع والأقسام ====================

model Branch {
  id             String   @id @default(uuid())
  companyId      String?  @map("company_id")
  company        Company? @relation(fields: [companyId], references: [id])
  name           String
  nameEn         String?  @map("name_en")
  address        String?
  latitude       Decimal  @db.Decimal(10, 8)
  longitude      Decimal  @db.Decimal(11, 8)
  geofenceRadius Int      @default(100) @map("geofence_radius") // بالمتر
  timezone       String   @default("Asia/Riyadh")
  isActive       Boolean  @default(true) @map("is_active")

  // مواعيد العمل الافتراضية
  workStartTime String @default("09:00") @map("work_start_time")
  workEndTime   String @default("17:00") @map("work_end_time")

  // فترات السماح
  lateGracePeriod     Int @default(10) @map("late_grace_period") // دقائق
  earlyCheckInPeriod  Int @default(15) @map("early_check_in_period") // دقائق قبل بداية الدوام
  earlyCheckOutPeriod Int @default(0) @map("early_check_out_period") // دقائق

  // أيام العمل
  workingDays String @default("1,2,3,4,5") @map("working_days") // 0=الأحد, 6=السبت

  users        User[]
  departments  Department[]
  attendances  Attendance[]
  schedules    WorkSchedule[]
  policies     Policy[] // سياسات على مستوى الفرع
  custodyItems CustodyItem[] // العهد في هذا الفرع

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name])
  @@map("branches")
}

model Department {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  name      String
  nameEn    String?  @map("name_en")
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])

  // جدول عمل خاص بالقسم (اختياري)
  workStartTime String? @map("work_start_time")
  workEndTime   String? @map("work_end_time")

  users    User[]
  policies Policy[] // سياسات على مستوى القسم

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name])
  @@map("departments")
}

// ==================== جدول العمل ====================

model WorkSchedule {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])

  dayOfWeek     Int     @map("day_of_week") // 0-6 (الأحد - السبت)
  workStartTime String  @map("work_start_time")
  workEndTime   String  @map("work_end_time")
  isWorkingDay  Boolean @default(true) @map("is_working_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([branchId, dayOfWeek])
  @@map("work_schedules")
}

// ==================== سجلات الحضور ====================

enum AttendanceStatus {
  PRESENT // حضر في الوقت
  LATE // متأخر
  EARLY_LEAVE // انصراف مبكر
  ABSENT // غائب
  ON_LEAVE // إجازة
  WORK_FROM_HOME // عمل من المنزل
}

enum CheckType {
  CHECK_IN
  CHECK_OUT
}

model Attendance {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])

  date DateTime @db.Date

  status       AttendanceStatus @default(ABSENT)
  checkInTime  DateTime?        @map("check_in_time")
  checkOutTime DateTime?        @map("check_out_time")

  // معلومات الموقع عند الحضور
  checkInLatitude  Decimal? @map("check_in_latitude") @db.Decimal(10, 8)
  checkInLongitude Decimal? @map("check_in_longitude") @db.Decimal(11, 8)
  checkInDistance  Int?     @map("check_in_distance") // المسافة بالمتر من الفرع

  // معلومات الموقع عند الانصراف
  checkOutLatitude  Decimal? @map("check_out_latitude") @db.Decimal(10, 8)
  checkOutLongitude Decimal? @map("check_out_longitude") @db.Decimal(11, 8)
  checkOutDistance  Int?     @map("check_out_distance")

  // إحصائيات الحضور (يتم حسابها بعد الانصراف)
  lateMinutes       Int @default(0) @map("late_minutes")
  earlyLeaveMinutes Int @default(0) @map("early_leave_minutes")
  workingMinutes    Int @default(0) @map("working_minutes")
  overtimeMinutes   Int @default(0) @map("overtime_minutes")

  // ملاحظات
  notes          String?
  isWorkFromHome Boolean @default(false) @map("is_work_from_home")

  // محاولات مشبوهة
  isMockLocation Boolean @default(false) @map("is_mock_location")
  deviceInfo     String? @map("device_info")

  // التحقق بالوجه
  checkInFaceVerified    Boolean @default(false) @map("check_in_face_verified")
  checkInFaceConfidence  Float?  @map("check_in_face_confidence")
  checkOutFaceVerified   Boolean @default(false) @map("check_out_face_verified")
  checkOutFaceConfidence Float?  @map("check_out_face_confidence")

  // أحداث الخروج من النطاق
  geofenceExitEvents GeofenceExitEvent[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, date])
  @@index([companyId, date])
  @@index([userId, date])
  @@index([branchId, date])
  @@map("attendances")
}

// سجل محاولات التحقق بالوجه
model FaceVerificationLog {
  id     String @id @default(uuid())
  userId String @map("user_id")

  verificationType String  @map("verification_type") // CHECK_IN, CHECK_OUT, REGISTRATION
  isSuccess        Boolean @map("is_success")
  confidence       Float? // نسبة التطابق
  threshold        Float? // الحد الأدنى المطلوب

  // معلومات الجهاز
  deviceInfo String? @map("device_info")
  ipAddress  String? @map("ip_address")

  // صورة المحاولة (اختياري للتدقيق)
  attemptImage String? @map("attempt_image") @db.Text

  errorMessage String? @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("face_verification_logs")
}

// سجل محاولات الحضور المشبوهة
model SuspiciousAttempt {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  attemptType String   @map("attempt_type") // MOCK_LOCATION, OUT_OF_RANGE, etc.
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  distance    Int? // المسافة من الفرع
  deviceInfo  String?  @map("device_info")
  ipAddress   String?  @map("ip_address")
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("suspicious_attempts")
}

// ==================== نظام إدارة الإجازات المتقدم ====================

// تصنيف الإجازات
enum LeaveCategory {
  BALANCED // إجازات متوازنة/متراكمة (سنوية)
  CASUAL // إجازات عارضة (زواج، وفاة)
  SICK // إجازات مرضية
  UNPAID // بدون راتب
}

// إعدادات أنواع الإجازات - Dynamic Leave Type Configuration
model LeaveTypeConfig {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  code        String // ANNUAL, SICK, MARRIAGE - للرجوع البرمجي
  nameAr      String  @map("name_ar")
  nameEn      String? @map("name_en")
  description String?

  // تصنيف الإجازة
  category LeaveCategory @default(BALANCED)

  // إعدادات الاستحقاق
  isEntitlementBased Boolean @default(true) @map("is_entitlement_based") // هل تعتمد على استحقاق سنوي؟
  defaultEntitlement Int     @default(0) @map("default_entitlement") // الاستحقاق الافتراضي
  maxBalanceCap      Int?    @map("max_balance_cap") // الحد الأقصى للتراكم (مثل 60 يوم)

  // إعدادات الترحيل
  allowCarryForward        Boolean @default(true) @map("allow_carry_forward")
  maxCarryForwardDays      Int?    @map("max_carry_forward_days")
  carryForwardExpiryMonths Int?    @map("carry_forward_expiry_months") // صلاحية الأيام المرحلة

  // إعدادات الراتب
  isPaid            Boolean @default(true) @map("is_paid")
  paymentPercentage Int     @default(100) @map("payment_percentage") // نسبة الراتب

  // متطلبات
  requiresAttachment          Boolean @default(false) @map("requires_attachment")
  attachmentRequiredAfterDays Int?    @map("attachment_required_after_days")
  minNoticeDays               Int     @default(0) @map("min_notice_days") // فترة الإشعار المسبق
  minRequestDays              Int     @default(1) @map("min_request_days")
  maxRequestDays              Int?    @map("max_request_days")

  // قواعد خاصة
  allowNegativeBalance Boolean @default(false) @map("allow_negative_balance")
  deductFromAnnual     Boolean @default(false) @map("deduct_from_annual") // خصم من السنوية إذا نفد الرصيد
  isOneTimeOnly        Boolean @default(false) @map("is_one_time_only") // مرة واحدة فقط (مثل الحج)

  // الحالة
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  // العلاقات
  entitlementTiers LeaveEntitlementTier[]
  sickPayTiers     SickPayTier[]
  leaveBalances    LeaveBalance[]
  leaveRequests    LeaveRequest[]         @relation("LeaveTypeConfigRequests")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@index([companyId, isActive])
  @@map("leave_type_configs")
}

// شرائح الاستحقاق حسب سنوات الخدمة
model LeaveEntitlementTier {
  id          String          @id @default(uuid())
  leaveTypeId String          @map("leave_type_id")
  leaveType   LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  minServiceYears Int @map("min_service_years") // من سنة
  maxServiceYears Int @map("max_service_years") // إلى سنة (999 = غير محدود)
  entitlementDays Int @map("entitlement_days") // عدد أيام الاستحقاق

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([leaveTypeId, minServiceYears])
  @@index([leaveTypeId])
  @@map("leave_entitlement_tiers")
}

// شرائح أجر الإجازة المرضية (نظام العمل السعودي)
model SickPayTier {
  id          String          @id @default(uuid())
  leaveTypeId String          @map("leave_type_id")
  leaveType   LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  fromDay        Int @map("from_day") // من يوم
  toDay          Int @map("to_day") // إلى يوم
  paymentPercent Int @map("payment_percent") // نسبة الراتب (100, 75, 0)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([leaveTypeId, fromDay])
  @@index([leaveTypeId])
  @@map("sick_pay_tiers")
}

// رصيد الإجازات لكل موظف لكل نوع
model LeaveBalance {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  userId      String          @map("user_id")
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId String          @map("leave_type_id")
  leaveType   LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id])

  year Int // السنة الميلادية

  // الاستحقاق
  entitled       Decimal @default(0) @db.Decimal(5, 2) // المستحق للسنة
  carriedForward Decimal @default(0) @map("carried_forward") @db.Decimal(5, 2) // المرحل من السنة السابقة

  // الاستخدام
  used    Decimal @default(0) @db.Decimal(5, 2) // المستخدم
  pending Decimal @default(0) @db.Decimal(5, 2) // المعلق (طلبات قيد الموافقة)

  // للإجازات العارضة (مثل الزواج) - عدد مرات الاستخدام
  timesUsed Int @default(0) @map("times_used")

  // تاريخ انتهاء صلاحية الأيام المرحلة
  carryForwardExpiresAt DateTime? @map("carry_forward_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, leaveTypeId, year])
  @@index([userId, year])
  @@index([leaveTypeId])
  @@index([companyId])
  @@map("leave_balances")
}

// ==================== طلبات الإجازات ====================

enum LeaveType {
  ANNUAL // إجازة سنوية
  SICK // إجازة مرضية
  PERSONAL // إجازة شخصية
  EMERGENCY // إجازة طارئة
  NEW_BABY // مولود جديد
  MARRIAGE // إجازة زواج
  BEREAVEMENT // إجازة الوفاة
  HAJJ // إجازة الحج
  EXAM // إجازة اختبارات
  WORK_MISSION // مهمة عمل
  UNPAID // إجازة بدون راتب
  EARLY_LEAVE // انصراف مبكر (كطلب إجازة)
  OTHER // أخرى
}

enum LeaveStatus {
  PENDING
  MGR_APPROVED // موافقة المدير (الخطوة الأولى)
  MGR_REJECTED // رفض المدير
  APPROVED // موافقة نهائية (HR)
  REJECTED // رفض نهائي (HR)
  MODIFIED // تم التعديل والموافقة
  CANCELLED
  DELAYED // مؤجل
}

enum ApprovalStep {
  MANAGER
  HR
  FINANCE
  CEO
  COMPLETED
}

enum ApprovalDecision {
  PENDING
  APPROVED
  REJECTED
  DELAYED
}

model LeaveRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeLeaveRequests", fields: [userId], references: [id])

  type      LeaveType
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime  @map("end_date") @db.Date

  // عدد الأيام
  requestedDays Int  @default(1) @map("requested_days") // الأيام المطلوبة
  approvedDays  Int? @map("approved_days") // الأيام المعتمدة (قد تختلف)

  reason      String      @db.Text // السبب
  notes       String?     @db.VarChar(500) // ملاحظات إضافية
  attachments Json? // مرفقات
  status      LeaveStatus @default(PENDING)

  // ========== Workflow متعدد المراحل ==========
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId  String?          @map("manager_approver_id")
  managerApprover    User?            @relation("ManagerApproverLeaveRequests", fields: [managerApproverId], references: [id])
  managerDecision    ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt  DateTime?        @map("manager_decision_at")
  managerNotes       String?          @map("manager_notes") @db.VarChar(500)
  managerAttachments Json?            @map("manager_attachments")

  // موافقة HR
  hrApproverId    String?          @map("hr_approver_id")
  hrApprover      User?            @relation("HRApproverLeaveRequests", fields: [hrApproverId], references: [id])
  hrDecision      ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt    DateTime?        @map("hr_decision_at")
  hrDecisionNotes String?          @map("hr_decision_notes") @db.VarChar(500)
  hrAttachments   Json?            @map("hr_attachments")

  // Legacy: الموافقة القديمة (للتوافق)
  approverId    String?   @map("approver_id")
  approver      User?     @relation("ApproverLeaveRequests", fields: [approverId], references: [id])
  approverNotes String?   @map("approver_notes")
  approvedAt    DateTime? @map("approved_at")

  // ========== نظام الإجازات المتقدم ==========

  // ربط مع LeaveTypeConfig (اختياري للتوافق الخلفي)
  leaveTypeConfigId String?          @map("leave_type_config_id")
  leaveTypeConfig   LeaveTypeConfig? @relation("LeaveTypeConfigRequests", fields: [leaveTypeConfigId], references: [id])

  // للإجازة المرضية - حساب الأجر المتدرج (نظام العمل السعودي)
  fullPayDays    Int? @map("full_pay_days") // أيام براتب كامل (100%)
  partialPayDays Int? @map("partial_pay_days") // أيام براتب جزئي (75%)
  unpaidDays     Int? @map("unpaid_days") // أيام بدون راتب (0%)

  // للتأثير على الرواتب
  salaryImpact Decimal? @map("salary_impact") @db.Decimal(10, 2) // قيمة الخصم/الإضافة

  // وقت التقديم بالنسبة للإشعار المسبق
  noticeDaysProvided Int? @map("notice_days_provided")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([userId, status])
  @@index([leaveTypeConfigId])
  @@map("leave_requests")
}

// ==================== طلبات الخطابات ====================

enum LetterType {
  SALARY_DEFINITION // خطاب تعريف راتب
  SERVICE_CONFIRMATION // خطاب تأكيد خدمة
  SALARY_ADJUSTMENT // خطاب تعديل راتب
  PROMOTION // خطاب ترقية
  TRANSFER_ASSIGNMENT // خطاب نقل / تكليف
  RESIGNATION // خطاب استقالة (معتمد من الشركة)
  TERMINATION // خطاب إنهاء خدمة
  CLEARANCE // خطاب إخلاء طرف
  EXPERIENCE // خطاب خبرة
  SALARY_DEFINITION_DIRECTED // خطاب تعريف راتب (موجّه لجهة محددة)
  NOC // خطاب عدم ممانعة
  DELEGATION // خطاب تفويض
}

enum LetterStatus {
  PENDING
  MGR_APPROVED // موافقة المدير
  MGR_REJECTED // رفض المدير
  APPROVED // موافقة نهائية (HR)
  REJECTED // رفض نهائي (HR)
  DELAYED // مؤجل
  CANCELLED
}

model LetterRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeLetterRequests", fields: [userId], references: [id])

  type        LetterType
  notes       String?      @db.VarChar(200) // الملاحظات (حد أقصى 200 حرف)
  attachments Json? // مرفقات (صور/ملفات)
  status      LetterStatus @default(PENDING)

  // ========== Workflow متعدد المراحل ==========
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId  String?          @map("manager_approver_id")
  managerApprover    User?            @relation("ManagerApproverLetterRequests", fields: [managerApproverId], references: [id])
  managerDecision    ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt  DateTime?        @map("manager_decision_at")
  managerNotes       String?          @map("manager_notes") @db.VarChar(500)
  managerAttachments Json?            @map("manager_attachments")

  // موافقة HR
  hrApproverId    String?          @map("hr_approver_id")
  hrApprover      User?            @relation("HRApproverLetterRequests", fields: [hrApproverId], references: [id])
  hrDecision      ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt    DateTime?        @map("hr_decision_at")
  hrDecisionNotes String?          @map("hr_decision_notes") @db.VarChar(500)
  hrAttachments   Json?            @map("hr_attachments")

  // Legacy: الموافقة القديمة (للتوافق)
  approverId    String?   @map("approver_id")
  approver      User?     @relation("ApproverLetterRequests", fields: [approverId], references: [id])
  approverNotes String?   @map("approver_notes")
  approvedAt    DateTime? @map("approved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("letter_requests")
}

// ==================== العمل من المنزل ====================

model WorkFromHome {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  company    Company? @relation(fields: [companyId], references: [id])
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  date       DateTime @db.Date
  reason     String?
  approvedBy String?  @map("approved_by")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("work_from_home")
}

// ==================== الإشعارات ====================

enum NotificationType {
  LATE_CHECK_IN
  EARLY_CHECK_OUT
  EARLY_CHECK_IN
  LEAVE_APPROVED
  LEAVE_REJECTED
  LETTER_APPROVED
  LETTER_REJECTED
  SUSPICIOUS_ACTIVITY
  GENERAL
  // Disciplinary notifications
  DISC_CASE_SUBMITTED
  DISC_HR_REJECTED
  DISC_INFORMAL_SENT
  DISC_EMP_REJECTED_INFORMAL
  DISC_HEARING_SCHEDULED
  DISC_DECISION_ISSUED
  DISC_EMP_OBJECTED
  DISC_FINALIZED
  // Location tracking notifications
  EMP_EXIT_GEOFENCE // موظف خرج من نطاق الشركة
  EMP_RETURN_GEOFENCE // موظف عاد إلى نطاق الشركة
}

model Notification {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  type    NotificationType
  title   String
  titleEn String?          @map("title_en")
  body    String
  bodyEn  String?          @map("body_en")
  data    Json? // بيانات إضافية

  // Entity reference for navigation
  entityType String? @map("entity_type") // DISCIPLINARY_CASE, LEAVE_REQUEST
  entityId   String? @map("entity_id")

  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([userId, isRead])
  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// ==================== سجل التدقيق ====================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SETTINGS_CHANGE
  EXPORT
  IMPORT
}

model AuditLog {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id])

  action      AuditAction
  entity      String // اسم الكيان (User, Branch, etc.)
  entityId    String?     @map("entity_id")
  oldValue    Json?       @map("old_value")
  newValue    Json?       @map("new_value")
  description String?
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId, createdAt])
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== العطلات الرسمية ====================

model Holiday {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  name        String
  nameEn      String?  @map("name_en")
  date        DateTime @db.Date
  isRecurring Boolean  @default(false) @map("is_recurring") // تتكرر كل سنة

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("holidays")
}

// ==================== إعدادات النظام ====================

model SystemSetting {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  key         String
  value       String
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([key, companyId])
  @@map("system_settings")
}

// ==================== نظام الصلاحيات ====================

enum PermissionScope {
  SELF // نفسي فقط
  TEAM // فريقي المباشر (المرؤوسين)
  BRANCH // فرع معين
  DEPARTMENT // قسم معين
  ALL // كل الموظفين
  CUSTOM // موظفين محددين
}

model Permission {
  id          String  @id @default(uuid())
  code        String  @unique // LEAVES_VIEW, LEAVES_APPROVE, etc.
  name        String // الاسم بالعربي
  nameEn      String? @map("name_en")
  category    String // التصنيف
  description String?

  // الصلاحية المطلوبة مسبقاً
  requiresPermission String? @map("requires_permission")

  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  userPermissions     UserPermission[]
  jobTitlePermissions JobTitlePermission[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([code])
  @@map("permissions")
}

model UserPermission {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  // نطاق الصلاحية
  scope        PermissionScope @default(SELF)
  branchId     String?         @map("branch_id")
  departmentId String?         @map("department_id")

  // الموظفين المحددين (إذا كان النطاق CUSTOM)
  assignedEmployees UserPermissionEmployee[]

  createdAt DateTime @default(now()) @map("created_at")

  // السماح بنفس الصلاحية بنطاقات مختلفة
  @@unique([userId, permissionId, scope, branchId, departmentId])
  // فهارس للأداء
  @@index([userId])
  @@index([permissionId])
  @@index([userId, permissionId])
  @@index([scope, branchId])
  @@index([scope, departmentId])
  @@index([companyId])
  @@map("user_permissions")
}

model UserPermissionEmployee {
  id               String         @id @default(uuid())
  userPermissionId String         @map("user_permission_id")
  userPermission   UserPermission @relation(fields: [userPermissionId], references: [id], onDelete: Cascade)
  employeeId       String         @map("employee_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userPermissionId, employeeId])
  @@index([userPermissionId])
  @@index([employeeId])
  @@map("user_permission_employees")
}

// ==================== الصلاحيات الافتراضية للدرجات الوظيفية ====================

model JobTitlePermission {
  id           String     @id @default(uuid())
  jobTitleId   String     @map("job_title_id")
  jobTitle     JobTitle   @relation(fields: [jobTitleId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // النطاق الافتراضي للصلاحية
  scope PermissionScope @default(TEAM)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([jobTitleId, permissionId])
  @@index([jobTitleId])
  @@index([permissionId])
  @@map("job_title_permissions")
}

// ==================== سجل تدقيق الصلاحيات ====================

enum PermissionAuditAction {
  ADDED // تمت إضافة صلاحية
  REMOVED // تم حذف صلاحية
  MODIFIED // تم تعديل النطاق
}

model PermissionAuditLog {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  // من قام بالإجراء
  performedById String @map("performed_by_id")

  // على من تم الإجراء
  targetUserId   String @map("target_user_id")
  targetUserName String @map("target_user_name") // حفظ الاسم للـ history

  // تفاصيل الإجراء
  action         PermissionAuditAction
  permissionCode String                @map("permission_code")
  permissionName String                @map("permission_name")

  // تفاصيل النطاق
  scope        PermissionScope?
  scopeDetails String?          @map("scope_details") // اسم الفرع/القسم/الموظفين

  // معلومات إضافية
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([performedById])
  @@index([targetUserId])
  @@index([createdAt])
  @@index([permissionCode])
  @@map("permission_audit_logs")
}

// ==================== سجل الموافقات (Audit) ====================

model ApprovalLog {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  requestType String   @map("request_type") // LEAVE, LETTER, DATA_UPDATE, RAISE
  requestId   String   @map("request_id")
  step        String // MANAGER, HR
  decision    String // APPROVED, REJECTED, DELAYED
  notes       String?  @db.VarChar(500)
  byUserId    String   @map("by_user_id")
  byUser      User     @relation(fields: [byUserId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([requestType, requestId])
  @@index([byUserId])
  @@map("approval_logs")
}

// ==================== طلبات الزيادة ====================

enum RaiseType {
  SALARY_INCREASE // زيادة راتب
  ANNUAL_LEAVE_BONUS // بدل إجازة سنوية
  BUSINESS_TRIP // رحلة عمل
  BONUS // مكافأة
  ALLOWANCE // بدل
  OTHER // أخرى
}

enum RaiseStatus {
  PENDING
  MGR_APPROVED // موافقة المدير
  MGR_REJECTED // رفض المدير
  APPROVED // موافقة نهائية (HR)
  REJECTED // رفض نهائي (HR)
  DELAYED // مؤجل
  CANCELLED
}

model RaiseRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeRaiseRequests", fields: [userId], references: [id])

  type           RaiseType
  amount         Decimal     @db.Decimal(10, 2) // المبلغ المطلوب
  effectiveMonth DateTime    @map("effective_month") @db.Date // الزيادة لشهر
  notes          String?     @db.VarChar(200) // الملاحظات (حد أقصى 200 حرف)
  attachments    Json? // مرفقات (صور/ملفات)
  status         RaiseStatus @default(PENDING)

  // ========== Workflow متعدد المراحل ==========
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId  String?          @map("manager_approver_id")
  managerApprover    User?            @relation("ManagerApproverRaiseRequests", fields: [managerApproverId], references: [id])
  managerDecision    ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt  DateTime?        @map("manager_decision_at")
  managerNotes       String?          @map("manager_notes") @db.VarChar(500)
  managerAttachments Json?            @map("manager_attachments")

  // موافقة HR
  hrApproverId    String?          @map("hr_approver_id")
  hrApprover      User?            @relation("HRApproverRaiseRequests", fields: [hrApproverId], references: [id])
  hrDecision      ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt    DateTime?        @map("hr_decision_at")
  hrDecisionNotes String?          @map("hr_decision_notes") @db.VarChar(500)
  hrAttachments   Json?            @map("hr_attachments")

  // موافقة المدير المالي (Finance)
  financeApproverId    String?          @map("finance_approver_id")
  financeApprover      User?            @relation("FinanceApproverRaiseRequests", fields: [financeApproverId], references: [id])
  financeDecision      ApprovalDecision @default(PENDING) @map("finance_decision")
  financeDecisionAt    DateTime?        @map("finance_decision_at")
  financeDecisionNotes String?          @map("finance_decision_notes") @db.VarChar(500)

  // موافقة المدير العام (CEO)
  ceoApproverId    String?          @map("ceo_approver_id")
  ceoApprover      User?            @relation("CEOApproverRaiseRequests", fields: [ceoApproverId], references: [id])
  ceoDecision      ApprovalDecision @default(PENDING) @map("ceo_decision")
  ceoDecisionAt    DateTime?        @map("ceo_decision_at")
  ceoDecisionNotes String?          @map("ceo_decision_notes") @db.VarChar(500)

  // Flexible approval chain
  approvalChain   Json?   @map("approval_chain") // ["MANAGER", "HR", "FINANCE", "CEO"]
  appliedToSalary Boolean @default(false) @map("applied_to_salary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("raise_requests")
}

// ==================== السلف (Advance Requests) ====================

enum AdvanceType {
  BANK_TRANSFER // سلفة تحويل بنكي
  CASH // سلفه نقداً
}

model AdvanceRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeAdvanceRequests", fields: [userId], references: [id])

  // بيانات الطلب
  type             AdvanceType // نوع السلفة
  amount           Decimal     @db.Decimal(10, 2) // المبلغ المطلوب
  startDate        DateTime    @map("start_date") @db.Date // من تاريخ
  endDate          DateTime    @map("end_date") @db.Date // إلى تاريخ
  periodMonths     Int         @map("period_months") // الفترة بالشهور
  monthlyDeduction Decimal     @map("monthly_deduction") @db.Decimal(10, 2) // الاستقطاع الشهري المقترح
  notes            String?     @db.VarChar(500) // ملاحظات
  attachments      Json? // مرفقات (صور/ملفات)

  // الحالة
  status      String       @default("PENDING")
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId String?          @map("manager_approver_id")
  managerApprover   User?            @relation("ManagerApproverAdvanceRequests", fields: [managerApproverId], references: [id])
  managerDecision   ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt DateTime?        @map("manager_decision_at")
  managerNotes      String?          @map("manager_notes") @db.VarChar(500)

  // موافقة HR (مع إمكانية تعديل المبلغ والاستقطاع)
  hrApproverId             String?          @map("hr_approver_id")
  hrApprover               User?            @relation("HRApproverAdvanceRequests", fields: [hrApproverId], references: [id])
  hrDecision               ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt             DateTime?        @map("hr_decision_at")
  hrDecisionNotes          String?          @map("hr_decision_notes") @db.VarChar(500)
  approvedAmount           Decimal?         @map("approved_amount") @db.Decimal(10, 2) // المبلغ المعتمد (قد يختلف عن المطلوب)
  approvedMonthlyDeduction Decimal?         @map("approved_monthly_deduction") @db.Decimal(10, 2) // الاستقطاع المعتمد

  // موافقة المدير المالي (Finance)
  financeApproverId    String?          @map("finance_approver_id")
  financeApprover      User?            @relation("FinanceApproverAdvanceRequests", fields: [financeApproverId], references: [id])
  financeDecision      ApprovalDecision @default(PENDING) @map("finance_decision")
  financeDecisionAt    DateTime?        @map("finance_decision_at")
  financeDecisionNotes String?          @map("finance_decision_notes") @db.VarChar(500)

  // موافقة المدير العام (CEO)
  ceoApproverId    String?          @map("ceo_approver_id")
  ceoApprover      User?            @relation("CEOApproverAdvanceRequests", fields: [ceoApproverId], references: [id])
  ceoDecision      ApprovalDecision @default(PENDING) @map("ceo_decision")
  ceoDecisionAt    DateTime?        @map("ceo_decision_at")
  ceoDecisionNotes String?          @map("ceo_decision_notes") @db.VarChar(500)

  // Flexible approval chain
  approvalChain Json? @map("approval_chain") // ["MANAGER", "HR", "FINANCE", "CEO"]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // سجل المدفوعات
  payments LoanPayment[]

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("advance_requests")
}

// ==================== سداد السلف (Loan Payments) ====================
model LoanPayment {
  id        String         @id @default(uuid())
  advanceId String         @map("advance_id")
  advance   AdvanceRequest @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  // تفاصيل السداد
  amount      Decimal  @db.Decimal(10, 2) // مبلغ السداد
  paymentDate DateTime @map("payment_date") @db.Date
  paymentType String   @default("SALARY_DEDUCTION") @map("payment_type") // SALARY_DEDUCTION, MANUAL, CASH

  // ربط بمسير الرواتب (إن وجد)
  payrollRunId String? @map("payroll_run_id")
  payslipId    String? @map("payslip_id")

  notes       String? @db.VarChar(500)
  createdById String? @map("created_by_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([advanceId])
  @@index([paymentDate])
  @@map("loan_payments")
}

// ==================== موديولات الرواتب الجديدة ====================

model EmployeeBankAccount {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Bank Details
  iban              String // IBAN (will be validated in service)
  accountHolderName String? @map("account_holder_name") // اسم صاحب الحساب (مطلوب لـ WPS)
  bankName          String  @map("bank_name")
  bankCode          String? @map("bank_code") // رمز البنك (مثل SABB, RJHI)
  swiftCode         String? @map("swift_code") // للتحويلات الدولية

  // Status
  isPrimary  Boolean   @default(false) @map("is_primary")
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, iban])
  @@index([userId, isPrimary])
  @@map("employee_bank_accounts")
}

// ==================== حسابات الشركة البنكية ====================

model CompanyBankAccount {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // بيانات البنك
  bankName    String  @map("bank_name")
  bankCode    String  @map("bank_code") // SABB, RJHI, NCB, etc
  iban        String
  accountName String  @map("account_name")
  swiftCode   String? @map("swift_code")

  // الحالة
  isPrimary Boolean @default(false) @map("is_primary")
  isActive  Boolean @default(true) @map("is_active")

  // بيانات WPS/MOL
  molId          String? @map("mol_id") // رقم المنشأة في وزارة العمل
  wpsParticipant String? @map("wps_participant") // رقم المشارك في WPS

  // معلومات إضافية
  accountType String  @default("CURRENT") @map("account_type") // CURRENT, SAVINGS
  currency    String  @default("SAR")
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, iban])
  @@index([companyId, isPrimary])
  @@index([companyId, isActive])
  @@map("company_bank_accounts")
}

model Contract {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contract Details
  contractNumber String?        @unique @map("contract_number")
  type           ContractType   @default(PERMANENT)
  status         ContractStatus @default(DRAFT)

  // Dates
  startDate        DateTime  @map("start_date") @db.Date
  endDate          DateTime? @map("end_date") @db.Date
  probationEndDate DateTime? @map("probation_end_date") @db.Date

  // Termination
  terminatedAt      DateTime? @map("terminated_at")
  terminationReason String?   @map("termination_reason")
  terminatedBy      String?   @map("terminated_by")

  // Renewal
  renewalCount       Int     @default(0) @map("renewal_count")
  previousContractId String? @map("previous_contract_id")

  // Salary Cycle
  salaryCycle String @default("MONTHLY") @map("salary_cycle")

  // ===== حقول الراتب - متطلبات قوى =====
  basicSalary        Decimal? @map("basic_salary") @db.Decimal(10, 2) // الراتب الأساسي
  housingAllowance   Decimal? @map("housing_allowance") @db.Decimal(10, 2) // بدل السكن
  transportAllowance Decimal? @map("transport_allowance") @db.Decimal(10, 2) // بدل المواصلات
  otherAllowances    Decimal? @map("other_allowances") @db.Decimal(10, 2) // بدلات أخرى
  totalSalary        Decimal? @map("total_salary") @db.Decimal(10, 2) // إجمالي الراتب

  // ===== بيانات العمل - متطلبات قوى =====
  contractJobTitle    String? @map("contract_job_title") // المسمى الوظيفي في العقد
  workLocation        String? @map("work_location") // مقر العمل
  workingHoursPerWeek Int     @default(48) @map("working_hours_per_week") // ساعات العمل الأسبوعية
  annualLeaveDays     Int     @default(21) @map("annual_leave_days") // أيام الإجازة السنوية
  noticePeriodDays    Int     @default(30) @map("notice_period_days") // فترة الإشعار

  // ===== التوقيعات الإلكترونية =====
  employeeSignature Boolean   @default(false) @map("employee_signature") // توقيع الموظف
  employeeSignedAt  DateTime? @map("employee_signed_at") // تاريخ توقيع الموظف
  employerSignature Boolean   @default(false) @map("employer_signature") // توقيع صاحب العمل
  employerSignedAt  DateTime? @map("employer_signed_at") // تاريخ توقيع صاحب العمل
  signedByUserId    String?   @map("signed_by_user_id") // من وقع نيابة عن صاحب العمل

  // ===== تكامل قوى =====
  qiwaContractId   String?        @unique @map("qiwa_contract_id") // رقم العقد في قوى
  qiwaStatus       QiwaAuthStatus @default(NOT_SUBMITTED) @map("qiwa_status") // حالة التوثيق
  qiwaAuthDate     DateTime?      @map("qiwa_auth_date") // تاريخ التوثيق في قوى
  qiwaRejectReason String?        @map("qiwa_reject_reason") // سبب الرفض من قوى
  qiwaLastSync     DateTime?      @map("qiwa_last_sync") // آخر مزامنة مع قوى

  // Documents
  documentUrl String? @map("document_url")

  // ===== ملاحظات وبنود إضافية =====
  additionalTerms String? @map("additional_terms") @db.Text // بنود إضافية
  notes           String? @map("notes") @db.Text // ملاحظات داخلية

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([endDate])
  @@index([qiwaStatus])
  @@map("contracts")
}

model CostCenter {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  code        String   @unique
  name        String
  description String?
  users       User[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@map("cost_centers")
}

// ==================== موديولات الرواتب: المكونات والهياكل ====================

enum SalaryComponentType {
  EARNING // استحقاق (بدلات، راتب أساسي)
  DEDUCTION // استقطاع (تأمينات، غرامات)
}

enum SalaryComponentNature {
  FIXED // مبلغ ثابت
  VARIABLE // مبلغ متغير (يدخل يدوياً كل شهر)
  FORMULA // محسوب بناءً على معادلة
}

model SalaryComponent {
  id        String                @id @default(uuid())
  companyId String?               @map("company_id")
  company   Company?              @relation(fields: [companyId], references: [id])
  code      String // مثال: BASIC, HRA, TRANSPORT
  nameAr    String                @map("name_ar")
  nameEn    String?               @map("name_en")
  type      SalaryComponentType
  nature    SalaryComponentNature @default(FIXED)

  description  String?
  gosiEligible Boolean @default(false) @map("gosi_eligible")
  otEligible   Boolean @default(false) @map("ot_eligible")
  eosEligible  Boolean @default(false) @map("eos_eligible") // يدخل في حساب مستحقات نهاية الخدمة
  isProrated   Boolean @default(true) @map("is_prorated") // هل يتأثر بالغياب والتعيين المتأخر (Pro-rated)
  taxable      Boolean @default(false) // خاضع للضريبة

  // لربط المكون باللي يعتمد عليه (مثلاً السكن 25% من الأساسي)
  formula String? // المعادلة (سيتم استخدامها لاحقاً في Rules Engine)

  // Enterprise: Versioning & Effective Dating
  version       Int       @default(1)
  effectiveDate DateTime  @default(now()) @map("effective_date")
  endDate       DateTime? @map("end_date")
  isActive      Boolean   @default(true) @map("is_active")

  // Enterprise: Rounding & Display
  roundingMode String @default("ROUND") @map("rounding_mode") // ROUND, FLOOR, CEIL
  decimals     Int    @default(2)
  priority     Int    @default(100) // ترتيب الظهور في الـ Payslip

  structureLines SalaryStructureLine[]
  PayslipLine    PayslipLine[]
  policyRules    PolicyRule[]          @relation("PolicyOutputComponent")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")

  @@unique([companyId, type, code, version])
  @@index([companyId, isActive])
  @@index([effectiveDate, endDate])
  @@map("salary_components")
}

enum PayrollStatus {
  DRAFT
  INPUTS_COLLECTED
  CALCULATED
  HR_REVIEWED
  FINANCE_APPROVED
  LOCKED
  PAID
  CANCELLED
  ARCHIVED
}

model SalaryStructure {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")

  // Enterprise: Versioning
  version       Int       @default(1)
  effectiveDate DateTime  @default(now()) @map("effective_date")
  endDate       DateTime? @map("end_date")

  // المكونات التابعة لهذا الهيكل
  lines       SalaryStructureLine[]
  assignments EmployeeSalaryAssignment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name, version])
  @@index([companyId, isActive])
  @@index([effectiveDate, endDate])
  @@map("salary_structures")
}

model SalaryStructureLine {
  id          String          @id @default(uuid())
  structureId String          @map("structure_id")
  structure   SalaryStructure @relation(fields: [structureId], references: [id], onDelete: Cascade)

  componentId String          @map("component_id")
  component   SalaryComponent @relation(fields: [componentId], references: [id])

  amount     Decimal  @default(0) @db.Decimal(10, 2)
  percentage Decimal? @db.Decimal(5, 2) // إذا كان مبلغ البدلة نسبة من الأساسي

  priority Int @default(0) // ترتيب الحساب

  @@map("salary_structure_lines")
}

model EmployeeSalaryAssignment {
  id         String @id @default(uuid())
  employeeId String @map("employee_id")
  employee   User   @relation("EmployeeSalaryAssignments", fields: [employeeId], references: [id])

  structureId String          @map("structure_id")
  structure   SalaryStructure @relation(fields: [structureId], references: [id])

  baseSalary    Decimal   @map("base_salary") @db.Decimal(10, 2)
  effectiveDate DateTime  @map("effective_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("employee_salary_assignments")
}

// قشرة قسيمة الراتب (سيتم إضافتها بالكامل في Step 2 لكن نحتاج الموديلات للعلاقات)

// 🔥 مصدر سطر قسيمة الراتب
enum PayslipLineSource {
  STRUCTURE // من هيكل الراتب
  POLICY // من السياسات
  MANUAL // إدخال يدوي
  ADJUSTMENT // تعديل/فرق
  STATUTORY // خصومات قانونية (GOSI, ضرائب)
  SMART // ذكاء اصطناعي (AI)
}

model PayslipLine {
  id          String          @id @default(uuid())
  payslipId   String          @map("payslip_id")
  payslip     Payslip         @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  componentId String          @map("component_id")
  component   SalaryComponent @relation(fields: [componentId], references: [id])

  // 🔥 Extended fields for Policy Engine integration
  sign          String            @default("EARNING") // EARNING | DEDUCTION
  amount        Decimal           @db.Decimal(10, 2)
  sourceType    PayslipLineSource @default(STRUCTURE) @map("source_type")
  sourceRef     String?           @map("source_ref") // policyId:ruleId or "MERGED"
  descriptionAr String?           @map("description_ar") // وصف السطر
  units         Decimal?          @db.Decimal(10, 2) // ساعات OT، دقائق تأخير
  rate          Decimal?          @db.Decimal(10, 4) // معدل الحساب

  createdAt DateTime @default(now()) @map("created_at")

  @@index([payslipId, sourceType])
  @@index([payslipId, componentId])
  @@map("payslip_lines")
}

model PayrollPeriod {
  id        String        @id @default(uuid())
  companyId String?       @map("company_id")
  company   Company?      @relation(fields: [companyId], references: [id])
  month     Int // 1-12
  year      Int
  startDate DateTime      @map("start_date") @db.Date
  endDate   DateTime      @map("end_date") @db.Date
  status    PayrollStatus @default(DRAFT)

  // Enterprise: Cut-off & Lock
  cutOffDate     DateTime? @map("cut_off_date") @db.Date // آخر يوم لتسجيل الحضور
  inputsLockedAt DateTime? @map("inputs_locked_at") // تاريخ تجميد المدخلات
  lockedAt       DateTime? @map("locked_at") // تاريخ القفل النهائي
  lockedBy       String?   @map("locked_by") // من قام بالقفل

  runs               PayrollRun[]
  payslips           Payslip[]
  disciplinaryCases  DisciplinaryCase[]
  payrollAdjustments PayrollAdjustment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, month, year])
  @@index([companyId, status])
  @@map("payroll_periods")
}

model PayrollRun {
  id        String        @id @default(uuid())
  companyId String?       @map("company_id")
  company   Company?      @relation(fields: [companyId], references: [id])
  periodId  String        @map("period_id")
  period    PayrollPeriod @relation(fields: [periodId], references: [id])

  runDate DateTime      @default(now()) @map("run_date")
  status  PayrollStatus @default(DRAFT)

  processedBy String? @map("processed_by")

  // 🔥 Adjustment Run Support
  isAdjustment     Boolean      @default(false) @map("is_adjustment")
  originalRunId    String?      @map("original_run_id")
  originalRun      PayrollRun?  @relation("AdjustmentRuns", fields: [originalRunId], references: [id])
  adjustmentRuns   PayrollRun[] @relation("AdjustmentRuns")
  adjustmentReason String?      @map("adjustment_reason")

  // Enterprise: Workflow Timestamps
  calculatedAt      DateTime? @map("calculated_at")
  calculatedBy      String?   @map("calculated_by")
  hrApprovedAt      DateTime? @map("hr_approved_at")
  hrApprovedBy      String?   @map("hr_approved_by")
  financeApprovedAt DateTime? @map("finance_approved_at")
  financeApprovedBy String?   @map("finance_approved_by")
  lockedAt          DateTime? @map("locked_at")
  lockedBy          String?   @map("locked_by")
  paidAt            DateTime? @map("paid_at")

  payslips         Payslip[]
  mudadSubmissions MudadSubmission[]
  wpsSubmissions   WpsSubmission[]
  ledger           PayrollLedger?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([periodId])
  @@index([originalRunId])
  @@map("payroll_runs")
}

model Payslip {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  company    Company? @relation(fields: [companyId], references: [id])
  employeeId String   @map("employee_id")
  employee   User     @relation(fields: [employeeId], references: [id])

  periodId String        @map("period_id")
  period   PayrollPeriod @relation(fields: [periodId], references: [id])

  runId String?     @map("run_id")
  run   PayrollRun? @relation(fields: [runId], references: [id])

  baseSalary      Decimal @map("base_salary") @db.Decimal(10, 2)
  grossSalary     Decimal @map("gross_salary") @db.Decimal(10, 2)
  totalDeductions Decimal @map("total_deductions") @db.Decimal(10, 2)
  netSalary       Decimal @map("net_salary") @db.Decimal(10, 2)

  status PayrollStatus @default(DRAFT)

  lines            PayslipLine[]
  calculationTrace Json?         @map("calculation_trace")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payslips")
}

model GosiConfig {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  // Version Control
  version       Int       @default(1)
  effectiveDate DateTime  @default(now()) @map("effective_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date

  // Contribution Rates
  employeeRate Decimal @map("employee_rate") @db.Decimal(5, 2) // e.g., 9.00%
  employerRate Decimal @map("employer_rate") @db.Decimal(5, 2) // e.g., 9.00%
  sanedRate    Decimal @map("saned_rate") @db.Decimal(5, 2) // e.g., 0.75%
  hazardRate   Decimal @map("hazard_rate") @db.Decimal(5, 2) // e.g., 2.00%

  // Wage Caps
  maxCapAmount  Decimal @default(45000) @map("max_cap_amount") @db.Decimal(10, 2)
  minBaseSalary Decimal @default(0) @map("min_base_salary") @db.Decimal(10, 2)

  // Settings
  isSaudiOnly       Boolean @default(true) @map("is_saudi_only")
  includeAllowances Boolean @default(false) @map("include_allowances") // هل تشمل البدلات
  isActive          Boolean @default(true) @map("is_active")
  notes             String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, version])
  @@index([companyId, isActive])
  @@index([effectiveDate, endDate])
  @@map("gosi_configs")
}

// ==================== Retro Pay (الفروقات) ====================
enum RetroPayStatus {
  PENDING // في الانتظار
  APPROVED // معتمد
  PAID // مدفوع
  CANCELLED // ملغي
}

model RetroPay {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  company    Company? @relation(fields: [companyId], references: [id])
  employeeId String   @map("employee_id")
  employee   User     @relation(fields: [employeeId], references: [id])

  reason        String // سبب الفرق (زيادة راتب، تصحيح خطأ، إلخ)
  effectiveFrom DateTime @map("effective_from") // تاريخ بداية الفرق
  effectiveTo   DateTime @map("effective_to") // تاريخ نهاية الفرق

  oldAmount  Decimal @map("old_amount") @db.Decimal(10, 2)
  newAmount  Decimal @map("new_amount") @db.Decimal(10, 2)
  difference Decimal @db.Decimal(10, 2) // الفرق = new - old

  monthsCount Int     @map("months_count") // عدد الأشهر المتأثرة
  totalAmount Decimal @map("total_amount") @db.Decimal(10, 2) // الإجمالي = difference * months

  status RetroPayStatus @default(PENDING)
  notes  String?

  createdById  String?   @map("created_by_id")
  approvedById String?   @map("approved_by_id")
  approvedAt   DateTime? @map("approved_at")
  paidAt       DateTime? @map("paid_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("retro_pays")
}

// ==================== Policy Engine ====================
enum PolicyType {
  OVERTIME // سياسة الوقت الإضافي
  LEAVE // سياسة الإجازات
  DEDUCTION // سياسة الاستقطاعات  
  ALLOWANCE // سياسة البدلات
  ATTENDANCE // سياسة الحضور والانصراف
  GENERAL // سياسة عامة
}

enum PolicyScope {
  COMPANY // على مستوى الشركة = rank 1
  BRANCH // على مستوى الفرع = rank 2
  DEPARTMENT // على مستوى القسم = rank 3
  JOB_TITLE // على مستوى الدرجة الوظيفية = rank 4
  EMPLOYEE // على مستوى الموظف = rank 5
}

// نوع الناتج من قاعدة السياسة
enum OutputSign {
  EARNING // إضافة/استحقاق
  DEDUCTION // خصم/استقطاع
}

model Policy {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  code        String
  nameAr      String   @map("name_ar")
  nameEn      String?  @map("name_en")
  description String?

  type  PolicyType
  scope PolicyScope @default(COMPANY)

  // التاريخ الفعال
  effectiveFrom DateTime  @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  // الربط بالنطاق (حسب scope)
  branchId     String? @map("branch_id")
  departmentId String? @map("department_id")
  jobTitleId   String? @map("job_title_id")
  employeeId   String? @map("employee_id")

  // الإعدادات (JSON مرنة)
  settings Json @default("{}")

  isActive  Boolean @default(true) @map("is_active")
  priority  Int     @default(0) // أولوية التطبيق (الأعلى يُطبق أولاً)
  scopeRank Int     @default(1) @map("scope_rank") // COMPANY=1, BRANCH=2, DEPARTMENT=3, JOB_TITLE=4, EMPLOYEE=5

  rules PolicyRule[]

  // Relations for scope targets
  branch         Branch?     @relation(fields: [branchId], references: [id])
  department     Department? @relation(fields: [departmentId], references: [id])
  jobTitle       JobTitle?   @relation(fields: [jobTitleId], references: [id])
  targetEmployee User?       @relation("PolicyTargetEmployee", fields: [employeeId], references: [id])

  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@index([companyId, type, scope, effectiveFrom])
  @@index([type, scope, isActive])
  @@index([effectiveFrom, effectiveTo])
  @@index([branchId])
  @@index([departmentId])
  @@index([jobTitleId])
  @@index([employeeId])
  @@map("policies")
}

model PolicyRule {
  id       String @id @default(uuid())
  policyId String @map("policy_id")
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  code   String // مثال: OT_WEEKDAY, OT_WEEKEND, LATE_PENALTY
  nameAr String @map("name_ar")

  // شروط التطبيق (JSON)
  conditions Json @default("{}")

  // القيمة/النتيجة
  valueType String @map("value_type") // PERCENTAGE, FIXED, FORMULA
  value     String // القيمة أو المعادلة

  // 🔥 مكوّن الناتج - أين تُسجَّل نتيجة هذه القاعدة في قسيمة الراتب
  outputComponentId String?          @map("output_component_id")
  outputComponent   SalaryComponent? @relation("PolicyOutputComponent", fields: [outputComponentId], references: [id])
  outputSign        OutputSign       @default(EARNING) @map("output_sign")

  // ترتيب التطبيق (الأقل→ يُنفذ أولاً)
  ruleOrder Int     @default(0) @map("rule_order")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([policyId, code])
  @@index([policyId, isActive, ruleOrder])
  @@index([outputComponentId])
  @@map("policy_rules")
}

// ==================== السياسات الذكية (AI-Powered Policies) ====================

// نوع الحدث المُفعِّل
enum SmartPolicyTrigger {
  ATTENDANCE // حضور، انصراف، تأخير، غياب
  LEAVE // طلب إجازة، موافقة، رفض
  CUSTODY // تسليم عهدة، إرجاع عهدة
  PAYROLL // حساب الرواتب الشهري
  ANNIVERSARY // ذكرى توظيف
  CONTRACT // بداية/نهاية عقد
  DISCIPLINARY // مخالفة، تحقيق
  PERFORMANCE // أداء
  CUSTOM // أي حدث آخر
}

// حالة السياسة الذكية
enum SmartPolicyStatus {
  DRAFT // مسودة (لم تُراجع بعد)
  PENDING // بانتظار الموافقة
  ACTIVE // مفعّلة
  PAUSED // موقوفة مؤقتاً
  ARCHIVED // مؤرشفة
}

// نوع الإجراء
enum SmartPolicyActionType {
  ADD_TO_PAYROLL // إضافة مبلغ للراتب
  DEDUCT_FROM_PAYROLL // خصم من الراتب
  SEND_NOTIFICATION // إرسال إشعار
  ALERT_HR // تنبيه الموارد البشرية
  CREATE_RECORD // إنشاء سجل
}

model SmartPolicy {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // النص الأصلي (ما كتبه المستخدم بالعربي/العامية)
  originalText String @map("original_text") @db.Text

  // اسم السياسة (اختياري - يُستخرج من الـ AI أو يُدخله المستخدم)
  name        String?
  description String? @db.Text

  // الحدث المُفعِّل
  triggerEvent    SmartPolicyTrigger @map("trigger_event")
  triggerSubEvent String?            @map("trigger_sub_event") // مثال: RETURNED, APPROVED

  // القاعدة المحللة بالذكاء الاصطناعي (JSON كامل)
  parsedRule Json @map("parsed_rule")

  // الشروط المحللة (للبحث السريع)
  conditions Json @default("[]")

  // الإجراءات المحللة
  actions Json @default("[]")

  // النطاق: لمن تُطبق السياسة
  scopeType String  @default("ALL") @map("scope_type") // ALL, EMPLOYEE, DEPARTMENT, BRANCH, JOB_TITLE
  scopeId   String? @map("scope_id") // معرف الهدف (إن وُجد)
  scopeName String? @map("scope_name") // اسم الهدف (للعرض)

  // الحالة والتفعيل
  status   SmartPolicyStatus @default(DRAFT)
  isActive Boolean           @default(false) @map("is_active")

  // الأولوية (الأعلى تُنفذ أولاً)
  priority Int @default(0)

  // تاريخ الصلاحية
  effectiveFrom DateTime? @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  // شرح الـ AI للقاعدة (بالعربي)
  aiExplanation String? @map("ai_explanation") @db.Text

  // هل الـ AI طلب توضيح؟
  clarificationNeeded String? @map("clarification_needed") @db.Text

  // إحصائيات التنفيذ
  executionCount    Int       @default(0) @map("execution_count")
  lastExecutedAt    DateTime? @map("last_executed_at")
  totalAmountPaid   Decimal   @default(0) @map("total_amount_paid") @db.Decimal(12, 2)
  totalAmountDeduct Decimal   @default(0) @map("total_amount_deduct") @db.Decimal(12, 2)

  // من أنشأها وراجعها
  createdById  String?   @map("created_by_id")
  approvedById String?   @map("approved_by_id")
  approvedAt   DateTime? @map("approved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // سجل التنفيذات
  executions SmartPolicyExecution[]

  @@index([companyId, status, isActive])
  @@index([companyId, triggerEvent])
  @@index([status, isActive])
  @@map("smart_policies")
}

// سجل تنفيذ السياسة الذكية
model SmartPolicyExecution {
  id       String      @id @default(uuid())
  policyId String      @map("policy_id")
  policy   SmartPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // الموظف المتأثر
  employeeId   String @map("employee_id")
  employeeName String @map("employee_name")

  // الحدث الذي أطلق التنفيذ
  triggerEvent    String  @map("trigger_event")
  triggerSubEvent String? @map("trigger_sub_event")
  triggerData     Json?   @map("trigger_data") // بيانات الحدث (مثل: تاريخ إرجاع العهدة)

  // نتيجة فحص الشروط
  conditionsMet Boolean @map("conditions_met")
  conditionsLog Json?   @map("conditions_log") // تفاصيل فحص كل شرط

  // الإجراء المُنفذ
  actionType   String?  @map("action_type") // ADD_TO_PAYROLL, DEDUCT_FROM_PAYROLL, etc.
  actionValue  Decimal? @map("action_value") @db.Decimal(10, 2)
  actionResult Json?    @map("action_result") // نتيجة الإجراء

  // هل نجح التنفيذ؟
  isSuccess    Boolean @map("is_success")
  errorMessage String? @map("error_message") @db.Text

  // ربط بالراتب (إن وُجد)
  payrollPeriod String? @map("payroll_period") // YYYY-MM

  executedAt DateTime @default(now()) @map("executed_at")

  @@index([policyId, executedAt])
  @@index([employeeId, executedAt])
  @@index([triggerEvent])
  @@map("smart_policy_executions")
}

// ==================== Government Compliance Tracking ====================

// مُدد - Mudad Salary Protection Submissions
model MudadSubmission {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Reference to payroll run
  payrollRunId String     @map("payroll_run_id")
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id])

  // Submission Details
  period         String // YYYY-MM format
  submissionType String @default("SALARY") @map("submission_type") // SALARY, BONUS, EOS

  // Status Tracking
  status     MudadStatus @default(PENDING)
  wpsFileUrl String?     @map("wps_file_url") // رابط ملف WPS المرفوع
  mudadRef   String?     @map("mudad_ref") // رقم مرجع مُدد (من المنصة)

  // Amounts
  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  employeeCount Int     @map("employee_count")

  // Submission Workflow
  preparedAt    DateTime? @map("prepared_at")
  preparedBy    String?   @map("prepared_by")
  submittedAt   DateTime? @map("submitted_at")
  submittedBy   String?   @map("submitted_by")
  acceptedAt    DateTime? @map("accepted_at")
  rejectedAt    DateTime? @map("rejected_at")
  rejectionNote String?   @map("rejection_note")

  // File Integrity (للتدقيق)
  fileHashSha256   String? @map("file_hash_sha256") @db.VarChar(64)
  fileSize         Int?    @map("file_size")
  generatorVersion String? @map("generator_version")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([payrollRunId, submissionType])
  @@index([companyId, period])
  @@index([status])
  @@map("mudad_submissions")
}

enum MudadStatus {
  PENDING // في انتظار التحضير
  PREPARED // تم تحضير الملف
  SUBMITTED // تم الرفع على مُدد
  ACCEPTED // مقبول
  REJECTED // مرفوض
  RESUBMITTED // تم إعادة الرفع
  RESUBMIT_REQUIRED // يتطلب إعادة رفع (تغير الملف)
}

// WPS File Submissions (تتبع ملفات WPS المرفوعة)
model WpsSubmission {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Reference
  payrollRunId String     @map("payroll_run_id")
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id])

  // File Details
  filename   String
  fileFormat String  @default("WPS") @map("file_format") // WPS, SARIE
  fileUrl    String? @map("file_url")

  // Amounts
  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  employeeCount Int     @map("employee_count")

  // Status
  status   WpsStatus @default(GENERATED)
  bankName String?   @map("bank_name") // البنك المستلم
  bankRef  String?   @map("bank_ref") // رقم مرجع البنك

  // Workflow
  generatedAt  DateTime  @default(now()) @map("generated_at")
  generatedBy  String?   @map("generated_by")
  downloadedAt DateTime? @map("downloaded_at")
  downloadedBy String?   @map("downloaded_by")
  submittedAt  DateTime? @map("submitted_at") // تم الرفع للبنك
  submittedBy  String?   @map("submitted_by") // من قام بالرفع
  processedAt  DateTime? @map("processed_at") // تم التحويل

  // Attachments (receipts from bank)
  attachmentUrl String? @map("attachment_url") // إيصال البنك أو مستند التأكيد

  // File Integrity (للتدقيق)
  fileHashSha256   String? @map("file_hash_sha256") @db.VarChar(64)
  generatorVersion String? @map("generator_version")

  // Notes & Errors
  notes  String? @db.Text
  errors Json? // أخطاء التحقق

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([payrollRunId])
  @@map("wps_submissions")
}

enum WpsStatus {
  GENERATED // تم إنشاء الملف
  DOWNLOADED // تم تحميل الملف
  SUBMITTED // تم الرفع للبنك
  PROCESSING // قيد المعالجة
  PROCESSED // تم التحويل
  FAILED // فشل
}

// ==================== Module enum for Audit ====================
enum AuditModule {
  AUTH // تسجيل الدخول
  USER // إدارة الموظفين
  PAYROLL // الرواتب
  PAYSLIP // قسائم الرواتب
  BANK_ACCOUNT // الحسابات البنكية
  SALARY // هياكل الرواتب
  LEAVE // الإجازات
  ATTENDANCE // الحضور والانصراف
  ADVANCE // السلف
  GOSI // التأمينات
  EOS // نهاية الخدمة
  PERMISSION // الصلاحيات
  POLICY // السياسات
  RETRO_PAY // الفروقات
  LETTER // الخطابات
  SETTINGS // الإعدادات
  MUDAD // مُدد
  WPS // حماية الأجور
  CONTRACT // العقود
  DISCIPLINARY // الجزاءات
}

// ==================== موديول الجزاءات والتحقيقات ====================

enum DisciplinaryStage {
  MANAGER_REQUEST
  HR_INITIAL_REVIEW
  EMPLOYEE_INFORMAL_RESPONSE
  OFFICIAL_INVESTIGATION
  DECISION
  OBJECTION
  FINAL
}

enum DisciplinaryStatus {
  SUBMITTED_TO_HR
  HR_REJECTED
  HR_INFORMAL_SENT
  AWAITING_EMPLOYEE_INFORMAL
  EMPLOYEE_REJECTED_INFORMAL
  OFFICIAL_INVESTIGATION_OPENED
  HEARING_SCHEDULED
  INVESTIGATION_IN_PROGRESS
  AWAITING_HR_DECISION
  DECISION_ISSUED
  AWAITING_EMPLOYEE_ACK
  EMPLOYEE_OBJECTED
  HR_REVIEWING_OBJECTION
  FINALIZED_APPROVED
  FINALIZED_CANCELLED
  FINALIZED_CONTINUE_INVESTIGATION
}

enum DecisionType {
  NO_VIOLATION
  NOTICE
  WARNING
  FIRST_WARNING
  SECOND_WARNING
  FINAL_WARNING_TERMINATION
  FINAL_TERMINATION_ART80
  PROMOTION_DELAY
  SALARY_DEDUCTION
  SUSPENSION_WITH_PAY
  SUSPENSION_WITHOUT_PAY
}

enum PayrollAdjustmentStatus {
  PENDING
  POSTED
  REVERSED
  CANCELLED
}

enum AdjustmentUnit {
  DAYS
  HOURS
  AMOUNT
}

enum CaseEventType {
  CASE_CREATED
  HR_INITIAL_REVIEW
  INFORMAL_ACTION_SENT
  EMPLOYEE_INFORMAL_RESPONSE
  OFFICIAL_INVESTIGATION_OPENED
  HEARING_SCHEDULED
  MINUTES_UPLOADED
  DECISION_ISSUED
  EMPLOYEE_ACKNOWLEDGED
  EMPLOYEE_OBJECTED
  OBJECTION_REVIEWED
  FINALIZED
  CANCELLED
}

enum DeductionBasePolicy {
  BASIC_ONLY
  BASIC_FIXED
  GROSS
}

model CompanyDisciplinaryPolicy {
  id        String  @id @default(uuid())
  companyId String  @unique @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  incidentMaxAgeDays           Int                 @default(30) @map("incident_max_age_days")
  decisionDeadlineDays         Int                 @default(30) @map("decision_deadline_days")
  objectionWindowDays          Int                 @default(15) @map("objection_window_days")
  allowRetrospectiveIncidents  Boolean             @default(false) @map("allow_retrospective_incidents")
  autoApplyToOpenPayrollPeriod Boolean             @default(true) @map("auto_apply_to_open_payroll_period")
  deductionBasePolicy          DeductionBasePolicy @default(BASIC_FIXED) @map("deduction_base_policy")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("company_disciplinary_policies")
}

model DisciplinaryCase {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])
  caseCode  String  @map("case_code") // e.g., INV-2025-001

  employeeId String @map("employee_id")
  employee   User   @relation("EmployeeDisciplinaryCases", fields: [employeeId], references: [id])

  managerId String @map("manager_id")
  manager   User   @relation("ManagerCreatedCases", fields: [managerId], references: [id])

  title            String
  violationType    String?  @map("violation_type") // نوع المخالفة
  incidentDate     DateTime @map("incident_date")
  incidentLocation String   @map("incident_location")
  involvedParties  Json?    @map("involved_parties")
  description      String   @db.Text

  status DisciplinaryStatus @default(SUBMITTED_TO_HR)
  stage  DisciplinaryStage  @default(MANAGER_REQUEST)

  // Policy Snapshots
  incidentMaxAgeDaysSnapshot   Int                 @map("incident_max_age_days_snapshot")
  decisionDeadlineDaysSnapshot Int                 @map("decision_deadline_days_snapshot")
  objectionWindowDaysSnapshot  Int                 @map("objection_window_days_snapshot")
  allowRetrospectiveSnapshot   Boolean             @map("allow_retrospective_snapshot")
  deductionBasePolicySnapshot  DeductionBasePolicy @map("deduction_base_policy_snapshot")

  // Retrospective metadata
  isRetrospective     Boolean @default(false) @map("is_retrospective")
  retrospectiveReason String? @map("retrospective_reason") @db.Text

  // HR Review
  hrInitialAction String? @map("hr_initial_action")
  hrInitialReason String? @map("hr_initial_reason") @db.Text

  // Official Investigation
  officialInvestigationOpenedAt DateTime? @map("official_investigation_opened_at")
  hearingDatetime               DateTime? @map("hearing_datetime")
  hearingLocation               String?   @map("hearing_location")

  // Decision
  decisionType      DecisionType? @map("decision_type")
  decisionReason    String?       @map("decision_reason") @db.Text
  decisionCreatedAt DateTime?     @map("decision_created_at")

  // Penalty metadata (for SalDeduction or Suspension)
  penaltyUnit          AdjustmentUnit? @map("penalty_unit")
  penaltyValue         Decimal?        @map("penalty_value") @db.Decimal(10, 2)
  penaltyEffectiveDate DateTime?       @map("penalty_effective_date") @db.Date

  // Payroll Integration
  payrollPeriodId String?        @map("payroll_period_id")
  payrollPeriod   PayrollPeriod? @relation(fields: [payrollPeriodId], references: [id])

  // Employee Response
  employeeAckStatus String?   @map("employee_ack_status") // ACCEPTED, REJECTED
  employeeAckAt     DateTime? @map("employee_ack_at")

  // Objection
  objectionText        String?   @map("objection_text") @db.Text
  objectionSubmittedAt DateTime? @map("objection_submitted_at")

  // HR Post-Objection
  hrAfterObjectionAction String? @map("hr_after_objection_action")
  hrAfterObjectionReason String? @map("hr_after_objection_reason") @db.Text

  finalizedAt DateTime? @map("finalized_at")
  legalHold   Boolean   @default(false) @map("legal_hold")

  // Relationships
  events      CaseEvent[]
  attachments CaseAttachment[]
  minutes     CaseMinute[]
  records     EmployeeDisciplinaryRecord[]
  adjustments PayrollAdjustment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, caseCode])
  @@index([companyId, status])
  @@index([employeeId])
  @@index([companyId, employeeId])
  @@map("disciplinary_cases")
}

model CaseEvent {
  id     String           @id @default(uuid())
  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  actorUserId String?       @map("actor_user_id")
  eventType   CaseEventType @map("event_type")
  message     String?       @db.Text
  metadata    Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([caseId, createdAt])
  @@map("case_events")
}

model CaseAttachment {
  id     String           @id @default(uuid())
  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  uploaderUserId String @map("uploader_user_id")
  fileUrl        String @map("file_url")
  fileName       String @map("file_name")
  fileType       String @map("file_type")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("case_attachments")
}

model CaseMinute {
  id     String           @id @default(uuid())
  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  sessionNo      Int     @map("session_no")
  minutesText    String? @map("minutes_text") @db.Text
  minutesFileUrl String? @map("minutes_file_url")

  createdByHrId String   @map("created_by_hr_id")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("case_minutes")
}

model EmployeeDisciplinaryRecord {
  id         String @id @default(uuid())
  employeeId String @map("employee_id")
  employee   User   @relation(fields: [employeeId], references: [id])

  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  decisionType    DecisionType @map("decision_type")
  reason          String?      @db.Text
  effectiveDate   DateTime     @map("effective_date")
  penaltyMetadata Json?        @map("penalty_metadata")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("employee_disciplinary_records")
}

model PayrollAdjustment {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  employeeId String @map("employee_id")
  employee   User   @relation(fields: [employeeId], references: [id])

  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  payrollPeriodId String        @map("payroll_period_id")
  payrollPeriod   PayrollPeriod @relation(fields: [payrollPeriodId], references: [id])

  adjustmentType String                  @map("adjustment_type") // DEDUCTION, SUSPENSION_UNPAID
  unit           AdjustmentUnit
  value          Decimal                 @db.Decimal(10, 2)
  amount         Decimal?                @db.Decimal(10, 2) // Optional computed amount
  status         PayrollAdjustmentStatus @default(PENDING)
  description    String?
  effectiveDate  DateTime?               @map("effective_date") @db.Date

  postedAt   DateTime? @map("posted_at")
  reversedAt DateTime? @map("reversed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@unique([companyId, caseId]) // One adjustment per case
  @@index([companyId, employeeId, payrollPeriodId, status])
  @@index([employeeId, payrollPeriodId])
  @@index([payrollPeriodId, status])
  @@map("payroll_adjustments")
}

// ==================== Compliance: Status Change Audit Trail ====================

enum SubmissionEntityType {
  MUDAD
  WPS
  QIWA
}

// سجل تغيير الحالة (Audit Trail) - لكل تغيير status
model SubmissionStatusLog {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Reference to entity
  entityType SubmissionEntityType @map("entity_type")
  entityId   String               @map("entity_id")

  // Status change
  fromStatus String? @map("from_status") // null for initial creation
  toStatus   String  @map("to_status")

  // Actor
  changedByUserId String   @map("changed_by_user_id")
  changedAt       DateTime @default(now()) @map("changed_at")

  // Context
  reason      String? // سبب التغيير (اختياري)
  externalRef String? @map("external_ref") // مرجع خارجي إن وجد
  meta        Json? // بيانات إضافية

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId, entityType, entityId])
  @@index([changedAt])
  @@map("submission_status_logs")
}

// ==================== إعدادات سلاسل الموافقات ====================

enum ApprovalRequestType {
  LEAVE
  ADVANCE
  RAISE
  PAYROLL
  WPS
}

model ApprovalChainConfig {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // نوع الطلب
  requestType ApprovalRequestType @map("request_type")

  // شروط التطبيق (Threshold)
  minAmount Decimal? @map("min_amount") @db.Decimal(12, 2) // الحد الأدنى للمبلغ
  maxAmount Decimal? @map("max_amount") @db.Decimal(12, 2) // الحد الأقصى للمبلغ
  minDays   Int?     @map("min_days") // الحد الأدنى للأيام (للإجازات)
  maxDays   Int?     @map("max_days") // الحد الأقصى للأيام

  // سلسلة الموافقات (مرتبة)
  chain Json // ["MANAGER", "HR", "FINANCE", "CEO"]

  // الإعدادات
  name        String  @db.VarChar(100) // اسم السلسلة
  description String? @db.VarChar(500)
  priority    Int     @default(0) // الأولوية (الأعلى أولاً)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, requestType, isActive])
  @@map("approval_chain_configs")
}

// ==================== سيستم العهد (Custody Management System) ====================

// ==================== فئات العهد ====================
model CustodyCategory {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  name        String // اسم الفئة
  nameEn      String? @map("name_en")
  description String? // الوصف
  icon        String? // أيقونة للعرض

  // إعدادات الفئة
  requiresApproval     Boolean @default(true) @map("requires_approval")
  requiresSerialNumber Boolean @default(true) @map("requires_serial_number")
  depreciationYears    Int?    @map("depreciation_years") // سنوات الإهلاك

  isActive Boolean @default(true) @map("is_active")

  items CustodyItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name])
  @@map("custody_categories")
}

// ==================== حالات العهدة ====================
enum CustodyItemStatus {
  AVAILABLE // متاحة للتسليم
  ASSIGNED // مسلمة لموظف
  IN_MAINTENANCE // في الصيانة
  LOST // مفقودة
  DAMAGED // تالفة
  DISPOSED // مستبعدة
  RESERVED // محجوزة
}

// ==================== حالة العهدة ====================
enum CustodyCondition {
  NEW // جديدة
  EXCELLENT // ممتازة
  GOOD // جيدة
  FAIR // مقبولة
  POOR // سيئة
}

// ==================== العهدة/الأصل ====================
model CustodyItem {
  id         String          @id @default(uuid())
  companyId  String          @map("company_id")
  company    Company         @relation(fields: [companyId], references: [id])
  categoryId String          @map("category_id")
  category   CustodyCategory @relation(fields: [categoryId], references: [id])

  // بيانات العهدة الأساسية
  code        String // كود العهدة (فريد داخل الشركة)
  name        String // اسم العهدة
  nameEn      String? @map("name_en")
  description String?

  // بيانات التعريف
  serialNumber String? @map("serial_number")
  model        String? // الموديل
  brand        String? // العلامة التجارية
  barcode      String? // باركود
  qrCode       String? @map("qr_code") // QR Code URL

  // بيانات الشراء
  purchaseDate   DateTime? @map("purchase_date")
  purchasePrice  Decimal?  @map("purchase_price") @db.Decimal(12, 2)
  warrantyExpiry DateTime? @map("warranty_expiry")
  vendor         String? // المورد
  invoiceNumber  String?   @map("invoice_number")

  // الحالة والموقع
  status          CustodyItemStatus @default(AVAILABLE)
  condition       CustodyCondition  @default(NEW)
  currentLocation String?           @map("current_location") // الموقع الحالي
  notes           String?

  // صورة العهدة
  imageUrl    String? @map("image_url")
  attachments Json?   @default("[]") // مرفقات إضافية

  // تتبع الفرع
  branchId String? @map("branch_id")
  branch   Branch? @relation(fields: [branchId], references: [id])

  // الموظف الحالي (للتتبع السريع)
  currentAssigneeId String? @map("current_assignee_id")

  // العلاقات
  assignments  CustodyAssignment[]
  returns      CustodyReturn[]
  transfers    CustodyTransfer[]
  maintenances CustodyMaintenance[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@index([companyId, status])
  @@index([categoryId])
  @@index([currentAssigneeId])
  @@map("custody_items")
}

// ==================== حالات التسليم ====================
enum CustodyAssignmentStatus {
  PENDING // في انتظار الموافقة
  APPROVED // تمت الموافقة
  REJECTED // مرفوض
  DELIVERED // تم التسليم
  RETURNED // تم الإرجاع
  TRANSFERRED // تم التحويل
}

// ==================== تسليم العهدة ====================
model CustodyAssignment {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة والموظف
  custodyItemId String      @map("custody_item_id")
  custodyItem   CustodyItem @relation(fields: [custodyItemId], references: [id])
  employeeId    String      @map("employee_id")
  employee      User        @relation("EmployeeCustody", fields: [employeeId], references: [id])

  // تواريخ التسليم
  assignedAt     DateTime  @default(now()) @map("assigned_at")
  expectedReturn DateTime? @map("expected_return") // تاريخ الإرجاع المتوقع
  actualReturn   DateTime? @map("actual_return") // تاريخ الإرجاع الفعلي

  // الحالة
  status            CustodyAssignmentStatus @default(PENDING)
  conditionOnAssign CustodyCondition?       @map("condition_on_assign")
  conditionOnReturn CustodyCondition?       @map("condition_on_return")

  // الموافقات
  assignedById String    @map("assigned_by_id") // من قام بالتسليم
  assignedBy   User      @relation("CustodyAssigner", fields: [assignedById], references: [id])
  approvedById String?   @map("approved_by_id") // من وافق
  approvedBy   User?     @relation("CustodyApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime? @map("approved_at")

  // ملاحظات وتوقيع
  notes             String?
  employeeSignature String?   @map("employee_signature") // توقيع الموظف (Base64)
  signatureDate     DateTime? @map("signature_date")

  // مرفقات (صور التسليم/استلام)
  attachments Json? @default("[]")

  // Audit
  approvalChain Json? @map("approval_chain")

  // إرجاع مرتبط
  returns CustodyReturn[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([employeeId])
  @@index([custodyItemId])
  @@map("custody_assignments")
}

// ==================== حالات الإرجاع ====================
enum CustodyReturnStatus {
  PENDING // في انتظار المراجعة
  INSPECTING // جاري الفحص
  APPROVED // تمت الموافقة
  REJECTED // مرفوض (الموظف يحتفظ بالعهدة)
  COMPLETED // تم الإرجاع بنجاح
}

// ==================== إرجاع العهدة ====================
model CustodyReturn {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة
  custodyItemId String            @map("custody_item_id")
  custodyItem   CustodyItem       @relation(fields: [custodyItemId], references: [id])
  assignmentId  String            @map("assignment_id") // التسليم المرتبط
  assignment    CustodyAssignment @relation(fields: [assignmentId], references: [id])

  // الموظف المرجع
  returnedById String @map("returned_by_id")
  returnedBy   User   @relation("CustodyReturner", fields: [returnedById], references: [id])

  // تفاصيل الإرجاع
  returnDate        DateTime         @default(now()) @map("return_date")
  returnReason      String?          @map("return_reason") // سبب الإرجاع
  conditionOnReturn CustodyCondition @map("condition_on_return")

  // الحالة والمراجعة
  status       CustodyReturnStatus @default(PENDING)
  reviewedById String?             @map("reviewed_by_id")
  reviewedBy   User?               @relation("CustodyReturnReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?           @map("reviewed_at")
  reviewNotes  String?             @map("review_notes")

  // في حالة التلف - ربط مع الرواتب
  damageDescription  String?  @map("damage_description")
  estimatedCost      Decimal? @map("estimated_cost") @db.Decimal(12, 2) // تكلفة الإصلاح/التعويض
  chargeEmployee     Boolean  @default(false) @map("charge_employee") // خصم من الراتب؟
  chargedToPayroll   Boolean  @default(false) @map("charged_to_payroll") // تم الخصم؟
  payrollDeductionId String?  @map("payroll_deduction_id") // رقم خصم الراتب

  // مرفقات (صور الحالة)
  attachments Json? @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("custody_returns")
}

// ==================== حالات التحويل ====================
enum CustodyTransferStatus {
  PENDING // في انتظار موافقة الموظف الجديد
  APPROVED // وافق الموظف الجديد
  REJECTED // رفض التحويل
  COMPLETED // تم التحويل
}

// ==================== تحويل العهدة ====================
model CustodyTransfer {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة
  custodyItemId String      @map("custody_item_id")
  custodyItem   CustodyItem @relation(fields: [custodyItemId], references: [id])

  // من/إلى
  fromEmployeeId String @map("from_employee_id")
  fromEmployee   User   @relation("CustodyTransferFrom", fields: [fromEmployeeId], references: [id])
  toEmployeeId   String @map("to_employee_id")
  toEmployee     User   @relation("CustodyTransferTo", fields: [toEmployeeId], references: [id])

  // التفاصيل
  transferDate DateTime              @default(now()) @map("transfer_date")
  reason       String? // سبب التحويل
  status       CustodyTransferStatus @default(PENDING)

  // الموافقات
  initiatedById String    @map("initiated_by_id") // من بدأ الطلب
  initiatedBy   User      @relation("CustodyTransferInitiator", fields: [initiatedById], references: [id])
  approvedById  String?   @map("approved_by_id")
  approvedBy    User?     @relation("CustodyTransferApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime? @map("approved_at")

  // توقيعات
  fromSignature String? @map("from_signature")
  toSignature   String? @map("to_signature")

  notes       String?
  attachments Json?   @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("custody_transfers")
}

// ==================== حالات الصيانة ====================
enum CustodyMaintenanceStatus {
  PENDING // في انتظار الصيانة
  IN_PROGRESS // جاري الصيانة
  COMPLETED // تمت الصيانة
  CANNOT_REPAIR // لا يمكن إصلاحها
}

enum MaintenanceType {
  PREVENTIVE // صيانة وقائية
  CORRECTIVE // صيانة علاجية
  EMERGENCY // صيانة طارئة
}

// ==================== صيانة العهدة ====================
model CustodyMaintenance {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة
  custodyItemId String      @map("custody_item_id")
  custodyItem   CustodyItem @relation(fields: [custodyItemId], references: [id])

  // نوع الصيانة
  type        MaintenanceType
  description String // وصف المشكلة

  // التواريخ
  reportedAt   DateTime  @default(now()) @map("reported_at")
  reportedById String    @map("reported_by_id")
  reportedBy   User      @relation("MaintenanceReporter", fields: [reportedById], references: [id])
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")

  // الحالة
  status CustodyMaintenanceStatus @default(PENDING)

  // التكاليف
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(12, 2)
  actualCost    Decimal? @map("actual_cost") @db.Decimal(12, 2)

  // مزود الصيانة الخارجي
  vendor        String? // مزود الصيانة
  vendorContact String? @map("vendor_contact") // رقم التواصل
  vendorEmail   String? @map("vendor_email")
  invoiceNumber String? @map("invoice_number")

  // النتيجة
  result         String? // نتيجة الصيانة
  conditionAfter CustodyCondition? @map("condition_after")

  // مرفقات
  attachments Json? @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("custody_maintenances")
}

// ==================== وثائق الموظفين ====================
enum DocumentType {
  ID_CARD // بطاقة الهوية
  IQAMA // الإقامة
  PASSPORT // جواز السفر
  CONTRACT // العقد
  CERTIFICATE // شهادة
  MEDICAL // تقرير طبي
  BANK_LETTER // خطاب بنكي
  DRIVING_LICENSE // رخصة قيادة
  QUALIFICATION // مؤهل علمي
  OTHER // أخرى
}

model EmployeeDocument {
  id        String @id @default(uuid())
  companyId String @map("company_id")
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        DocumentType
  title       String // عنوان المستند
  titleAr     String?      @map("title_ar") // العنوان بالعربي
  description String? // وصف المستند

  // بيانات الملف
  filePath      String  @map("file_path")
  fileType      String  @map("file_type") // pdf, jpg, png
  fileSize      Int     @map("file_size") // بالبايت
  originalName  String? @map("original_name") // اسم الملف الأصلي
  thumbnailPath String? @map("thumbnail_path") // مسار الصورة المصغرة للصور

  // معلومات إضافية
  documentNumber   String?   @map("document_number") // رقم المستند
  issueDate        DateTime? @map("issue_date") @db.Date // تاريخ الإصدار
  expiryDate       DateTime? @map("expiry_date") @db.Date // تاريخ الانتهاء
  issuingAuthority String?   @map("issuing_authority") // جهة الإصدار

  // التحقق
  isVerified   Boolean   @default(false) @map("is_verified")
  verifiedById String?   @map("verified_by_id")
  verifiedAt   DateTime? @map("verified_at")

  // من قام بالرفع
  uploadedById String  @map("uploaded_by_id")
  notes        String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([companyId, type])
  @@index([expiryDate])
  @@map("employee_documents")
}

model PayrollLedger {
  id        String     @id @default(uuid())
  runId     String     @unique @map("run_id")
  run       PayrollRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  companyId String     @map("company_id")

  totalGross     Decimal @default(0) @map("total_gross") @db.Decimal(12, 2)
  totalDeduction Decimal @default(0) @map("total_deduction") @db.Decimal(12, 2)
  totalNet       Decimal @default(0) @map("total_net") @db.Decimal(12, 2)

  // Employer Cost (Taxes, GOSI, Benefits)
  totalEmployerContribution Decimal @default(0) @map("total_employer_contribution") @db.Decimal(12, 2)

  status String @default("DRAFT") // DRAFT, POSTED, REVERSED

  entries JournalEntry[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payroll_ledgers")
}

model JournalEntry {
  id       String        @id @default(uuid())
  ledgerId String        @map("ledger_id")
  ledger   PayrollLedger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)

  accountCode String @map("account_code") // e.g., 5101 (Basic Salary Account)
  accountName String @map("account_name")

  debit  Decimal @default(0) @db.Decimal(12, 2)
  credit Decimal @default(0) @db.Decimal(12, 2)

  description String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("payroll_journal_entries")
}

// ==================== نظام تتبع الموقع (Location Tracking System) ====================

// سجل تحديثات موقع الموظف
model EmployeeLocationLog {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  latitude  Decimal @db.Decimal(10, 8)
  longitude Decimal @db.Decimal(11, 8)
  accuracy  Float? // دقة GPS بالمتر

  // حالة الموقع
  isInsideGeofence   Boolean @default(true) @map("is_inside_geofence")
  distanceFromBranch Int?    @map("distance_from_branch") // بالمتر

  // معلومات إضافية
  batteryLevel Float?  @map("battery_level")
  deviceInfo   String? @map("device_info")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([companyId, createdAt])
  @@index([userId, isInsideGeofence])
  @@map("employee_location_logs")
}

// أحداث الخروج من نطاق الشركة
model GeofenceExitEvent {
  id           String     @id @default(uuid())
  companyId    String?    @map("company_id")
  company      Company?   @relation(fields: [companyId], references: [id])
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id])
  attendanceId String     @map("attendance_id")
  attendance   Attendance @relation(fields: [attendanceId], references: [id])

  // موقع الخروج
  exitLatitude       Decimal @map("exit_latitude") @db.Decimal(10, 8)
  exitLongitude      Decimal @map("exit_longitude") @db.Decimal(11, 8)
  distanceFromBranch Int     @map("distance_from_branch")

  // وقت الخروج والعودة
  exitTime   DateTime  @map("exit_time")
  returnTime DateTime? @map("return_time")

  // موقع العودة (اختياري)
  returnLatitude  Decimal? @map("return_latitude") @db.Decimal(10, 8)
  returnLongitude Decimal? @map("return_longitude") @db.Decimal(11, 8)

  // مدة الخروج بالدقائق
  durationMinutes Int? @map("duration_minutes")

  // هل تم إرسال إشعار؟
  notificationSent Boolean @default(false) @map("notification_sent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, exitTime])
  @@index([attendanceId])
  @@index([companyId, exitTime])
  @@map("geofence_exit_events")
}

// ==================== نظام ترحيب الموظفين (Employee Onboarding System) ====================

// نوع عملية الترحيب
enum OnboardingType {
  JOINING // انضمام موظف جديد
  OFFBOARDING // إنهاء خدمة
  RETURN // عودة من إجازة طويلة
}

// نوع المسؤول عن المهمة
enum AssigneeType {
  HR
  IT
  MANAGER
  FINANCE
  EMPLOYEE
}

// حالة العملية
enum OnboardingProcessStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// أولوية المهمة
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// حالة المهمة العامة
enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

// حالة المهمة
enum OnboardingTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// قوالب سير العمل للترحيب
model OnboardingTemplate {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  name        String
  nameEn      String?        @map("name_en")
  description String?
  type        OnboardingType @default(JOINING)
  isActive    Boolean        @default(true)

  tasks     OnboardingTemplateTask[]
  processes OnboardingProcess[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, type])
  @@map("onboarding_templates")
}

// مهام القالب
model OnboardingTemplateTask {
  id         String             @id @default(uuid())
  templateId String             @map("template_id")
  template   OnboardingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  title       String
  titleEn     String? @map("title_en")
  description String?

  assigneeType  AssigneeType @default(HR)
  dueDays       Int          @default(1) // عدد الأيام من تاريخ البدء
  priority      Int          @default(1) // ترتيب الأولوية
  requiresPhoto Boolean      @default(false) @map("requires_photo")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([templateId])
  @@map("onboarding_template_tasks")
}

// عملية الترحيب الفعلية للموظف
model OnboardingProcess {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  templateId String             @map("template_id")
  template   OnboardingTemplate @relation(fields: [templateId], references: [id])

  type        OnboardingType
  status      OnboardingProcessStatus @default(IN_PROGRESS)
  startDate   DateTime                @default(now()) @map("start_date")
  completedAt DateTime?               @map("completed_at")

  tasks OnboardingTask[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([userId])
  @@map("onboarding_processes")
}

// المهام الفعلية للموظف
model OnboardingTask {
  id        String            @id @default(uuid())
  processId String            @map("process_id")
  process   OnboardingProcess @relation(fields: [processId], references: [id], onDelete: Cascade)

  title       String
  titleEn     String? @map("title_en")
  description String?

  assigneeId   String?      @map("assignee_id")
  assigneeType AssigneeType

  status      OnboardingTaskStatus @default(PENDING)
  dueDate     DateTime             @map("due_date")
  completedAt DateTime?            @map("completed_at")
  completedBy String?              @map("completed_by")

  // توثيق بالصورة
  photoUrl String? @map("photo_url")
  notes    String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([processId, status])
  @@map("onboarding_tasks")
}

// ==================== AI Predictive Absence Analytics ====================

// مستوى المخاطر
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// نموذج التنبؤ بالغياب
model AbsencePrediction {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // تاريخ التنبؤ
  predictionDate DateTime @map("prediction_date") @db.Date

  // احتمالية الغياب (0-100)
  absenceLikelihood Decimal @map("absence_likelihood") @db.Decimal(5, 2)

  // مستوى المخاطر
  riskLevel RiskLevel @map("risk_level")

  // العوامل المساهمة (JSON)
  contributingFactors Json @map("contributing_factors")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, predictionDate])
  @@index([userId, predictionDate])
  @@index([riskLevel])
  @@map("absence_predictions")
}

// ========== دقة النموذج (Model Accuracy Tracking) ==========

model PredictionAccuracy {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // إصدار النموذج
  modelVersion String @map("model_version")

  // مقاييس الأداء
  accuracy  Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  precision Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  recall    Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  f1Score   Decimal @map("f1_score") @db.Decimal(5, 4) // 0.0000 - 1.0000

  // تاريخ التقييم
  evaluatedAt DateTime @map("evaluated_at")

  // عدد التنبؤات المستخدمة في التقييم
  predictionCount Int @map("prediction_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, evaluatedAt])
  @@index([modelVersion])
  @@map("prediction_accuracies")
}

// ========== أنماط الغياب (Absence Patterns) ==========

model AbsencePattern {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // نوع النمط
  patternType String @map("pattern_type") // MONDAY_ABSENCE, POST_HOLIDAY, SEASONAL, etc.

  // وصف النمط
  description String @db.Text

  // الموظفون المتأثرون (JSON array of user IDs)
  affectedEmployees Json @map("affected_employees")

  // مستوى الثقة (0.0000 - 1.0000)
  confidence Decimal @db.Decimal(5, 4)

  // تاريخ اكتشاف النمط
  detectedAt DateTime @map("detected_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, detectedAt])
  @@index([patternType])
  @@map("absence_patterns")
}
