// Prisma Schema للنظام الحضور والانصراف
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== الشركات (Tenant) ====================

model Company {
  id       String  @id @default(uuid())
  name     String  @unique
  nameEn   String? @map("name_en")
  crNumber String? @unique @map("cr_number") // رقم السجل التجاري
  taxId    String? @unique @map("tax_id") // الرقم الضريبي
  logo     String?
  address  String?
  phone    String?
  email    String?
  website  String?

  // روابط العلاقات
  users                User[]
  branches             Branch[]
  jobTitles            JobTitle[]
  costCenters          CostCenter[]
  salaryComponents     SalaryComponent[]
  salaryStructures     SalaryStructure[]
  policies             Policy[]
  payrollPeriods       PayrollPeriod[]
  payrollRuns          PayrollRun[]
  holidays             Holiday[]
  holidayAssignments   HolidayAssignment[]
  gosiConfigs          GosiConfig[]
  departments          Department[]
  workSchedules        WorkSchedule[]
  attendances          Attendance[]
  leaveRequests        LeaveRequest[]
  letterRequests       LetterRequest[]
  notifications        Notification[]
  auditLogs            AuditLog[]
  advanceRequests      AdvanceRequest[]
  retroPays            RetroPay[]
  suspiciousAttempts   SuspiciousAttempt[]
  workFromHomes        WorkFromHome[]
  approvalLogs         ApprovalLog[]
  payslips             Payslip[]
  systemSettings       SystemSetting[]
  permissionAuditLogs  PermissionAuditLog[]
  raiseRequests        RaiseRequest[]
  userPermissions      UserPermission[]
  mudadSubmissions     MudadSubmission[]
  wpsSubmissions       WpsSubmission[]
  submissionStatusLogs SubmissionStatusLog[]
  approvalChainConfigs ApprovalChainConfig[]
  companyBankAccounts  CompanyBankAccount[]
  disciplinaryCases    DisciplinaryCase[]
  disciplinaryPolicy   CompanyDisciplinaryPolicy?
  payrollAdjustments   PayrollAdjustment[]
  payrollSettings      PayrollSettings?

  // العهد (Custody)
  custodyCategories   CustodyCategory[]
  custodyItems        CustodyItem[]
  custodyAssignments  CustodyAssignment[]
  custodyReturns      CustodyReturn[]
  custodyTransfers    CustodyTransfer[]
  custodyMaintenances CustodyMaintenance[]

  // نظام الإجازات المتقدم
  leaveTypeConfigs LeaveTypeConfig[]
  leaveBalances    LeaveBalance[]

  // السياسات الذكية (AI-Powered)
  smartPolicies                 SmartPolicy[]
  smartPolicyTemplates          SmartPolicyTemplate[]
  smartPolicyExceptions         SmartPolicyException[]
  smartPolicyOccurrenceTrackers SmartPolicyOccurrenceTracker[]
  smartPolicyRetroApplications  SmartPolicyRetroApplication[]
  policySimulationRuns          PolicySimulationRun[]

  // نظام تتبع الموقع (Location Tracking)
  employeeLocationLogs EmployeeLocationLog[]
  geofenceExitEvents   GeofenceExitEvent[]

  // نظام الترحيب (Onboarding)
  onboardingTemplates OnboardingTemplate[]
  onboardingProcesses OnboardingProcess[]

  // التحليلات التنبؤية (AI Predictive Analytics)
  absencePredictions   AbsencePrediction[]
  predictionAccuracies PredictionAccuracy[]
  absencePatterns      AbsencePattern[]
  saudizationConfig    SaudizationConfig?

  // Tasks & Sprints
  tasks          Task[]
  taskCategories TaskCategory[]
  taskTemplates  TaskTemplate[]
  sprints        Sprint[]

  // relations to production models
  costCenterAllocations   CostCenterAllocation[]
  goals                   Goal[]
  kpiDefinitions          KPIDefinition[]
  performanceReviewCycles PerformanceReviewCycle[]

  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  shiftTemplates        ShiftTemplate[]
  shiftSchedules        ShiftSchedule[]
  shifts                Shift[]
  shiftRules            ShiftRule[]
  shiftOptimizationRuns ShiftOptimizationRun[]
  employeeSurveys       EmployeeSurvey[]
  knowledgeBaseArticles KnowledgeBaseArticle[]
  teamCalendarEvents    TeamCalendarEvent[]
  programs              Program[]
  projects              Project[]
  projectTemplates      ProjectTemplate[]
  taskAutomations       TaskAutomation[]
  employeeDebtLedgers   EmployeeDebtLedger[]

  // Recognition & Succession Planning
  recognitions    Recognition[]
  successionPlans SuccessionPlan[]

  // Social Feed (المنشورات والتواصل الاجتماعي)
  posts Post[]

  // Calendar Events (أحداث التقويم)
  events               Event[]
  muqeemTransactions   MuqeemTransaction[]
  muqeemConfig         MuqeemConfig?
  employeeTerminations EmployeeTermination[]

  @@map("companies")
}

// ==================== إعدادات الرواتب (Payroll Settings) ====================

// قاعدة حساب يوم العمل
enum WorkDayCalculationBase {
  CALENDAR_DAYS // حساب على أساس أيام التقويم (30 يوم)
  ACTUAL_WORKING_DAYS // حساب على أساس أيام العمل الفعلية
  FIXED_30_DAYS // ثابت 30 يوم
}

// طريقة حساب التوظيف وإنهاء الخدمات
enum HireTerminationMethod {
  EXCLUDE_WEEKENDS // استثناء عطلات نهاية الأسبوع
  INCLUDE_ALL_DAYS // شمول جميع الأيام
  PRORATE_BY_CALENDAR // التناسب حسب التقويم
}

// طريقة حساب الإجازات غير المدفوعة
enum UnpaidLeaveMethod {
  BASED_ON_SHIFTS // على أساس مناوبات العمل
  BASED_ON_CALENDAR // على أساس التقويم
  BASED_ON_WORKING_DAYS // على أساس أيام العمل فقط
}

// طريقة حساب العمل الإضافي
enum OvertimeCalculationMethod {
  BASED_ON_SHIFTS // على أساس مناوبات العمل
  BASED_ON_BASIC_ONLY // على أساس الراتب الأساسي فقط
  BASED_ON_TOTAL // على أساس إجمالي الراتب
  BASED_ON_ELIGIBLE_COMPONENTS // على أساس البدلات الخاضعة للإضافي
}

// طريقة حساب بدل الإجازة
enum LeaveAllowanceMethod {
  BASIC_SALARY // الراتب الأساسي
  BASIC_PLUS_HOUSING // الراتب الأساسي + بدل السكن
  TOTAL_SALARY // إجمالي الراتب
}

model PayrollSettings {
  id        String  @id @default(uuid())
  companyId String  @unique @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // ========== تاريخ إغلاق الرواتب ==========
  payrollClosingDay Int @default(25) @map("payroll_closing_day")

  // ========== حساب التوظيف وإنهاء الخدمات ==========
  hireTerminationCalcBase WorkDayCalculationBase @default(CALENDAR_DAYS) @map("hire_termination_calc_base")
  hireTerminationMethod   HireTerminationMethod  @default(EXCLUDE_WEEKENDS) @map("hire_termination_method")

  // ========== حساب الإجازات غير المدفوعة ==========
  unpaidLeaveCalcBase      WorkDayCalculationBase @default(ACTUAL_WORKING_DAYS) @map("unpaid_leave_calc_base")
  unpaidLeaveMethod        UnpaidLeaveMethod      @default(BASED_ON_SHIFTS) @map("unpaid_leave_method")
  splitUnpaidByClosingDate Boolean                @default(false) @map("split_unpaid_by_closing_date")

  // ========== حساب ساعات العمل الإضافي ==========
  overtimeCalcBase WorkDayCalculationBase    @default(ACTUAL_WORKING_DAYS) @map("overtime_calc_base")
  overtimeMethod   OvertimeCalculationMethod @default(BASED_ON_SHIFTS) @map("overtime_method")

  // ========== حساب بدل أيام الإجازة ==========
  leaveAllowanceCalcBase WorkDayCalculationBase @default(CALENDAR_DAYS) @map("leave_allowance_calc_base")
  leaveAllowanceMethod   LeaveAllowanceMethod   @default(BASIC_PLUS_HOUSING) @map("leave_allowance_method")

  // ========== إعدادات قسيمة الراتب ==========
  showCompanyContributions Boolean @default(true) @map("show_company_contributions")
  showClosingDateOnPayslip Boolean @default(true) @map("show_closing_date_on_payslip")
  deductAbsenceFromBasic   Boolean @default(true) @map("deduct_absence_from_basic")
  showActualAbsenceDays    Boolean @default(false) @map("show_actual_absence_days")

  // ========== أرصدة الرواتب السلبية ==========
  enableNegativeBalanceCarryover Boolean @default(false) @map("enable_negative_balance_carryover")
  settleNegativeAsTransaction    Boolean @default(false) @map("settle_negative_as_transaction")

  // ========== إعدادات إضافية ==========
  roundSalaryToNearest       Int @default(0) @map("round_salary_to_nearest")
  defaultWorkingDaysPerMonth Int @default(30) @map("default_working_days_per_month")
  leaveDailyRateDivisor      Int @default(30) @map("leave_daily_rate_divisor")

  // ========== حقول الإنتاج المضافة ==========
  overtimeMultiplier             Float    @default(1.5) @map("overtime_multiplier")
  gracePeriodMinutes             Int      @default(15) @map("grace_period_minutes")
  weekendOvertimeMultiplier      Float    @default(2.0) @map("weekend_overtime_multiplier")
  holidayOvertimeMultiplier      Float    @default(2.0) @map("holiday_overtime_multiplier")
  nightShiftAllowancePercent     Float    @default(0) @map("night_shift_allowance_percent")
  maxDeductionPercent            Float    @default(50) @map("max_deduction_percent")
  minNetSalary                   Float    @default(0) @map("min_net_salary")
  autoLockDay                    Int      @default(0) @map("auto_lock_day")
  defaultCurrency                String   @default("SAR") @map("default_currency")
  enableMultiCurrency            Boolean  @default(false) @map("enable_multi_currency")
  enableBonusTracking            Boolean  @default(true) @map("enable_bonus_tracking")
  bonusCalculationMethod         String   @default("FIXED") @map("bonus_calculation_method")
  enableCommission               Boolean  @default(false) @map("enable_commission")
  commissionCalculationBase      String   @default("SALES") @map("commission_calculation_base")
  enableAllowanceCategories      Boolean  @default(true) @map("enable_allowance_categories")
  maxAllowancePercent            Float    @default(100) @map("max_allowance_percent")
  enableTaxCalculation           Boolean  @default(false) @map("enable_tax_calculation")
  taxCalculationMethod           String   @default("EXEMPT") @map("tax_calculation_method")
  enableSalaryAdvance            Boolean  @default(true) @map("enable_salary_advance")
  maxAdvancePercent              Float    @default(50) @map("max_advance_percent")
  enableLoanDeduction            Boolean  @default(true) @map("enable_loan_deduction")
  maxLoanDeductionPercent        Float    @default(30) @map("max_loan_deduction_percent")
  enableApprovalWorkflow         Boolean  @default(false) @map("enable_approval_workflow")
  approvalLevels                 Int      @default(1) @map("approval_levels")
  enableBankTransfer             Boolean  @default(true) @map("enable_bank_transfer")
  defaultBankCode                String   @default("") @map("default_bank_code")
  enableRetroactivePay           Boolean  @default(true) @map("enable_retroactive_pay")
  retroactiveMonthsLimit         Int      @default(3) @map("retroactive_months_limit")
  enableEosCalculation           Boolean  @default(true) @map("enable_eos_calculation")
  eosCalculationMethod           String   @default("SAUDI_LABOR_LAW") @map("eos_calculation_method")
  enableGosiCalculation          Boolean  @default(true) @map("enable_gosi_calculation")
  gosiEmployeePercent            Float    @default(9.75) @map("gosi_employee_percent")
  gosiEmployerPercent            Float    @default(11.75) @map("gosi_employer_percent")
  enableVacationEncashment       Boolean  @default(true) @map("enable_vacation_encashment")
  vacationEncashmentMethod       String   @default("ON_TERMINATION") @map("vacation_encashment_method")
  enableAttendancePenalty        Boolean  @default(true) @map("enable_attendance_penalty")
  lateDeductionMethod            String   @default("PER_MINUTE") @map("late_deduction_method")
  lateThresholdMinutes           Int      @default(120) @map("late_threshold_minutes")
  absenceDeductionMethod         String   @default("DAILY_RATE") @map("absence_deduction_method")
  absenceProgressiveRate         Float    @default(1.0) @map("absence_progressive_rate")
  enableEarlyDeparturePenalty    Boolean  @default(false) @map("enable_early_departure_penalty")
  earlyDepartureDeductionMethod  String   @default("PER_MINUTE") @map("early_departure_deduction_method")
  earlyDepartureThresholdMinutes Int      @default(120) @map("early_departure_threshold_minutes")
  enableCumulativeLateDeduction  Boolean  @default(false) @map("enable_cumulative_late_deduction")
  lateCountForDayDeduction       Int      @default(3) @map("late_count_for_day_deduction")
  gosiMaxSalary                  Float    @default(45000) @map("gosi_max_salary")
  enableSanedCalculation         Boolean  @default(true) @map("enable_saned_calculation")
  sanedEmployeePercent           Float    @default(0.75) @map("saned_employee_percent")
  sanedEmployerPercent           Float    @default(0.75) @map("saned_employer_percent")
  hazardRatePercent              Float    @default(2.0) @map("hazard_rate_percent")
  enablePayslipEmail             Boolean  @default(true) @map("enable_payslip_email")
  payslipLanguage                String   @default("AR") @map("payslip_language")
  enableOvertimeCap              Boolean  @default(false) @map("enable_overtime_cap")
  maxOvertimeHoursPerMonth       Int      @default(50) @map("max_overtime_hours_per_month")
  enableAutoPayrollGeneration    Boolean  @default(false) @map("enable_auto_payroll_generation")
  autoPayrollGenerationDay       Int      @default(25) @map("auto_payroll_generation_day")
  enablePayrollAuditTrail        Boolean  @default(true) @map("enable_payroll_audit_trail")
  enableSalaryRounding           Boolean  @default(false) @map("enable_salary_rounding")
  salaryRoundingMethod           String   @default("NEAREST") @map("salary_rounding_method")
  enableDepartmentBudget         Boolean  @default(false) @map("enable_department_budget")
  enableCostCenterTracking       Boolean  @default(false) @map("enable_cost_center_tracking")
  defaultPayrollExportFormat     String   @default("EXCEL") @map("default_payroll_export_format")
  enableSickLeaveDeduction       Boolean? @default(true) @map("enable_sick_leave_deduction")
  sickLeavePartialPayPercent     Float?   @default(75) @map("sick_leave_partial_pay_percent")
  sickLeaveFullPayDays           Int?     @default(30) @map("sick_leave_full_pay_days")
  sickLeavePartialPayDays        Int?     @default(60) @map("sick_leave_partial_pay_days")
  sickLeaveUnpaidDays            Int?     @default(30) @map("sick_leave_unpaid_days")
  calculationMethod              String?  @default("STANDARD") @map("calculation_method")
  payslipTemplate                String?  @default("DEFAULT") @map("payslip_template")
  showSalaryBreakdown            Boolean? @default(true) @map("show_salary_breakdown")
  showYtdTotals                  Boolean? @default(true) @map("show_ytd_totals")
  autoCalculateEos               Boolean? @default(true) @map("auto_calculate_eos")
  eosFirstYearsRate              Float?   @default(0.5) @map("eos_first_years_rate")
  eosLaterYearsRate              Float?   @default(1.0) @map("eos_later_years_rate")
  eosThresholdYears              Int?     @default(5) @map("eos_threshold_years")
  eosContractualRate             Float?   @default(1.0) @map("eos_contractual_rate")
  dailyWorkingHours              Float?   @default(8) @map("daily_working_hours")
  weeklyWorkingDays              Int?     @default(5) @map("weekly_working_days")
  overtimeRate                   Float?   @default(1.5) @map("overtime_rate")
  weekendOvertimeRate            Float?   @default(2.0) @map("weekend_overtime_rate")
  holidayOvertimeRate            Float?   @default(2.0) @map("holiday_overtime_rate")
  lateDeductionRate              Float?   @default(1.0) @map("late_deduction_rate")
  absenceDeductionRate           Float?   @default(1.0) @map("absence_deduction_rate")
  includeHousingInGosi           Boolean? @default(true) @map("include_housing_in_gosi")
  includeTransportInGosi         Boolean? @default(false) @map("include_transport_in_gosi")
  defaultLeaveDays               Int?     @default(21) @map("default_leave_days")
  leaveCarryOverDays             Int?     @default(5) @map("leave_carry_over_days")
  probationLeaveEnabled          Boolean? @default(false) @map("probation_leave_enabled")
  autoApproveLeave               Boolean? @default(false) @map("auto_approve_leave")
  enableOvertimeApproval         Boolean? @default(true) @map("enable_overtime_approval")
  workingDaysPerWeek             Int?     @default(5) @map("working_days_per_week")

  // ========== جدول دفع الرواتب ==========
  paymentDayType String? @default("LAST_WORKING_DAY") @map("payment_day_type")
  paymentDay     Int?    @default(28) @map("payment_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payroll_settings")
}

// ==================== المستخدمين والأدوار ====================

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
  HR
  MUQEEM_ADMIN
  MUQEEM_VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED // منتهي الخدمة
}

enum ContractType {
  PERMANENT // عقد دائم (غير محدد المدة)
  FIXED_TERM // عقد محدد المدة
  PART_TIME // دوام جزئي
  SEASONAL // موسمي
  PROBATION // فترة تجربة
}

enum ContractStatus {
  DRAFT // مسودة
  PENDING_EMPLOYEE // بانتظار توقيع الموظف
  PENDING_EMPLOYER // بانتظار توقيع صاحب العمل
  PENDING_QIWA // بانتظار التوثيق في قوى
  ACTIVE // ساري
  EXPIRED // منتهي
  TERMINATED // منهي
  RENEWED // مجدد
  SUSPENDED // موقوف
  REJECTED // مرفوض من قوى
}

enum QiwaAuthStatus {
  NOT_SUBMITTED // لم يرسل لقوى
  PENDING // بانتظار التوثيق
  AUTHENTICATED // موثق في قوى
  REJECTED // مرفوض
  EXPIRED // منتهي التوثيق
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  phone        String?    @unique
  password     String
  firstName    String     @map("first_name")
  lastName     String     @map("last_name")
  avatar       String?
  employeeCode String?    @map("employee_code")
  jobTitle     String?    @map("job_title") // Legacy - مسمى وظيفي نصي
  role         Role       @default(EMPLOYEE)
  status       UserStatus @default(ACTIVE)
  salary       Decimal?   @db.Decimal(10, 2)
  hireDate     DateTime?  @map("hire_date")
  nationality  String?    @map("nationality")
  isSaudi      Boolean    @default(true) @map("is_saudi")
  fcmToken     String?    @map("fcm_token")
  nationalId   String?    @unique @map("national_id") // رقم الهوية أو الإقامة

  // بيانات الإقامة والجواز (للأجانب) - متطلبات قوى
  iqamaNumber        String?   @map("iqama_number") // رقم الإقامة
  iqamaExpiryDate    DateTime? @map("iqama_expiry_date") @db.Date
  borderNumber       String?   @map("border_number") // رقم الحدود
  passportNumber     String?   @map("passport_number") // رقم الجواز
  passportExpiryDate DateTime? @map("passport_expiry_date") @db.Date
  professionCode     String?   @map("profession_code") // كود المهنة في قوى
  profession         String?   @map("profession") // اسم المهنة

  // بيانات GOSI/HRSD - متطلبات التأمينات ووزارة الموارد البشرية
  dateOfBirth   DateTime? @map("date_of_birth") @db.Date // تاريخ الميلاد
  gender        String? // MALE, FEMALE - الجنس
  gosiNumber    String?   @unique @map("gosi_number") // رقم التأمينات الاجتماعية
  maritalStatus String?   @map("marital_status") // SINGLE, MARRIED, DIVORCED, WIDOWED

  // Super Admin - يتخطى كل الـ guards
  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // الدرجة الوظيفية (الجديد)
  jobTitleId  String?   @map("job_title_id")
  jobTitleRef JobTitle? @relation(fields: [jobTitleId], references: [id])

  // رصيد الإجازات
  annualLeaveDays    Int @default(21) @map("annual_leave_days") // إجمالي أيام الإجازة السنوية
  usedLeaveDays      Int @default(0) @map("used_leave_days") // الأيام المستخدمة
  remainingLeaveDays Int @default(21) @map("remaining_leave_days") // الأيام المتبقية

  // بيانات التعرف على الوجه
  faceRegistered Boolean   @default(false) @map("face_registered")
  faceData       FaceData?

  // العلاقات
  companyId    String?     @map("company_id")
  company      Company?    @relation(fields: [companyId], references: [id])
  branchId     String?     @map("branch_id")
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])
  managerId    String?     @map("manager_id")
  manager      User?       @relation("ManagerEmployees", fields: [managerId], references: [id])
  employees    User[]      @relation("ManagerEmployees")

  // السجلات
  attendances             Attendance[]
  leaveRequests           LeaveRequest[]   @relation("EmployeeLeaveRequests")
  approvedLeaves          LeaveRequest[]   @relation("ApproverLeaveRequests")
  managerApprovedLeaves   LeaveRequest[]   @relation("ManagerApproverLeaveRequests")
  hrApprovedLeaves        LeaveRequest[]   @relation("HRApproverLeaveRequests")
  letterRequests          LetterRequest[]  @relation("EmployeeLetterRequests")
  approvedLetters         LetterRequest[]  @relation("ApproverLetterRequests")
  managerApprovedLetters  LetterRequest[]  @relation("ManagerApproverLetterRequests")
  hrApprovedLetters       LetterRequest[]  @relation("HRApproverLetterRequests")
  raiseRequests           RaiseRequest[]   @relation("EmployeeRaiseRequests")
  managerApprovedRaises   RaiseRequest[]   @relation("ManagerApproverRaiseRequests")
  hrApprovedRaises        RaiseRequest[]   @relation("HRApproverRaiseRequests")
  financeApprovedRaises   RaiseRequest[]   @relation("FinanceApproverRaiseRequests")
  ceoApprovedRaises       RaiseRequest[]   @relation("CEOApproverRaiseRequests")
  advanceRequests         AdvanceRequest[] @relation("EmployeeAdvanceRequests")
  managerApprovedAdvances AdvanceRequest[] @relation("ManagerApproverAdvanceRequests")
  hrApprovedAdvances      AdvanceRequest[] @relation("HRApproverAdvanceRequests")
  financeApprovedAdvances AdvanceRequest[] @relation("FinanceApproverAdvanceRequests")
  ceoApprovedAdvances     AdvanceRequest[] @relation("CEOApproverAdvanceRequests")
  notifications           Notification[]
  refreshTokens           RefreshToken[]
  auditLogs               AuditLog[]

  // إعدادات العمل من المنزل
  workFromHome WorkFromHome[]

  // المحاولات المشبوهة
  suspiciousAttempts SuspiciousAttempt[]

  // الأجهزة المسجلة
  registeredDevices RegisteredDevice[]

  // صلاحيات المستخدم
  userPermissions UserPermission[]

  // سجل الموافقات (Audit)
  approvalLogs ApprovalLog[]

  // relations to production models
  costCenterAllocations CostCenterAllocation[]
  goals                 Goal[]
  goalCheckIns          GoalCheckIn[]
  keyResultCheckIns     KeyResultCheckIn[]
  kpiAssignments        KPIAssignment[]
  performanceReviews    PerformanceReview[]    @relation("EmployeeReviews")
  managedReviews        PerformanceReview[]    @relation("ManagerReviews")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // روابط الرواتب والموارد البشرية الجديدة
  bankAccounts      EmployeeBankAccount[]
  contracts         Contract[]
  salaryAssignments EmployeeSalaryAssignment[] @relation("EmployeeSalaryAssignments")
  payslips          Payslip[]
  costCenterId      String?                    @map("cost_center_id")
  costCenter        CostCenter?                @relation(fields: [costCenterId], references: [id])
  retroPays         RetroPay[]
  policyTargets     Policy[]                   @relation("PolicyTargetEmployee")

  // Disciplinary Relations
  createdDisciplinaryCases DisciplinaryCase[]           @relation("ManagerCreatedCases")
  disciplinaryCases        DisciplinaryCase[]           @relation("EmployeeDisciplinaryCases")
  disciplinaryRecords      EmployeeDisciplinaryRecord[]

  // العهد (Custody Relations)
  custodyAssignments        CustodyAssignment[]  @relation("EmployeeCustody")
  custodyAssignedBy         CustodyAssignment[]  @relation("CustodyAssigner")
  custodyApproved           CustodyAssignment[]  @relation("CustodyApprover")
  custodyReturns            CustodyReturn[]      @relation("CustodyReturner")
  custodyReturnReviews      CustodyReturn[]      @relation("CustodyReturnReviewer")
  custodyTransfersFrom      CustodyTransfer[]    @relation("CustodyTransferFrom")
  custodyTransfersTo        CustodyTransfer[]    @relation("CustodyTransferTo")
  custodyTransferInitiated  CustodyTransfer[]    @relation("CustodyTransferInitiator")
  custodyTransferApproved   CustodyTransfer[]    @relation("CustodyTransferApprover")
  custodyMaintenanceReports CustodyMaintenance[] @relation("MaintenanceReporter")

  // حقول مخصصة (للاستيراد الذكي)
  customFields UserCustomField[]

  // وثائق الموظف
  employeeDocuments EmployeeDocument[]

  // أرصدة الإجازات المتقدمة
  leaveBalances LeaveBalance[]

  // نظام تتبع الموقع (Location Tracking)
  locationLogs       EmployeeLocationLog[]
  geofenceExitEvents GeofenceExitEvent[]

  // نظام الترحيب (Onboarding)
  onboardingProcesses OnboardingProcess[]

  // التحليلات التنبؤية (AI Predictive Analytics)
  absencePredictions AbsencePrediction[]

  // Tasks & Sprints relations
  tasksCreated           Task[]            @relation("tasks_created_by_idTousers")
  tasksAssigned          Task[]            @relation("tasks_assignee_idTousers")
  tasksApproved          Task[]            @relation("tasks_approver_idTousers")
  tasksReviewed          Task[]            @relation("tasks_reviewer_idTousers")
  taskAssignments        TaskAssignment[]
  taskWatchers           TaskWatcher[]
  taskComments           TaskComment[]
  taskTimeLogs           TaskTimeLog[]
  taskActivityLogs       TaskActivityLog[]
  taskApprovals          TaskApproval[]
  taskEvidencesSubmitted TaskEvidence[]    @relation("task_evidences_submitted_by_idTousers")
  taskEvidencesVerified  TaskEvidence[]    @relation("task_evidences_verified_by_idTousers")
  sprintsCreated         Sprint[]          @relation("SprintCreator")

  // Planning & Projects relations
  programsCreated        Program[]          @relation("ProgramCreator")
  programsManaged        Program[]          @relation("ProgramManager")
  programsOwned          Program[]          @relation("ProgramOwner")
  projectsCreated        Project[]          @relation("ProjectCreator")
  projectsManaged        Project[]          @relation("ProjectManager")
  projectsOwned          Project[]          @relation("ProjectOwner")
  projectsSponsored      Project[]          @relation("ProjectSponsor")
  projectMembers         ProjectMember[]    @relation("ProjectMembers")
  projectMilestonesOwned ProjectMilestone[] @relation("MilestoneOwner")
  projectRisksCreated    ProjectRisk[]      @relation("RiskCreator")
  projectRisksOwned      ProjectRisk[]      @relation("RiskOwner")
  projectBudgetsApproved ProjectBudget[]    @relation("BudgetApprover")
  projectBudgetsCreated  ProjectBudget[]    @relation("BudgetCreator")
  projectActivities      ProjectActivity[]  @relation("ProjectActivityUser")

  // Other relations
  shifts                      Shift[]                      @relation("UserShifts")
  shiftSwapManaged            ShiftSwapRequest[]           @relation("ShiftSwapManager")
  shiftSwapRequested          ShiftSwapRequest[]           @relation("ShiftSwapRequester")
  shiftSwapTargeted           ShiftSwapRequest[]           @relation("ShiftSwapTarget")
  shiftBids                   ShiftBid[]                   @relation("ShiftBidUser")
  policyViolationPredictions  PolicyViolationPrediction[]  @relation("PolicyPredictionUser")
  profileUpdateRequests       ProfileUpdateRequest[]       @relation("ProfileUpdateRequests")
  profileUpdateReviewed       ProfileUpdateRequest[]       @relation("ProfileUpdateReviewer")
  emergencyContacts           EmergencyContact[]           @relation("EmergencyContacts")
  trainingRequests            TrainingRequest[]            @relation("TrainingRequests")
  surveyResponses             SurveyResponse[]             @relation("SurveyResponses")
  articleFeedbacks            ArticleFeedback[]            @relation("ArticleFeedback")
  offlineSyncQueues           OfflineSyncQueue[]           @relation("OfflineSyncQueue")
  userNotificationPreferences UserNotificationPreferences? @relation("NotificationPreferences")
  locationProofs              LocationProof[]              @relation("LocationProofs")
  teamCalendarEvents          TeamCalendarEvent[]          @relation("TeamCalendarEvents")
  taskAutomations             TaskAutomation[]
  taskAttachments             TaskAttachment[]
  employeeDebtLedgers         EmployeeDebtLedger[]         @relation("EmployeeDebts")

  // Holidays & Smart Policies (Restored)
  holidayAssignments            HolidayAssignment[]
  smartPolicyOccurrenceTrackers SmartPolicyOccurrenceTracker[]
  smartPolicyRetroApplications  SmartPolicyRetroApplication[]

  // Recognition & Succession Planning
  recognitionsSent     Recognition[]         @relation("RecognitionSender")
  recognitionsReceived Recognition[]         @relation("RecognitionReceiver")
  recognitionReactions RecognitionReaction[]
  successionCandidates SuccessionCandidate[]

  // Social Feed (المنشورات والتواصل الاجتماعي)
  postsAuthored    Post[]            @relation("PostAuthor")
  postReactions    PostReaction[]    @relation("PostReactions")
  postComments     PostComment[]     @relation("PostComments")
  postViews        PostView[]        @relation("PostViews")
  postImpressions  PostImpression[]  @relation("PostImpressions")
  postAcknowledges PostAcknowledge[] @relation("PostAcknowledges")

  // Calendar Events (أحداث التقويم)
  eventsCreated    Event[]         @relation("EventCreator")
  eventAttendances EventAttendee[] @relation("EventAttendee")

  // أيام العمل الخاصة بالموظف (اختياري - يتجاوز إعدادات القسم والفرع)
  workingDays String? @map("working_days") // e.g., "1,2,3" for Mon-Wed

  // تسويات الرواتب
  employeeAdjustments       PayrollAdjustment[] @relation("EmployeeAdjustments")
  createdAdjustments        PayrollAdjustment[] @relation("AdjustmentCreator")
  approvedAdjustments       PayrollAdjustment[] @relation("AdjustmentApprover")
  payrollAdjustments        PayrollAdjustment[]
  muqeemTransactions        MuqeemTransaction[] @relation("MuqeemUserTransactions")
  muqeemTransactionsCreated MuqeemTransaction[] @relation("MuqeemCreatedTransactions")

  // نهاية الخدمة (EoS)
  employeeTerminations EmployeeTermination[] @relation("EmployeeTerminations")
  terminationsCreated  EmployeeTermination[] @relation("TerminationCreator")
  terminationsApproved EmployeeTermination[] @relation("TerminationApprover")

  @@unique([companyId, employeeCode])
  @@index([companyId, status])
  @@map("users")
}

// ==================== حقول مخصصة للموظفين (Smart Import) ====================

model UserCustomField {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fieldName  String @map("field_name") // اسم الحقل (مثل "راتب_الدوام")
  fieldValue String @map("field_value") @db.Text // القيمة
  fieldType  String @default("text") @map("field_type") // text, number, date, etc.

  // مصدر الحقل
  sourceHeader String?  @map("source_header") // اسم العمود الأصلي في ملف الاستيراد
  importedAt   DateTime @default(now()) @map("imported_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, fieldName])
  @@index([userId])
  @@index([fieldName])
  @@map("user_custom_fields")
}

// ==================== الدرجات الوظيفية ====================

model JobTitle {
  id              String   @id @default(uuid())
  companyId       String?  @map("company_id")
  company         Company? @relation(fields: [companyId], references: [id])
  name            String
  nameEn          String?  @map("name_en") // الاسم بالإنجليزية (اختياري)
  level           Role     @default(EMPLOYEE) // الدرجة: ADMIN, MANAGER, EMPLOYEE
  isDirectManager Boolean  @default(false) @map("is_direct_manager") // هل يمكن أن يكون مدير مباشر؟
  isActive        Boolean  @default(true) @map("is_active") // للحذف الناعم

  // الموظفين بهذه الدرجة
  users User[]

  // الصلاحيات الافتراضية لهذه الدرجة
  defaultPermissions JobTitlePermission[]
  policies           Policy[] // سياسات على مستوى الدرجة

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name])
  @@index([companyId, isActive])
  @@map("job_titles")
}

// ==================== الأجهزة المسجلة للموظفين ====================

enum DeviceStatus {
  ACTIVE // نشط ومعتمد
  PENDING // في انتظار الموافقة
  BLOCKED // محظور
  INACTIVE // غير نشط
}

enum DevicePlatform {
  ANDROID
  IOS
  WEB
  UNKNOWN
}

model RegisteredDevice {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // معرف الجهاز الفريد
  deviceId          String  @map("device_id") // Unique device identifier
  deviceFingerprint String? @map("device_fingerprint") // Hash of device info

  // معلومات الجهاز
  deviceName  String?        @map("device_name") // e.g., "iPhone 14 Pro"
  deviceModel String?        @map("device_model") // e.g., "iPhone14,3"
  deviceBrand String?        @map("device_brand") // e.g., "Apple"
  platform    DevicePlatform @default(UNKNOWN)
  osVersion   String?        @map("os_version") // e.g., "iOS 17.2"
  appVersion  String?        @map("app_version") // e.g., "1.0.0"

  // حالة الجهاز
  status       DeviceStatus @default(PENDING)
  isMainDevice Boolean      @default(false) @map("is_main_device") // الجهاز الرئيسي

  // الموافقة
  approvedBy    String?   @map("approved_by")
  approvedAt    DateTime? @map("approved_at")
  blockedReason String?   @map("blocked_reason")

  // إحصائيات الاستخدام
  lastUsedAt DateTime? @map("last_used_at")
  usageCount Int       @default(0) @map("usage_count")

  // سجل المحاولات
  deviceLogs DeviceAccessLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, deviceId])
  @@index([deviceId])
  @@index([userId, status])
  @@map("registered_devices")
}

// سجل محاولات الوصول من الأجهزة
model DeviceAccessLog {
  id       String            @id @default(uuid())
  deviceId String?           @map("device_id")
  device   RegisteredDevice? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  userId            String @map("user_id")
  attemptedDeviceId String @map("attempted_device_id") // معرف الجهاز المستخدم

  // نوع المحاولة
  actionType    String  @map("action_type") // CHECK_IN, CHECK_OUT, LOGIN
  isSuccess     Boolean @map("is_success")
  isKnownDevice Boolean @map("is_known_device")

  // معلومات إضافية
  deviceInfo String? @map("device_info") @db.Text // JSON with full device info
  ipAddress  String? @map("ip_address")
  location   String? // lat,lng

  // سبب الفشل
  failureReason String? @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([attemptedDeviceId])
  @@map("device_access_logs")
}

// ==================== طلبات تحديث بيانات الحضور ====================

enum UpdateRequestStatus {
  PENDING // في انتظار المراجعة
  APPROVED // تمت الموافقة
  REJECTED // مرفوض
  CANCELLED // ملغي من الموظف
}

enum UpdateRequestType {
  FACE_UPDATE // تحديث بيانات الوجه فقط
  DEVICE_UPDATE // تحديث بيانات الجهاز فقط
  BOTH // تحديث كليهما
  DEVICE_CHANGE // تغيير جهاز (موبايل جديد)
  PROFILE_UPDATE // تحديث بيانات الملف الشخصي
}

model DataUpdateRequest {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // نوع التحديث
  requestType UpdateRequestType   @map("request_type")
  status      UpdateRequestStatus @default(PENDING)

  // سبب الطلب من الموظف
  reason String? @db.Text

  // ============ بيانات الوجه الجديدة ============
  newFaceEmbedding String? @map("new_face_embedding") @db.Text
  newFaceImage     String? @map("new_face_image") @db.Text // صورة Base64
  faceImageQuality Float?  @map("face_image_quality")

  // ============ بيانات الجهاز الجديد ============
  newDeviceId          String?         @map("new_device_id")
  newDeviceFingerprint String?         @map("new_device_fingerprint")
  newDeviceName        String?         @map("new_device_name")
  newDeviceModel       String?         @map("new_device_model")
  newDeviceBrand       String?         @map("new_device_brand")
  newDevicePlatform    DevicePlatform? @map("new_device_platform")
  newDeviceOsVersion   String?         @map("new_device_os_version")
  newDeviceAppVersion  String?         @map("new_device_app_version")

  // ============ بيانات المراجعة ============
  reviewedBy      String?   @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNote      String?   @map("review_note") // ملاحظة المسؤول
  rejectionReason String?   @map("rejection_reason")

  // ============ بيانات الملف الشخصي الجديدة ============
  newData Json? @map("new_data")

  // ============ معلومات إضافية ============
  oldDeviceId String? @map("old_device_id") // الجهاز القديم للمقارنة

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("data_update_requests")
}

// ==================== بيانات التعرف على الوجه ====================

model FaceData {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Face Embeddings - مصفوفة الأرقام التي تمثل ملامح الوجه
  faceEmbedding String @map("face_embedding") @db.Text // JSON array of floats

  // صورة الوجه المرجعية (Base64 مشفرة)
  faceImage String? @map("face_image") @db.Text

  // معلومات إضافية
  registeredAt      DateTime  @default(now()) @map("registered_at")
  lastVerifiedAt    DateTime? @map("last_verified_at")
  verificationCount Int       @default(0) @map("verification_count")

  // جودة الصورة والتحقق
  imageQuality Float? @map("image_quality") // 0-1
  confidence   Float? // ثقة التسجيل

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("face_data")
}

model RefreshToken {
  id         String   @id @default(uuid())
  token      String   @unique
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

// ==================== الفروع والأقسام ====================

model Branch {
  id             String   @id @default(uuid())
  companyId      String?  @map("company_id")
  company        Company? @relation(fields: [companyId], references: [id])
  name           String
  nameEn         String?  @map("name_en")
  address        String?
  latitude       Decimal  @db.Decimal(10, 8)
  longitude      Decimal  @db.Decimal(11, 8)
  geofenceRadius Int      @default(100) @map("geofence_radius") // بالمتر
  timezone       String   @default("Asia/Riyadh")
  isActive       Boolean  @default(true) @map("is_active")

  // مواعيد العمل الافتراضية
  workStartTime String @default("09:00") @map("work_start_time")
  workEndTime   String @default("17:00") @map("work_end_time")

  // فترات السماح
  lateGracePeriod     Int @default(10) @map("late_grace_period") // دقائق
  earlyCheckInPeriod  Int @default(15) @map("early_check_in_period") // دقائق قبل بداية الدوام
  earlyCheckOutPeriod Int @default(0) @map("early_check_out_period") // دقائق

  // أيام العمل
  workingDays String @default("1,2,3,4,5") @map("working_days") // 0=الأحد, 6=السبت

  // إعدادات رمضان
  ramadanModeEnabled   Boolean @default(false) @map("ramadan_mode_enabled") // تفعيل وضع رمضان
  ramadanWorkHours     Int     @default(6) @map("ramadan_work_hours") // ساعات العمل في رمضان (6 ساعات بموجب القانون)
  ramadanWorkStartTime String? @map("ramadan_work_start_time") // وقت بداية العمل في رمضان (اختياري)
  ramadanWorkEndTime   String? @map("ramadan_work_end_time") // وقت نهاية العمل في رمضان (اختياري)

  users          User[]
  departments    Department[]
  attendances    Attendance[]
  schedules      WorkSchedule[]
  policies       Policy[] // سياسات على مستوى الفرع
  custodyItems   CustodyItem[] // العهد في هذا الفرع
  breakSchedules BranchBreakSchedule[] // جدول الاستراحات الثابتة

  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  shiftSchedules ShiftSchedule[]

  @@unique([companyId, name])
  @@map("branches")
}

// ==================== جدول الاستراحات الثابتة للفرع ====================

// نوع الاستراحة الثابتة
enum ScheduledBreakType {
  DHUHR_PRAYER // صلاة الظهر
  ASR_PRAYER // صلاة العصر
  LUNCH // استراحة الغداء
  REST // استراحة راحة
  OTHER // أخرى
}

// جدول استراحات الفرع
model BranchBreakSchedule {
  id        String  @id @default(uuid())
  companyId String? @map("company_id")
  branchId  String  @map("branch_id")
  branch    Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // نوع الاستراحة
  name   String // اسم الاستراحة (صلاة الظهر، غداء، إلخ)
  nameEn String?            @map("name_en")
  type   ScheduledBreakType @default(OTHER)

  // أوقات الاستراحة
  startTime String @map("start_time") // e.g., "12:00"
  endTime   String @map("end_time") // e.g., "12:30"

  // مدة الاستراحة بالدقائق (تُحسب تلقائياً أو تُدخل يدوياً)
  durationMinutes Int @map("duration_minutes")

  // هل الاستراحة مدفوعة؟ (لا تُخصم من ساعات العمل)
  isPaid Boolean @default(true) @map("is_paid")

  // أيام تطبيق الاستراحة (0-6, مفصولة بفاصلة) فارغ = كل الأيام
  applicableDays String? @map("applicable_days") // e.g., "0,1,2,3,4" 

  // هل الاستراحة مفعّلة؟
  isActive Boolean @default(true) @map("is_active")

  // ترتيب العرض
  sortOrder Int @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([branchId])
  @@index([companyId])
  @@map("branch_break_schedules")
}

model Department {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  name      String
  nameEn    String?  @map("name_en")
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])

  // جدول عمل خاص بالقسم (اختياري)
  workStartTime String? @map("work_start_time")
  workEndTime   String? @map("work_end_time")

  // أيام العمل الخاصة بالقسم (اختياري - يتجاوز إعدادات الفرع)
  workingDays String? @map("working_days") // e.g., "0,1,2,3,4,5" for Sun-Fri

  users    User[]
  policies Policy[] // سياسات على مستوى القسم

  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  departmentSaudizations DepartmentSaudization[]
  shiftSchedules         ShiftSchedule[]
  costCenters            CostCenter[]

  @@unique([companyId, name])
  @@map("departments")
}

// ==================== جدول العمل ====================

model WorkSchedule {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])

  dayOfWeek     Int     @map("day_of_week") // 0-6 (الأحد - السبت)
  workStartTime String  @map("work_start_time")
  workEndTime   String  @map("work_end_time")
  isWorkingDay  Boolean @default(true) @map("is_working_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([branchId, dayOfWeek])
  @@map("work_schedules")
}

// ==================== سجلات الحضور ====================

enum AttendanceStatus {
  PRESENT // حضر في الوقت
  LATE // متأخر
  EARLY_LEAVE // انصراف مبكر
  ABSENT // غائب
  ON_LEAVE // إجازة
  WORK_FROM_HOME // عمل من المنزل
  OFF_DAY // يوم راحة
  HOLIDAY // إجازة رسمية
  EXCUSED // غياب بعذر
  WFM // عمل من المنزل (Advanced)
  MOCKED // موقع وهمي
  LATE_AND_EARLY
}

enum CheckType {
  CHECK_IN
  CHECK_OUT
}

model Attendance {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])

  date DateTime @db.Date

  status       AttendanceStatus @default(ABSENT)
  checkInTime  DateTime?        @map("check_in_time")
  checkOutTime DateTime?        @map("check_out_time")

  // معلومات الموقع عند الحضور
  checkInLatitude  Decimal? @map("check_in_latitude") @db.Decimal(10, 8)
  checkInLongitude Decimal? @map("check_in_longitude") @db.Decimal(11, 8)
  checkInDistance  Int?     @map("check_in_distance") // المسافة بالمتر من الفرع

  // معلومات الموقع عند الانصراف
  checkOutLatitude  Decimal? @map("check_out_latitude") @db.Decimal(10, 8)
  checkOutLongitude Decimal? @map("check_out_longitude") @db.Decimal(11, 8)
  checkOutDistance  Int?     @map("check_out_distance")

  // إحصائيات الحضور (يتم حسابها بعد الانصراف)
  lateMinutes       Int @default(0) @map("late_minutes")
  earlyLeaveMinutes Int @default(0) @map("early_leave_minutes")
  workingMinutes    Int @default(0) @map("working_minutes")
  overtimeMinutes   Int @default(0) @map("overtime_minutes")

  // ملاحظات
  notes          String?
  isWorkFromHome Boolean @default(false) @map("is_work_from_home")

  // محاولات مشبوهة
  isMockLocation Boolean @default(false) @map("is_mock_location")
  deviceInfo     String? @map("device_info")

  // التحقق بالوجه
  checkInFaceVerified    Boolean @default(false) @map("check_in_face_verified")
  checkInFaceConfidence  Float?  @map("check_in_face_confidence")
  checkOutFaceVerified   Boolean @default(false) @map("check_out_face_verified")
  checkOutFaceConfidence Float?  @map("check_out_face_confidence")

  // استراحات الموظف خلال اليوم
  breaks Break[]

  // أحداث الخروج من النطاق
  geofenceExitEvents GeofenceExitEvent[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, date])
  @@index([companyId, date])
  @@index([userId, date])
  @@index([branchId, date])
  @@map("attendances")
}

// ==================== نظام تتبع الاستراحات (Break Time Management) ====================

// أنواع الاستراحات
enum BreakType {
  PRAYER // استراحة الصلاة
  LUNCH // استراحة الغداء
  PERSONAL // استراحة شخصية
  REST // استراحة راحة
  OTHER // أخرى
}

// حالة الاستراحة
enum BreakStatus {
  ACTIVE // جارية - لم تنتهِ بعد
  COMPLETED // منتهية - تم تسجيل وقت النهاية
  CANCELLED // ملغاة
}

// نموذج تسجيل الاستراحات
model Break {
  id        String  @id @default(uuid())
  companyId String? @map("company_id")

  // ربط بالحضور
  attendanceId String     @map("attendance_id")
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  // ربط بالموظف
  userId String @map("user_id")

  // نوع الاستراحة
  type   BreakType   @default(PERSONAL)
  status BreakStatus @default(ACTIVE)

  // أوقات الاستراحة
  startTime DateTime  @map("start_time")
  endTime   DateTime? @map("end_time")

  // مدة الاستراحة بالدقائق (تُحسب تلقائياً عند الإنهاء)
  durationMinutes Int? @map("duration_minutes")

  // هل الاستراحة مدفوعة؟ (لا تُخصم من ساعات العمل)
  isPaid Boolean @default(false) @map("is_paid")

  // ملاحظات
  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([attendanceId])
  @@index([userId, startTime])
  @@index([companyId, startTime])
  @@map("breaks")
}

// سجل محاولات التحقق بالوجه
model FaceVerificationLog {
  id     String @id @default(uuid())
  userId String @map("user_id")

  verificationType String  @map("verification_type") // CHECK_IN, CHECK_OUT, REGISTRATION
  isSuccess        Boolean @map("is_success")
  confidence       Float? // نسبة التطابق
  threshold        Float? // الحد الأدنى المطلوب

  // معلومات الجهاز
  deviceInfo String? @map("device_info")
  ipAddress  String? @map("ip_address")

  // صورة المحاولة (اختياري للتدقيق)
  attemptImage String? @map("attempt_image") @db.Text

  errorMessage String? @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("face_verification_logs")
}

// سجل محاولات الحضور المشبوهة
model SuspiciousAttempt {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  attemptType String   @map("attempt_type") // MOCK_LOCATION, OUT_OF_RANGE, etc.
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  distance    Int? // المسافة من الفرع
  deviceInfo  String?  @map("device_info")
  ipAddress   String?  @map("ip_address")
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("suspicious_attempts")
}

// ==================== نظام إدارة الإجازات المتقدم ====================

// تصنيف الإجازات
enum LeaveCategory {
  BALANCED // إجازات متوازنة/متراكمة (سنوية)
  CASUAL // إجازات عارضة (زواج، وفاة)
  SICK // إجازات مرضية
  UNPAID // بدون راتب
  SICK_PAID
  SICK_PARTIAL
  OTHER
}

// إعدادات أنواع الإجازات - Dynamic Leave Type Configuration
model LeaveTypeConfig {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  code        String // ANNUAL, SICK, MARRIAGE - للرجوع البرمجي
  nameAr      String  @map("name_ar")
  nameEn      String? @map("name_en")
  description String?

  // تصنيف الإجازة
  category LeaveCategory @default(BALANCED)

  // إعدادات الاستحقاق
  isEntitlementBased Boolean @default(true) @map("is_entitlement_based") // هل تعتمد على استحقاق سنوي؟
  defaultEntitlement Int     @default(0) @map("default_entitlement") // الاستحقاق الافتراضي
  maxBalanceCap      Int?    @map("max_balance_cap") // الحد الأقصى للتراكم (مثل 60 يوم)

  // إعدادات الترحيل
  allowCarryForward        Boolean @default(true) @map("allow_carry_forward")
  maxCarryForwardDays      Int?    @map("max_carry_forward_days")
  carryForwardExpiryMonths Int?    @map("carry_forward_expiry_months") // صلاحية الأيام المرحلة

  // إعدادات الراتب
  isPaid            Boolean @default(true) @map("is_paid")
  paymentPercentage Int     @default(100) @map("payment_percentage") // نسبة الراتب

  // متطلبات
  requiresAttachment          Boolean @default(false) @map("requires_attachment")
  attachmentRequiredAfterDays Int?    @map("attachment_required_after_days")
  minNoticeDays               Int     @default(0) @map("min_notice_days") // فترة الإشعار المسبق
  minRequestDays              Int     @default(1) @map("min_request_days")
  maxRequestDays              Int?    @map("max_request_days")

  // قواعد خاصة
  allowNegativeBalance Boolean @default(false) @map("allow_negative_balance")
  deductFromAnnual     Boolean @default(false) @map("deduct_from_annual") // خصم من السنوية إذا نفد الرصيد
  isOneTimeOnly        Boolean @default(false) @map("is_one_time_only") // مرة واحدة فقط (مثل الحج)

  // الحالة
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  // العلاقات
  entitlementTiers LeaveEntitlementTier[]
  sickPayTiers     SickPayTier[]
  leaveBalances    LeaveBalance[]
  leaveRequests    LeaveRequest[]         @relation("LeaveTypeConfigRequests")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@index([companyId, isActive])
  @@map("leave_type_configs")
}

// شرائح الاستحقاق حسب سنوات الخدمة
model LeaveEntitlementTier {
  id          String          @id @default(uuid())
  leaveTypeId String          @map("leave_type_id")
  leaveType   LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  minServiceYears Int @map("min_service_years") // من سنة
  maxServiceYears Int @map("max_service_years") // إلى سنة (999 = غير محدود)
  entitlementDays Int @map("entitlement_days") // عدد أيام الاستحقاق

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([leaveTypeId, minServiceYears])
  @@index([leaveTypeId])
  @@map("leave_entitlement_tiers")
}

// شرائح أجر الإجازة المرضية (نظام العمل السعودي)
model SickPayTier {
  id          String          @id @default(uuid())
  leaveTypeId String          @map("leave_type_id")
  leaveType   LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  fromDay        Int @map("from_day") // من يوم
  toDay          Int @map("to_day") // إلى يوم
  paymentPercent Int @map("payment_percent") // نسبة الراتب (100, 75, 0)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([leaveTypeId, fromDay])
  @@index([leaveTypeId])
  @@map("sick_pay_tiers")
}

// رصيد الإجازات لكل موظف لكل نوع
model LeaveBalance {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  userId      String          @map("user_id")
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId String          @map("leave_type_id")
  leaveType   LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id])

  year Int // السنة الميلادية

  // الاستحقاق
  entitled       Decimal @default(0) @db.Decimal(5, 2) // المستحق للسنة
  carriedForward Decimal @default(0) @map("carried_forward") @db.Decimal(5, 2) // المرحل من السنة السابقة

  // الاستخدام
  used    Decimal @default(0) @db.Decimal(5, 2) // المستخدم
  pending Decimal @default(0) @db.Decimal(5, 2) // المعلق (طلبات قيد الموافقة)

  // للإجازات العارضة (مثل الزواج) - عدد مرات الاستخدام
  timesUsed Int @default(0) @map("times_used")

  // تاريخ انتهاء صلاحية الأيام المرحلة
  carryForwardExpiresAt DateTime? @map("carry_forward_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, leaveTypeId, year])
  @@index([userId, year])
  @@index([leaveTypeId])
  @@index([companyId])
  @@map("leave_balances")
}

// ==================== طلبات الإجازات ====================

enum LeaveType {
  ANNUAL // إجازة سنوية
  SICK // إجازة مرضية
  PERSONAL // إجازة شخصية
  EMERGENCY // إجازة طارئة
  NEW_BABY // مولود جديد
  MARRIAGE // إجازة زواج
  BEREAVEMENT // إجازة الوفاة
  HAJJ // إجازة الحج
  EXAM // إجازة اختبارات
  WORK_MISSION // مهمة عمل
  UNPAID // إجازة بدون راتب
  EARLY_LEAVE // انصراف مبكر (كطلب إجازة)
  OTHER // أخرى
}

enum LeaveStatus {
  PENDING
  MGR_APPROVED // موافقة المدير (الخطوة الأولى)
  MGR_REJECTED // رفض المدير
  APPROVED // موافقة نهائية (HR)
  REJECTED // رفض نهائي (HR)
  MODIFIED // تم التعديل والموافقة
  CANCELLED
  DELAYED // مؤجل
}

enum ApprovalStep {
  MANAGER
  HR
  FINANCE
  CEO
  COMPLETED
}

enum ApprovalDecision {
  PENDING
  APPROVED
  REJECTED
  DELAYED
}

model LeaveRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeLeaveRequests", fields: [userId], references: [id])

  type      LeaveType
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime  @map("end_date") @db.Date

  // عدد الأيام
  requestedDays Int  @default(1) @map("requested_days") // الأيام المطلوبة
  approvedDays  Int? @map("approved_days") // الأيام المعتمدة (قد تختلف)

  reason      String      @db.Text // السبب
  notes       String?     @db.VarChar(500) // ملاحظات إضافية
  attachments Json? // مرفقات
  status      LeaveStatus @default(PENDING)

  // ========== Workflow متعدد المراحل ==========
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId  String?          @map("manager_approver_id")
  managerApprover    User?            @relation("ManagerApproverLeaveRequests", fields: [managerApproverId], references: [id])
  managerDecision    ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt  DateTime?        @map("manager_decision_at")
  managerNotes       String?          @map("manager_notes") @db.VarChar(500)
  managerAttachments Json?            @map("manager_attachments")

  // موافقة HR
  hrApproverId    String?          @map("hr_approver_id")
  hrApprover      User?            @relation("HRApproverLeaveRequests", fields: [hrApproverId], references: [id])
  hrDecision      ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt    DateTime?        @map("hr_decision_at")
  hrDecisionNotes String?          @map("hr_decision_notes") @db.VarChar(500)
  hrAttachments   Json?            @map("hr_attachments")

  // Legacy: الموافقة القديمة (للتوافق)
  approverId    String?   @map("approver_id")
  approver      User?     @relation("ApproverLeaveRequests", fields: [approverId], references: [id])
  approverNotes String?   @map("approver_notes")
  approvedAt    DateTime? @map("approved_at")

  // ========== نظام الإجازات المتقدم ==========

  // ربط مع LeaveTypeConfig (اختياري للتوافق الخلفي)
  leaveTypeConfigId String?          @map("leave_type_config_id")
  leaveTypeConfig   LeaveTypeConfig? @relation("LeaveTypeConfigRequests", fields: [leaveTypeConfigId], references: [id])

  // للإجازة المرضية - حساب الأجر المتدرج (نظام العمل السعودي)
  fullPayDays    Int? @map("full_pay_days") // أيام براتب كامل (100%)
  partialPayDays Int? @map("partial_pay_days") // أيام براتب جزئي (75%)
  unpaidDays     Int? @map("unpaid_days") // أيام بدون راتب (0%)

  // للتأثير على الرواتب
  salaryImpact Decimal? @map("salary_impact") @db.Decimal(10, 2) // قيمة الخصم/الإضافة

  // وقت التقديم بالنسبة للإشعار المسبق
  noticeDaysProvided Int? @map("notice_days_provided")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([userId, status])
  @@index([leaveTypeConfigId])
  @@map("leave_requests")
}

// ==================== طلبات الخطابات ====================

enum LetterType {
  SALARY_DEFINITION // خطاب تعريف راتب
  SERVICE_CONFIRMATION // خطاب تأكيد خدمة
  SALARY_ADJUSTMENT // خطاب تعديل راتب
  PROMOTION // خطاب ترقية
  TRANSFER_ASSIGNMENT // خطاب نقل / تكليف
  RESIGNATION // خطاب استقالة (معتمد من الشركة)
  TERMINATION // خطاب إنهاء خدمة
  CLEARANCE // خطاب إخلاء طرف
  EXPERIENCE // خطاب خبرة
  SALARY_DEFINITION_DIRECTED // خطاب تعريف راتب (موجّه لجهة محددة)
  NOC // خطاب عدم ممانعة
  DELEGATION // خطاب تفويض
}

enum LetterStatus {
  PENDING
  MGR_APPROVED // موافقة المدير
  MGR_REJECTED // رفض المدير
  APPROVED // موافقة نهائية (HR)
  REJECTED // رفض نهائي (HR)
  DELAYED // مؤجل
  CANCELLED
}

model LetterRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeLetterRequests", fields: [userId], references: [id])

  type        LetterType
  notes       String?      @db.VarChar(200) // الملاحظات (حد أقصى 200 حرف)
  attachments Json? // مرفقات (صور/ملفات)
  status      LetterStatus @default(PENDING)

  // ========== Workflow متعدد المراحل ==========
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId  String?          @map("manager_approver_id")
  managerApprover    User?            @relation("ManagerApproverLetterRequests", fields: [managerApproverId], references: [id])
  managerDecision    ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt  DateTime?        @map("manager_decision_at")
  managerNotes       String?          @map("manager_notes") @db.VarChar(500)
  managerAttachments Json?            @map("manager_attachments")

  // موافقة HR
  hrApproverId    String?          @map("hr_approver_id")
  hrApprover      User?            @relation("HRApproverLetterRequests", fields: [hrApproverId], references: [id])
  hrDecision      ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt    DateTime?        @map("hr_decision_at")
  hrDecisionNotes String?          @map("hr_decision_notes") @db.VarChar(500)
  hrAttachments   Json?            @map("hr_attachments")

  // Legacy: الموافقة القديمة (للتوافق)
  approverId    String?   @map("approver_id")
  approver      User?     @relation("ApproverLetterRequests", fields: [approverId], references: [id])
  approverNotes String?   @map("approver_notes")
  approvedAt    DateTime? @map("approved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("letter_requests")
}

// ==================== العمل من المنزل ====================

model WorkFromHome {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  company    Company? @relation(fields: [companyId], references: [id])
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  date       DateTime @db.Date
  reason     String?
  approvedBy String?  @map("approved_by")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("work_from_home")
}

// ==================== الإشعارات ====================

enum NotificationType {
  LATE_CHECK_IN
  EARLY_CHECK_OUT
  EARLY_CHECK_IN
  LEAVE_APPROVED
  LEAVE_REJECTED
  LETTER_APPROVED
  LETTER_REJECTED
  SUSPICIOUS_ACTIVITY
  GENERAL
  // Disciplinary notifications
  DISC_CASE_SUBMITTED
  DISC_HR_REJECTED
  DISC_INFORMAL_SENT
  DISC_EMP_REJECTED_INFORMAL
  DISC_HEARING_SCHEDULED
  DISC_DECISION_ISSUED
  DISC_EMP_OBJECTED
  DISC_FINALIZED
  // Location tracking notifications
  EMP_EXIT_GEOFENCE // موظف خرج من نطاق الشركة
  EMP_RETURN_GEOFENCE // موظف عاد إلى نطاق الشركة
}

model Notification {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  type    NotificationType
  title   String
  titleEn String?          @map("title_en")
  body    String
  bodyEn  String?          @map("body_en")
  data    Json? // بيانات إضافية

  // Entity reference for navigation
  entityType String? @map("entity_type") // DISCIPLINARY_CASE, LEAVE_REQUEST
  entityId   String? @map("entity_id")

  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([userId, isRead])
  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// ==================== سجل التدقيق ====================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SETTINGS_CHANGE
  EXPORT
  IMPORT
}

model AuditLog {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id])

  action      AuditAction
  entity      String // اسم الكيان (User, Branch, etc.)
  entityId    String?     @map("entity_id")
  oldValue    Json?       @map("old_value")
  newValue    Json?       @map("new_value")
  description String?
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId, createdAt])
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== العطلات الرسمية ====================

model Holiday {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  name        String
  nameEn      String?  @map("name_en")
  date        DateTime @db.Date
  isRecurring Boolean  @default(false) @map("is_recurring") // تتكرر كل سنة

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Restored fields
  isPaid             Boolean                @default(true) @map("is_paid")
  applicationType    HolidayApplicationType @default(ALL) @map("application_type")
  countAsWorkDay     Boolean                @default(false) @map("count_as_work_day")
  overtimeMultiplier Decimal                @default(2.0) @map("overtime_multiplier") @db.Decimal(3, 2)
  notes              String?
  holidayAssignments HolidayAssignment[]

  @@map("holidays")
}

model HolidayAssignment {
  id         String   @id @default(uuid())
  holidayId  String   @map("holiday_id")
  companyId  String   @map("company_id")
  employeeId String   @map("employee_id")
  createdAt  DateTime @default(now()) @map("created_at")

  holiday Holiday @relation(fields: [holidayId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([holidayId])
  @@index([companyId])
  @@index([employeeId])
  @@map("holiday_assignments")
}

// ==================== إعدادات النظام ====================

model SystemSetting {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  key         String
  value       String
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([key, companyId])
  @@map("system_settings")
}

// ==================== نظام الصلاحيات ====================

enum PermissionScope {
  SELF // نفسي فقط
  TEAM // فريقي المباشر (المرؤوسين)
  BRANCH // فرع معين
  DEPARTMENT // قسم معين
  ALL // كل الموظفين
  CUSTOM // موظفين محددين
}

model Permission {
  id          String  @id @default(uuid())
  code        String  @unique // LEAVES_VIEW, LEAVES_APPROVE, etc.
  name        String // الاسم بالعربي
  nameEn      String? @map("name_en")
  category    String // التصنيف
  description String?

  // الصلاحية المطلوبة مسبقاً
  requiresPermission String? @map("requires_permission")

  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  userPermissions     UserPermission[]
  jobTitlePermissions JobTitlePermission[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([code])
  @@map("permissions")
}

model UserPermission {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  // نطاق الصلاحية
  scope        PermissionScope @default(SELF)
  branchId     String?         @map("branch_id")
  departmentId String?         @map("department_id")

  // الموظفين المحددين (إذا كان النطاق CUSTOM)
  assignedEmployees UserPermissionEmployee[]

  createdAt DateTime @default(now()) @map("created_at")

  // السماح بنفس الصلاحية بنطاقات مختلفة
  @@unique([userId, permissionId, scope, branchId, departmentId])
  // فهارس للأداء
  @@index([userId])
  @@index([permissionId])
  @@index([userId, permissionId])
  @@index([scope, branchId])
  @@index([scope, departmentId])
  @@index([companyId])
  @@map("user_permissions")
}

model UserPermissionEmployee {
  id               String         @id @default(uuid())
  userPermissionId String         @map("user_permission_id")
  userPermission   UserPermission @relation(fields: [userPermissionId], references: [id], onDelete: Cascade)
  employeeId       String         @map("employee_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userPermissionId, employeeId])
  @@index([userPermissionId])
  @@index([employeeId])
  @@map("user_permission_employees")
}

// ==================== الصلاحيات الافتراضية للدرجات الوظيفية ====================

model JobTitlePermission {
  id           String     @id @default(uuid())
  jobTitleId   String     @map("job_title_id")
  jobTitle     JobTitle   @relation(fields: [jobTitleId], references: [id], onDelete: Cascade)
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // النطاق الافتراضي للصلاحية
  scope PermissionScope @default(TEAM)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([jobTitleId, permissionId])
  @@index([jobTitleId])
  @@index([permissionId])
  @@map("job_title_permissions")
}

// ==================== سجل تدقيق الصلاحيات ====================

enum PermissionAuditAction {
  ADDED // تمت إضافة صلاحية
  REMOVED // تم حذف صلاحية
  MODIFIED // تم تعديل النطاق
}

model PermissionAuditLog {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  // من قام بالإجراء
  performedById String @map("performed_by_id")

  // على من تم الإجراء
  targetUserId   String @map("target_user_id")
  targetUserName String @map("target_user_name") // حفظ الاسم للـ history

  // تفاصيل الإجراء
  action         PermissionAuditAction
  permissionCode String                @map("permission_code")
  permissionName String                @map("permission_name")

  // تفاصيل النطاق
  scope        PermissionScope?
  scopeDetails String?          @map("scope_details") // اسم الفرع/القسم/الموظفين

  // معلومات إضافية
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([performedById])
  @@index([targetUserId])
  @@index([createdAt])
  @@index([permissionCode])
  @@map("permission_audit_logs")
}

// ==================== سجل الموافقات (Audit) ====================

model ApprovalLog {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  requestType String   @map("request_type") // LEAVE, LETTER, DATA_UPDATE, RAISE
  requestId   String   @map("request_id")
  step        String // MANAGER, HR
  decision    String // APPROVED, REJECTED, DELAYED
  notes       String?  @db.VarChar(500)
  byUserId    String   @map("by_user_id")
  byUser      User     @relation(fields: [byUserId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([requestType, requestId])
  @@index([byUserId])
  @@map("approval_logs")
}

// ==================== طلبات الزيادة ====================

enum RaiseType {
  SALARY_INCREASE // زيادة راتب
  ANNUAL_LEAVE_BONUS // بدل إجازة سنوية
  BUSINESS_TRIP // رحلة عمل
  BONUS // مكافأة
  ALLOWANCE // بدل
  OTHER // أخرى
}

enum RaiseStatus {
  PENDING
  MGR_APPROVED // موافقة المدير
  MGR_REJECTED // رفض المدير
  APPROVED // موافقة نهائية (HR)
  REJECTED // رفض نهائي (HR)
  DELAYED // مؤجل
  CANCELLED
}

model RaiseRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeRaiseRequests", fields: [userId], references: [id])

  type           RaiseType
  amount         Decimal     @db.Decimal(10, 2) // المبلغ المطلوب
  effectiveMonth DateTime    @map("effective_month") @db.Date // الزيادة لشهر
  notes          String?     @db.VarChar(200) // الملاحظات (حد أقصى 200 حرف)
  attachments    Json? // مرفقات (صور/ملفات)
  status         RaiseStatus @default(PENDING)

  // ========== Workflow متعدد المراحل ==========
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId  String?          @map("manager_approver_id")
  managerApprover    User?            @relation("ManagerApproverRaiseRequests", fields: [managerApproverId], references: [id])
  managerDecision    ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt  DateTime?        @map("manager_decision_at")
  managerNotes       String?          @map("manager_notes") @db.VarChar(500)
  managerAttachments Json?            @map("manager_attachments")

  // موافقة HR
  hrApproverId    String?          @map("hr_approver_id")
  hrApprover      User?            @relation("HRApproverRaiseRequests", fields: [hrApproverId], references: [id])
  hrDecision      ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt    DateTime?        @map("hr_decision_at")
  hrDecisionNotes String?          @map("hr_decision_notes") @db.VarChar(500)
  hrAttachments   Json?            @map("hr_attachments")

  // موافقة المدير المالي (Finance)
  financeApproverId    String?          @map("finance_approver_id")
  financeApprover      User?            @relation("FinanceApproverRaiseRequests", fields: [financeApproverId], references: [id])
  financeDecision      ApprovalDecision @default(PENDING) @map("finance_decision")
  financeDecisionAt    DateTime?        @map("finance_decision_at")
  financeDecisionNotes String?          @map("finance_decision_notes") @db.VarChar(500)

  // موافقة المدير العام (CEO)
  ceoApproverId    String?          @map("ceo_approver_id")
  ceoApprover      User?            @relation("CEOApproverRaiseRequests", fields: [ceoApproverId], references: [id])
  ceoDecision      ApprovalDecision @default(PENDING) @map("ceo_decision")
  ceoDecisionAt    DateTime?        @map("ceo_decision_at")
  ceoDecisionNotes String?          @map("ceo_decision_notes") @db.VarChar(500)

  // Flexible approval chain
  approvalChain   Json?   @map("approval_chain") // ["MANAGER", "HR", "FINANCE", "CEO"]
  appliedToSalary Boolean @default(false) @map("applied_to_salary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("raise_requests")
}

// ==================== السلف (Advance Requests) ====================

enum AdvanceType {
  BANK_TRANSFER // سلفة تحويل بنكي
  CASH // سلفه نقداً
}

model AdvanceRequest {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation("EmployeeAdvanceRequests", fields: [userId], references: [id])

  // بيانات الطلب
  type             AdvanceType // نوع السلفة
  amount           Decimal     @db.Decimal(10, 2) // المبلغ المطلوب
  startDate        DateTime    @map("start_date") @db.Date // من تاريخ
  endDate          DateTime    @map("end_date") @db.Date // إلى تاريخ
  periodMonths     Int         @map("period_months") // الفترة بالشهور
  monthlyDeduction Decimal     @map("monthly_deduction") @db.Decimal(10, 2) // الاستقطاع الشهري المقترح
  notes            String?     @db.VarChar(500) // ملاحظات
  attachments      Json? // مرفقات (صور/ملفات)

  // الحالة
  status      String       @default("PENDING")
  currentStep ApprovalStep @default(MANAGER) @map("current_step")

  // موافقة المدير المباشر
  managerApproverId String?          @map("manager_approver_id")
  managerApprover   User?            @relation("ManagerApproverAdvanceRequests", fields: [managerApproverId], references: [id])
  managerDecision   ApprovalDecision @default(PENDING) @map("manager_decision")
  managerDecisionAt DateTime?        @map("manager_decision_at")
  managerNotes      String?          @map("manager_notes") @db.VarChar(500)

  // موافقة HR (مع إمكانية تعديل المبلغ والاستقطاع)
  hrApproverId             String?          @map("hr_approver_id")
  hrApprover               User?            @relation("HRApproverAdvanceRequests", fields: [hrApproverId], references: [id])
  hrDecision               ApprovalDecision @default(PENDING) @map("hr_decision")
  hrDecisionAt             DateTime?        @map("hr_decision_at")
  hrDecisionNotes          String?          @map("hr_decision_notes") @db.VarChar(500)
  approvedAmount           Decimal?         @map("approved_amount") @db.Decimal(10, 2) // المبلغ المعتمد (قد يختلف عن المطلوب)
  approvedMonthlyDeduction Decimal?         @map("approved_monthly_deduction") @db.Decimal(10, 2) // الاستقطاع المعتمد

  // موافقة المدير المالي (Finance)
  financeApproverId    String?          @map("finance_approver_id")
  financeApprover      User?            @relation("FinanceApproverAdvanceRequests", fields: [financeApproverId], references: [id])
  financeDecision      ApprovalDecision @default(PENDING) @map("finance_decision")
  financeDecisionAt    DateTime?        @map("finance_decision_at")
  financeDecisionNotes String?          @map("finance_decision_notes") @db.VarChar(500)

  // موافقة المدير العام (CEO)
  ceoApproverId    String?          @map("ceo_approver_id")
  ceoApprover      User?            @relation("CEOApproverAdvanceRequests", fields: [ceoApproverId], references: [id])
  ceoDecision      ApprovalDecision @default(PENDING) @map("ceo_decision")
  ceoDecisionAt    DateTime?        @map("ceo_decision_at")
  ceoDecisionNotes String?          @map("ceo_decision_notes") @db.VarChar(500)

  // Flexible approval chain
  approvalChain Json? @map("approval_chain") // ["MANAGER", "HR", "FINANCE", "CEO"]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // سجل المدفوعات
  payments LoanPayment[]

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("advance_requests")
}

// ==================== سداد السلف (Loan Payments) ====================
model LoanPayment {
  id        String         @id @default(uuid())
  advanceId String         @map("advance_id")
  advance   AdvanceRequest @relation(fields: [advanceId], references: [id], onDelete: Cascade)

  // تفاصيل السداد
  amount      Decimal  @db.Decimal(10, 2) // مبلغ السداد
  paymentDate DateTime @map("payment_date") @db.Date
  paymentType String   @default("SALARY_DEDUCTION") @map("payment_type") // SALARY_DEDUCTION, MANUAL, CASH

  // ربط بمسير الرواتب (إن وجد)
  payrollRunId String? @map("payroll_run_id")
  payslipId    String? @map("payslip_id")

  notes       String? @db.VarChar(500)
  createdById String? @map("created_by_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([advanceId])
  @@index([paymentDate])
  @@map("loan_payments")
}

// ==================== موديولات الرواتب الجديدة ====================

model EmployeeBankAccount {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Bank Details
  iban              String // IBAN (will be validated in service)
  accountHolderName String? @map("account_holder_name") // اسم صاحب الحساب (مطلوب لـ WPS)
  bankName          String  @map("bank_name")
  bankCode          String? @map("bank_code") // رمز البنك (مثل SABB, RJHI)
  swiftCode         String? @map("swift_code") // للتحويلات الدولية

  // Status
  isPrimary  Boolean   @default(false) @map("is_primary")
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, iban])
  @@index([userId, isPrimary])
  @@map("employee_bank_accounts")
}

// ==================== حسابات الشركة البنكية ====================

model CompanyBankAccount {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // بيانات البنك
  bankName    String  @map("bank_name")
  bankCode    String  @map("bank_code") // SABB, RJHI, NCB, etc
  iban        String
  accountName String  @map("account_name")
  swiftCode   String? @map("swift_code")

  // الحالة
  isPrimary Boolean @default(false) @map("is_primary")
  isActive  Boolean @default(true) @map("is_active")

  // بيانات WPS/MOL
  molId          String? @map("mol_id") // رقم المنشأة في وزارة العمل
  wpsParticipant String? @map("wps_participant") // رقم المشارك في WPS

  // معلومات إضافية
  accountType String  @default("CURRENT") @map("account_type") // CURRENT, SAVINGS
  currency    String  @default("SAR")
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, iban])
  @@index([companyId, isPrimary])
  @@index([companyId, isActive])
  @@map("company_bank_accounts")
}

model Contract {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contract Details
  contractNumber String?        @unique @map("contract_number")
  type           ContractType   @default(PERMANENT)
  status         ContractStatus @default(DRAFT)

  // Dates
  startDate        DateTime  @map("start_date") @db.Date
  endDate          DateTime? @map("end_date") @db.Date
  probationEndDate DateTime? @map("probation_end_date") @db.Date

  // Termination
  terminatedAt      DateTime? @map("terminated_at")
  terminationReason String?   @map("termination_reason")
  terminatedBy      String?   @map("terminated_by")

  // Renewal
  renewalCount       Int     @default(0) @map("renewal_count")
  previousContractId String? @map("previous_contract_id")

  // Salary Cycle
  salaryCycle String @default("MONTHLY") @map("salary_cycle")

  // ===== حقول الراتب - متطلبات قوى =====
  basicSalary        Decimal? @map("basic_salary") @db.Decimal(10, 2) // الراتب الأساسي
  housingAllowance   Decimal? @map("housing_allowance") @db.Decimal(10, 2) // بدل السكن
  transportAllowance Decimal? @map("transport_allowance") @db.Decimal(10, 2) // بدل المواصلات
  otherAllowances    Decimal? @map("other_allowances") @db.Decimal(10, 2) // بدلات أخرى
  totalSalary        Decimal? @map("total_salary") @db.Decimal(10, 2) // إجمالي الراتب

  // ===== بيانات العمل - متطلبات قوى =====
  contractJobTitle    String? @map("contract_job_title") // المسمى الوظيفي في العقد
  workLocation        String? @map("work_location") // مقر العمل
  workingHoursPerWeek Int     @default(48) @map("working_hours_per_week") // ساعات العمل الأسبوعية
  annualLeaveDays     Int     @default(21) @map("annual_leave_days") // أيام الإجازة السنوية
  noticePeriodDays    Int     @default(30) @map("notice_period_days") // فترة الإشعار

  // ===== التوقيعات الإلكترونية =====
  employeeSignature Boolean   @default(false) @map("employee_signature") // توقيع الموظف
  employeeSignedAt  DateTime? @map("employee_signed_at") // تاريخ توقيع الموظف
  employerSignature Boolean   @default(false) @map("employer_signature") // توقيع صاحب العمل
  employerSignedAt  DateTime? @map("employer_signed_at") // تاريخ توقيع صاحب العمل
  signedByUserId    String?   @map("signed_by_user_id") // من وقع نيابة عن صاحب العمل

  // ===== تكامل قوى =====
  qiwaContractId   String?        @unique @map("qiwa_contract_id") // رقم العقد في قوى
  qiwaStatus       QiwaAuthStatus @default(NOT_SUBMITTED) @map("qiwa_status") // حالة التوثيق
  qiwaAuthDate     DateTime?      @map("qiwa_auth_date") // تاريخ التوثيق في قوى
  qiwaRejectReason String?        @map("qiwa_reject_reason") // سبب الرفض من قوى
  qiwaLastSync     DateTime?      @map("qiwa_last_sync") // آخر مزامنة مع قوى

  // Documents
  documentUrl String? @map("document_url")

  // ===== ملاحظات وبنود إضافية =====
  additionalTerms String? @map("additional_terms") @db.Text // بنود إضافية
  notes           String? @map("notes") @db.Text // ملاحظات داخلية

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([endDate])
  @@index([qiwaStatus])
  @@map("contracts")
}

// قشرة قسيمة الراتب (سيتم إضافتها بالكامل في Step 2 لكن نحتاج الموديلات للعلاقات)

// 🔥 مصدر سطر قسيمة الراتب
enum PayslipLineSource {
  STRUCTURE // من هيكل الراتب
  POLICY // من السياسات
  MANUAL // إدخال يدوي
  ADJUSTMENT // تعديل/فرق
  STATUTORY // خصومات قانونية (GOSI, ضرائب)
  SMART // ذكاء اصطناعي (AI)
}

model PayslipLine {
  id            String            @id @default(uuid())
  payslipId     String            @map("payslip_id")
  componentId   String            @map("component_id")
  amount        Decimal           @db.Decimal(10, 2)
  createdAt     DateTime          @default(now()) @map("created_at")
  descriptionAr String?           @map("description_ar")
  rate          Decimal?          @db.Decimal(10, 4)
  sign          String            @default("EARNING")
  sourceRef     String?           @map("source_ref")
  sourceType    PayslipLineSource @default(STRUCTURE) @map("source_type")
  units         Decimal?          @db.Decimal(10, 2)
  costCenterId  String?           @map("cost_center_id")
  component     SalaryComponent   @relation(fields: [componentId], references: [id])
  costCenter    CostCenter?       @relation(fields: [costCenterId], references: [id])
  payslip       Payslip           @relation(fields: [payslipId], references: [id], onDelete: Cascade)

  @@index([payslipId, sourceType])
  @@index([payslipId, componentId])
  @@index([costCenterId])
  @@map("payslip_lines")
}

model CostCenter {
  id                                                                                   String                 @id @default(uuid())
  code                                                                                 String
  description                                                                          String?
  createdAt                                                                            DateTime               @default(now()) @map("created_at")
  updatedAt                                                                            DateTime               @updatedAt @map("updated_at")
  companyId                                                                            String?                @map("company_id")
  effective_from                                                                       DateTime               @default(now())
  effective_to                                                                         DateTime?
  is_allow_overbudget                                                                  Boolean                @default(false)
  level                                                                                Int                    @default(1)
  manager_id                                                                           String?
  name_ar                                                                              String
  name_en                                                                              String?
  parent_id                                                                            String?
  path                                                                                 String?
  status                                                                               String                 @default("ACTIVE")
  type                                                                                 String                 @default("OPERATING")
  version                                                                              Int                    @default(1)
  department_id                                                                        String?
  max_headcount                                                                        Int?
  budget_alert_threshold                                                               Decimal?               @default(80) @db.Decimal(5, 2)
  name                                                                                 String?                @db.VarChar(255)
  cost_center_allocations_cost_center_allocations_cost_center_idTocost_centers         CostCenterAllocation[] @relation("cost_center_allocations_cost_center_idTocost_centers")
  cost_center_allocations_cost_center_allocations_primary_cost_center_idTocost_centers CostCenterAllocation[] @relation("cost_center_allocations_primary_cost_center_idTocost_centers")
  company                                                                              Company?               @relation(fields: [companyId], references: [id])
  departments                                                                          Department?            @relation(fields: [department_id], references: [id])
  cost_centers                                                                         CostCenter?            @relation("cost_centersTocost_centers", fields: [parent_id], references: [id])
  other_cost_centers                                                                   CostCenter[]           @relation("cost_centersTocost_centers")
  payslip_lines                                                                        PayslipLine[]
  users                                                                                User[]

  @@unique([companyId, code, version])
  @@index([companyId, status])
  @@index([effective_from, effective_to])
  @@index([parent_id])
  @@map("cost_centers")
}

model SalaryComponent {
  id             String                @id @default(uuid())
  code           String
  nameAr         String                @map("name_ar")
  nameEn         String?               @map("name_en")
  type           SalaryComponentType
  nature         SalaryComponentNature @default(FIXED)
  description    String?
  gosiEligible   Boolean               @default(false) @map("gosi_eligible")
  otEligible     Boolean               @default(false) @map("ot_eligible")
  formula        String?
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")
  companyId      String?               @map("company_id")
  decimals       Int                   @default(2)
  effectiveDate  DateTime              @default(now()) @map("effective_date")
  endDate        DateTime?             @map("end_date")
  isActive       Boolean               @default(true) @map("is_active")
  priority       Int                   @default(100)
  roundingMode   String                @default("ROUND") @map("rounding_mode")
  taxable        Boolean               @default(false)
  version        Int                   @default(1)
  eosEligible    Boolean               @default(false) @map("eos_eligible")
  isProrated     Boolean               @default(true) @map("is_prorated")
  PayslipLine    PayslipLine[]
  policyRules    PolicyRule[]          @relation("PolicyOutputComponent")
  company        Company?              @relation(fields: [companyId], references: [id])
  structureLines SalaryStructureLine[]
  smartPolicies  SmartPolicy[]

  @@unique([companyId, type, code, version])
  @@index([companyId, isActive])
  @@index([effectiveDate, endDate])
  @@map("salary_components")
}

model SalaryStructure {
  id            String                     @id @default(uuid())
  name          String
  description   String?
  isActive      Boolean                    @default(true) @map("is_active")
  createdAt     DateTime                   @default(now()) @map("created_at")
  updatedAt     DateTime                   @updatedAt @map("updated_at")
  companyId     String?                    @map("company_id")
  effectiveDate DateTime                   @default(now()) @map("effective_date")
  endDate       DateTime?                  @map("end_date")
  version       Int                        @default(1)
  assignments   EmployeeSalaryAssignment[]
  lines         SalaryStructureLine[]
  company       Company?                   @relation(fields: [companyId], references: [id])

  @@unique([companyId, name, version])
  @@index([companyId, isActive])
  @@index([effectiveDate, endDate])
  @@map("salary_structures")
}

model SalaryStructureLine {
  id          String          @id @default(uuid())
  structureId String          @map("structure_id")
  componentId String          @map("component_id")
  amount      Decimal         @default(0) @db.Decimal(10, 2)
  percentage  Decimal?        @db.Decimal(5, 2)
  priority    Int             @default(0)
  component   SalaryComponent @relation(fields: [componentId], references: [id])
  structure   SalaryStructure @relation(fields: [structureId], references: [id], onDelete: Cascade)

  @@map("salary_structure_lines")
}

model EmployeeSalaryAssignment {
  id            String          @id @default(uuid())
  employeeId    String          @map("employee_id")
  structureId   String          @map("structure_id")
  baseSalary    Decimal         @map("base_salary") @db.Decimal(10, 2)
  effectiveDate DateTime        @map("effective_date") @db.Date
  endDate       DateTime?       @map("end_date") @db.Date
  isActive      Boolean         @default(true) @map("is_active")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  employee      User            @relation("EmployeeSalaryAssignments", fields: [employeeId], references: [id])
  structure     SalaryStructure @relation(fields: [structureId], references: [id])

  @@map("employee_salary_assignments")
}

model PayrollPeriod {
  id        String        @id @default(uuid())
  companyId String?       @map("company_id")
  company   Company?      @relation(fields: [companyId], references: [id])
  month     Int // 1-12
  year      Int
  startDate DateTime      @map("start_date") @db.Date
  endDate   DateTime      @map("end_date") @db.Date
  status    PayrollStatus @default(DRAFT)

  // Enterprise: Cut-off & Lock
  cutOffDate     DateTime? @map("cut_off_date") @db.Date // آخر يوم لتسجيل الحضور
  inputsLockedAt DateTime? @map("inputs_locked_at") // تاريخ تجميد المدخلات
  lockedAt       DateTime? @map("locked_at") // تاريخ القفل النهائي
  lockedBy       String?   @map("locked_by") // من قام بالقفل

  runs               PayrollRun[]
  payslips           Payslip[]
  disciplinaryCases  DisciplinaryCase[]
  payrollAdjustments PayrollAdjustment[]

  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  employeeDebtLedgers EmployeeDebtLedger[]

  @@unique([companyId, month, year])
  @@index([companyId, status])
  @@map("payroll_periods")
}

model PayrollRun {
  id        String        @id @default(uuid())
  companyId String?       @map("company_id")
  company   Company?      @relation(fields: [companyId], references: [id])
  periodId  String        @map("period_id")
  period    PayrollPeriod @relation(fields: [periodId], references: [id])

  runDate DateTime      @default(now()) @map("run_date")
  status  PayrollStatus @default(DRAFT)

  processedBy String? @map("processed_by")

  // 🔥 Adjustment Run Support
  isAdjustment     Boolean      @default(false) @map("is_adjustment")
  originalRunId    String?      @map("original_run_id")
  originalRun      PayrollRun?  @relation("AdjustmentRuns", fields: [originalRunId], references: [id])
  adjustmentRuns   PayrollRun[] @relation("AdjustmentRuns")
  adjustmentReason String?      @map("adjustment_reason")

  // Enterprise: Workflow Timestamps
  calculatedAt      DateTime? @map("calculated_at")
  calculatedBy      String?   @map("calculated_by")
  hrApprovedAt      DateTime? @map("hr_approved_at")
  hrApprovedBy      String?   @map("hr_approved_by")
  financeApprovedAt DateTime? @map("finance_approved_at")
  financeApprovedBy String?   @map("finance_approved_by")
  lockedAt          DateTime? @map("locked_at")
  lockedBy          String?   @map("locked_by")
  paidAt            DateTime? @map("paid_at")

  payslips         Payslip[]
  mudadSubmissions MudadSubmission[]
  wpsSubmissions   WpsSubmission[]
  ledger           PayrollLedger?

  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  payrollAdjustments PayrollAdjustment[]

  @@index([companyId, status])
  @@index([periodId])
  @@index([originalRunId])
  @@map("payroll_runs")
}

// ==================== تسويات الرواتب ====================
model PayrollAdjustment {
  id           String  @id @default(uuid())
  payrollRunId String? @map("payroll_run_id")
  employeeId   String  @map("employee_id")
  companyId    String  @map("company_id")

  // نوع التسوية
  adjustmentType String @map("adjustment_type") // WAIVE_DEDUCTION, CONVERT_TO_LEAVE, MANUAL_ADDITION, MANUAL_DEDUCTION

  // نوع الخصم الأصلي (لو كان إلغاء خصم)
  originalDeductionType String? @map("original_deduction_type") // LATE_DEDUCTION, ABSENCE_DEDUCTION, EARLY_DEPARTURE

  // المبالغ
  originalAmount Float @default(0) @map("original_amount") // المبلغ الأصلي قبل التعديل
  adjustedAmount Float @default(0) @map("adjusted_amount") // المبلغ بعد التعديل

  // تحويل لإجازة
  leaveDaysDeducted Float @default(0) @map("leave_days_deducted") // أيام الإجازة المخصومة بدل الخصم المالي

  // التفاصيل
  reason String // سبب التعديل (مطلوب)
  notes  String? // ملاحظات إضافية

  // وحدة القياس (للتوافق مع الـ database)
  unit   AdjustmentUnit @default(AMOUNT)
  value  Decimal        @default(0) @db.Decimal(10, 2) // القيمة (مطلوبة)
  amount Decimal?       @db.Decimal(10, 2) // المبلغ المحسوب

  // سير العمل والاعتماد
  status          PayrollAdjustmentStatus @default(PENDING)
  createdById     String                  @map("created_by_id")
  approvedById    String?                 @map("approved_by_id")
  approvedAt      DateTime?               @map("approved_at")
  rejectedAt      DateTime?               @map("rejected_at")
  rejectionReason String?                 @map("rejection_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payrollRun         PayrollRun?       @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee           User              @relation("EmployeeAdjustments", fields: [employeeId], references: [id])
  company            Company           @relation(fields: [companyId], references: [id])
  createdBy          User              @relation("AdjustmentCreator", fields: [createdById], references: [id])
  approvedBy         User?             @relation("AdjustmentApprover", fields: [approvedById], references: [id])
  payrollPeriod      PayrollPeriod?    @relation(fields: [payrollPeriodId], references: [id])
  payrollPeriodId    String?           @map("payroll_period_id")
  disciplinaryCase   DisciplinaryCase? @relation(fields: [disciplinaryCaseId], references: [id])
  disciplinaryCaseId String?           @map("disciplinary_case_id")

  // Legacy case_id field - now optional for instant adjustments
  caseId String? @map("case_id")

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([payrollRunId])
  @@index([employeeId])
  @@index([companyId, status])
  @@map("payroll_adjustments")
}

model Payslip {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  company    Company? @relation(fields: [companyId], references: [id])
  employeeId String   @map("employee_id")
  employee   User     @relation(fields: [employeeId], references: [id])

  periodId String        @map("period_id")
  period   PayrollPeriod @relation(fields: [periodId], references: [id])

  runId String?     @map("run_id")
  run   PayrollRun? @relation(fields: [runId], references: [id])

  baseSalary      Decimal @map("base_salary") @db.Decimal(10, 2)
  grossSalary     Decimal @map("gross_salary") @db.Decimal(10, 2)
  totalDeductions Decimal @map("total_deductions") @db.Decimal(10, 2)
  netSalary       Decimal @map("net_salary") @db.Decimal(10, 2)

  status PayrollStatus @default(DRAFT)

  lines            PayslipLine[]
  calculationTrace Json?         @map("calculation_trace")

  // ✅ بيانات المعاينة المحفوظة - لعرض نفس البنود في تفاصيل القسيمة
  earningsJson   Json? @map("earnings_json") // [{name, code, amount}]
  deductionsJson Json? @map("deductions_json") // [{name, code, amount}]

  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  employeeTerminations EmployeeTermination[]

  @@map("payslips")
}

model GosiConfig {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  // Version Control
  version       Int       @default(1)
  effectiveDate DateTime  @default(now()) @map("effective_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date

  // Contribution Rates
  employeeRate Decimal @map("employee_rate") @db.Decimal(5, 2) // e.g., 9.00%
  employerRate Decimal @map("employer_rate") @db.Decimal(5, 2) // e.g., 9.00%
  sanedRate    Decimal @map("saned_rate") @db.Decimal(5, 2) // e.g., 0.75%
  hazardRate   Decimal @map("hazard_rate") @db.Decimal(5, 2) // e.g., 2.00%

  // Wage Caps
  maxCapAmount  Decimal @default(45000) @map("max_cap_amount") @db.Decimal(10, 2)
  minBaseSalary Decimal @default(0) @map("min_base_salary") @db.Decimal(10, 2)

  // Settings
  isSaudiOnly       Boolean @default(true) @map("is_saudi_only")
  includeAllowances Boolean @default(false) @map("include_allowances") // هل تشمل البدلات
  isActive          Boolean @default(true) @map("is_active")
  notes             String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, version])
  @@index([companyId, isActive])
  @@index([effectiveDate, endDate])
  @@map("gosi_configs")
}

// ==================== Retro Pay (الفروقات) ====================
enum RetroPayStatus {
  PENDING // في الانتظار
  APPROVED // معتمد
  PAID // مدفوع
  CANCELLED // ملغي
}

model RetroPay {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  company    Company? @relation(fields: [companyId], references: [id])
  employeeId String   @map("employee_id")
  employee   User     @relation(fields: [employeeId], references: [id])

  reason        String // سبب الفرق (زيادة راتب، تصحيح خطأ، إلخ)
  effectiveFrom DateTime @map("effective_from") // تاريخ بداية الفرق
  effectiveTo   DateTime @map("effective_to") // تاريخ نهاية الفرق

  // 🆕 شهر الصرف - الشهر اللي هينزل فيه الفرق في المسير
  paymentMonth Int? @map("payment_month") // 1-12
  paymentYear  Int? @map("payment_year") // السنة (مثال: 2026)

  oldAmount  Decimal @map("old_amount") @db.Decimal(10, 2)
  newAmount  Decimal @map("new_amount") @db.Decimal(10, 2)
  difference Decimal @db.Decimal(10, 2) // الفرق = new - old

  monthsCount Int     @map("months_count") // عدد الأشهر المتأثرة
  totalAmount Decimal @map("total_amount") @db.Decimal(10, 2) // الإجمالي = difference * months

  status RetroPayStatus @default(PENDING)
  notes  String?

  createdById  String?   @map("created_by_id")
  approvedById String?   @map("approved_by_id")
  approvedAt   DateTime? @map("approved_at")
  paidAt       DateTime? @map("paid_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, employeeId, paymentYear, paymentMonth])
  @@map("retro_pays")
}

// ==================== Policy Engine ====================
enum PolicyType {
  OVERTIME // سياسة الوقت الإضافي
  LEAVE // سياسة الإجازات
  DEDUCTION // سياسة الاستقطاعات  
  ALLOWANCE // سياسة البدلات
  ATTENDANCE // سياسة الحضور والانصراف
  GENERAL // سياسة عامة
}

enum PolicyScope {
  COMPANY // على مستوى الشركة = rank 1
  BRANCH // على مستوى الفرع = rank 2
  DEPARTMENT // على مستوى القسم = rank 3
  JOB_TITLE // على مستوى الدرجة الوظيفية = rank 4
  EMPLOYEE // على مستوى الموظف = rank 5
}

// نوع الناتج من قاعدة السياسة
enum OutputSign {
  EARNING // إضافة/استحقاق
  DEDUCTION // خصم/استقطاع
}

model Policy {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  code        String
  nameAr      String   @map("name_ar")
  nameEn      String?  @map("name_en")
  description String?

  type  PolicyType
  scope PolicyScope @default(COMPANY)

  // التاريخ الفعال
  effectiveFrom DateTime  @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  // الربط بالنطاق (حسب scope)
  branchId     String? @map("branch_id")
  departmentId String? @map("department_id")
  jobTitleId   String? @map("job_title_id")
  employeeId   String? @map("employee_id")

  // الإعدادات (JSON مرنة)
  settings Json @default("{}")

  isActive  Boolean @default(true) @map("is_active")
  priority  Int     @default(0) // أولوية التطبيق (الأعلى يُطبق أولاً)
  scopeRank Int     @default(1) @map("scope_rank") // COMPANY=1, BRANCH=2, DEPARTMENT=3, JOB_TITLE=4, EMPLOYEE=5

  rules PolicyRule[]

  // Relations for scope targets
  branch         Branch?     @relation(fields: [branchId], references: [id])
  department     Department? @relation(fields: [departmentId], references: [id])
  jobTitle       JobTitle?   @relation(fields: [jobTitleId], references: [id])
  targetEmployee User?       @relation("PolicyTargetEmployee", fields: [employeeId], references: [id])

  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@index([companyId, type, scope, effectiveFrom])
  @@index([type, scope, isActive])
  @@index([effectiveFrom, effectiveTo])
  @@index([branchId])
  @@index([departmentId])
  @@index([jobTitleId])
  @@index([employeeId])
  @@map("policies")
}

model PolicyRule {
  id       String @id @default(uuid())
  policyId String @map("policy_id")
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  code   String // مثال: OT_WEEKDAY, OT_WEEKEND, LATE_PENALTY
  nameAr String @map("name_ar")

  // شروط التطبيق (JSON)
  conditions Json @default("{}")

  // القيمة/النتيجة
  valueType String @map("value_type") // PERCENTAGE, FIXED, FORMULA
  value     String // القيمة أو المعادلة

  // 🔥 مكوّن الناتج - أين تُسجَّل نتيجة هذه القاعدة في قسيمة الراتب
  outputComponentId String?          @map("output_component_id")
  outputComponent   SalaryComponent? @relation("PolicyOutputComponent", fields: [outputComponentId], references: [id])
  outputSign        OutputSign       @default(EARNING) @map("output_sign")

  // ترتيب التطبيق (الأقل→ يُنفذ أولاً)
  ruleOrder Int     @default(0) @map("rule_order")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([policyId, code])
  @@index([policyId, isActive, ruleOrder])
  @@index([outputComponentId])
  @@map("policy_rules")
}

// ==================== السياسات الذكية (AI-Powered Policies) ====================

// نوع الحدث المُفعِّل
enum SmartPolicyTrigger {
  ATTENDANCE // حضور، انصراف، تأخير، غياب
  LEAVE // طلب إجازة، موافقة، رفض
  CUSTODY // تسليم عهدة، إرجاع عهدة
  PAYROLL // حساب الرواتب الشهري
  ANNIVERSARY // ذكرى توظيف
  CONTRACT // بداية/نهاية عقد
  DISCIPLINARY // مخالفة، تحقيق
  PERFORMANCE // أداء
  CUSTOM // أي حدث آخر
}

// حالة السياسة الذكية
enum SmartPolicyStatus {
  DRAFT // مسودة (لم تُراجع بعد)
  PENDING // بانتظار الموافقة
  ACTIVE // مفعّلة
  PAUSED // موقوفة مؤقتاً
  ARCHIVED // مؤرشفة
}

// نوع الإجراء
enum SmartPolicyActionType {
  ADD_TO_PAYROLL // إضافة مبلغ للراتب
  DEDUCT_FROM_PAYROLL // خصم من الراتب
  SEND_NOTIFICATION // إرسال إشعار
  ALERT_HR // تنبيه الموارد البشرية
  CREATE_RECORD // إنشاء سجل
}

model SmartPolicy {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // النص الأصلي (ما كتبه المستخدم بالعربي/العامية)
  originalText String @map("original_text") @db.Text

  // اسم السياسة (اختياري - يُستخرج من الـ AI أو يُدخله المستخدم)
  name        String?
  description String? @db.Text

  // الحدث المُفعِّل
  triggerEvent    SmartPolicyTrigger @map("trigger_event")
  triggerSubEvent String?            @map("trigger_sub_event") // مثال: RETURNED, APPROVED

  // القاعدة المحللة بالذكاء الاصطناعي (JSON كامل)
  parsedRule Json @map("parsed_rule")

  // الشروط المحللة (للبحث السريع)
  conditions Json @default("[]")

  // الإجراءات المحللة
  actions Json @default("[]")

  // === Issue #21: AND/OR Logic Support ===
  conditionLogic String @default("ALL") @map("condition_logic")

  // النطاق: لمن تُطبق السياسة
  scopeType String  @default("ALL") @map("scope_type") // ALL, EMPLOYEE, DEPARTMENT, BRANCH, JOB_TITLE
  scopeId   String? @map("scope_id") // معرف الهدف (إن وُجد)
  scopeName String? @map("scope_name") // اسم الهدف (للعرض)

  // الحالة والتفعيل
  status   SmartPolicyStatus @default(DRAFT)
  isActive Boolean           @default(false) @map("is_active")

  // الأولوية (الأعلى تُنفذ أولاً)
  priority       Int @default(0)
  executionOrder Int @default(0) @map("execution_order")

  // تاريخ الصلاحية
  effectiveFrom DateTime? @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  // شرح الـ AI للقاعدة (بالعربي)
  aiExplanation String? @map("ai_explanation") @db.Text

  // هل الـ AI طلب توضيح؟
  clarificationNeeded String? @map("clarification_needed") @db.Text

  // إحصائيات التنفيذ
  executionCount    Int       @default(0) @map("execution_count")
  lastExecutedAt    DateTime? @map("last_executed_at")
  totalAmountPaid   Decimal   @default(0) @map("total_amount_paid") @db.Decimal(12, 2)
  totalAmountDeduct Decimal   @default(0) @map("total_amount_deduct") @db.Decimal(12, 2)

  // من أنشأها وراجعها
  createdById  String?   @map("created_by_id")
  approvedById String?   @map("approved_by_id")
  approvedAt   DateTime? @map("approved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // سجل التنفيذات
  executions SmartPolicyExecution[]

  // Restored Relations
  analytics          SmartPolicyAnalytics[]
  approvals          SmartPolicyApproval[]
  exceptions         SmartPolicyException[]
  occurrenceTrackers SmartPolicyOccurrenceTracker[]
  retroApplications  SmartPolicyRetroApplication[]
  versions           SmartPolicyVersion[]
  simulationRuns     PolicySimulationRun[]

  // 🔗 مكون الراتب المستهدف (للإضافة أو الخصم)
  targetComponentId String?          @map("target_component_id")
  targetComponent   SalaryComponent? @relation(fields: [targetComponentId], references: [id])

  @@index([companyId, status, isActive])
  @@index([companyId, triggerEvent])
  @@index([status, isActive])
  @@map("smart_policies")
}

// سجل تنفيذ السياسة الذكية
model SmartPolicyExecution {
  id       String      @id @default(uuid())
  policyId String      @map("policy_id")
  policy   SmartPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // الموظف المتأثر
  employeeId   String @map("employee_id")
  employeeName String @map("employee_name")

  // الحدث الذي أطلق التنفيذ
  triggerEvent    String  @map("trigger_event")
  triggerSubEvent String? @map("trigger_sub_event")
  triggerData     Json?   @map("trigger_data") // بيانات الحدث (مثل: تاريخ إرجاع العهدة)

  // نتيجة فحص الشروط
  conditionsMet Boolean @map("conditions_met")
  conditionsLog Json?   @map("conditions_log") // تفاصيل فحص كل شرط

  // الإجراء المُنفذ
  actionType   String?  @map("action_type") // ADD_TO_PAYROLL, DEDUCT_FROM_PAYROLL, etc.
  actionValue  Decimal? @map("action_value") @db.Decimal(10, 2)
  actionResult Json?    @map("action_result") // نتيجة الإجراء

  // هل نجح التنفيذ؟
  isSuccess    Boolean @map("is_success")
  errorMessage String? @map("error_message") @db.Text

  // ربط بالراتب (إن وُجد)
  payrollPeriod String? @map("payroll_period") // YYYY-MM

  executedAt DateTime @default(now()) @map("executed_at")

  @@index([policyId, executedAt])
  @@index([employeeId, executedAt])
  @@index([triggerEvent])
  @@map("smart_policy_executions")
}

model SmartPolicyAnalytics {
  id               String      @id @default(uuid())
  policyId         String      @map("policy_id")
  totalTriggered   Int         @default(0) @map("total_triggered")
  conditionsMet    Int         @default(0) @map("conditions_met")
  totalAdditions   Decimal     @default(0) @map("total_additions") @db.Decimal(12, 2)
  totalDeductions  Decimal     @default(0) @map("total_deductions") @db.Decimal(12, 2)
  lastCalculated   DateTime    @default(now()) @map("last_calculated")
  totalEmployees   Int         @default(0) @map("total_employees")
  avgExecutionTime Int?        @map("avg_execution_time")
  smartPolicy      SmartPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@map("smart_policy_analytics")
}

model SmartPolicyApproval {
  id             String                @id @default(uuid())
  policyId       String                @map("policy_id")
  requestedBy    String?               @map("requested_by")
  requestedAt    DateTime              @default(now()) @map("requested_at")
  status         SmartPolicyStatus     @default(PENDING)
  approvedBy     String?               @map("approved_by")
  actionAt       DateTime?             @map("action_at")
  action         PolicyApprovalAction?
  comments       String?
  proposedChange Json?                 @map("proposed_change")
  smartPolicy    SmartPolicy           @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@map("smart_policy_approvals")
}

model SmartPolicyException {
  id        String @id @default(uuid())
  policyId  String @map("policy_id")
  companyId String @map("company_id")

  // Target Information (Enhanced - supports Employee, Department, Branch, Job Title)
  targetType String  @default("EMPLOYEE") @map("target_type")
  targetId   String  @map("target_id")
  targetName String? @map("target_name")

  // Exception Details
  reason        String?   @map("reason")
  exceptionFrom DateTime? @map("exception_from")
  exceptionTo   DateTime? @map("exception_to")
  isActive      Boolean   @default(true) @map("is_active")

  // Audit
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  smartPolicy SmartPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([policyId, targetType, targetId])
  @@index([policyId])
  @@index([targetId])
  @@index([isActive])
  @@map("smart_policy_exceptions")
}

model SmartPolicyOccurrenceTracker {
  id               String                @id @default(uuid())
  policyId         String                @map("policy_id")
  employeeId       String                @map("employee_id")
  occurrenceCount  Int                   @default(0) @map("occurrence_count")
  lastOccurrence   DateTime?             @map("last_occurrence")
  resetPeriod      OccurrenceResetPeriod @default(NEVER) @map("reset_period")
  nextResetDate    DateTime?             @map("next_reset_date")
  totalImpactValue Decimal               @default(0) @map("total_impact_value") @db.Decimal(12, 2)
  companyId        String                @map("company_id")
  smartPolicy      SmartPolicy           @relation(fields: [policyId], references: [id], onDelete: Cascade)
  company          Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user             User                  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([policyId, employeeId])
  @@map("smart_policy_occurrence_trackers")
}

model SmartPolicyRetroApplication {
  id             String                 @id @default(uuid())
  policyId       String                 @map("policy_id")
  employeeId     String                 @map("employee_id")
  period         String                 @map("period")
  status         RetroApplicationStatus @default(PENDING)
  originalAmount Decimal                @map("original_amount") @db.Decimal(12, 2)
  newAmount      Decimal                @map("new_amount") @db.Decimal(12, 2)
  difference     Decimal                @db.Decimal(12, 2)
  appliedBy      String?                @map("applied_by")
  appliedAt      DateTime?              @map("applied_at")
  companyId      String                 @map("company_id")
  smartPolicy    SmartPolicy            @relation(fields: [policyId], references: [id], onDelete: Cascade)
  company        Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user           User                   @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([policyId, period])
  @@map("smart_policy_retro_applications")
}

model SmartPolicyTemplate {
  id               String              @id
  name             String?             @map("name")
  nameEn           String?             @map("name_en")
  triggerEvent     SmartPolicyTrigger? @map("trigger_event")
  category         String
  description      String?             @map("description") @db.Text
  originalText     String?             @map("original_text") @db.Text
  parsedRule       Json?               @map("parsed_rule")
  recommendedFor   String?             @map("recommended_for")
  legalCompliance  Json?               @map("legal_compliance")
  laborLawArticles Json?               @map("labor_law_articles")
  isPublic         Boolean             @default(true) @map("is_public")
  rating           Decimal?            @default(0) @db.Decimal(3, 1)
  ratingCount      Int                 @default(0) @map("rating_count")
  usageCount       Int                 @default(0) @map("usage_count")
  isActive         Boolean             @default(true) @map("is_active")
  isSystemTemplate Boolean             @default(false) @map("is_system_template")
  companyId        String?             @map("company_id")
  company          Company?            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime            @default(now()) @map("created_at")

  @@map("smart_policy_templates")
}

model SmartPolicyVersion {
  id            String      @id @default(uuid())
  policyId      String      @map("policy_id")
  versionNumber Int         @map("version_number")
  ruleSnapshot  Json        @map("rule_snapshot")
  createdBy     String      @map("created_by")
  createdAt     DateTime    @default(now()) @map("created_at")
  changeLog     String?     @map("change_log")
  smartPolicy   SmartPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, versionNumber])
  @@map("smart_policy_versions")
}

model PolicySimulationRun {
  id                     String      @id @default(uuid())
  policyId               String      @map("policy_id")
  simulatedBy            String      @map("simulated_by")
  simulatedByName        String      @map("simulated_by_name")
  simulationPeriod       String      @map("simulation_period")
  totalEmployeesAffected Int         @map("total_employees_affected")
  totalAdditions         Decimal     @default(0) @map("total_additions") @db.Decimal(12, 2)
  totalDeductions        Decimal     @default(0) @map("total_deductions") @db.Decimal(12, 2)
  results                Json        @default("[]")
  executionTimeMs        Int?        @map("execution_time_ms")
  warningsCount          Int         @default(0) @map("warnings_count")
  warnings               Json?       @default("[]")
  createdAt              DateTime    @default(now()) @map("created_at")
  startDate              DateTime?   @default(now()) @map("start_date") @db.Timestamp(6)
  endDate                DateTime?   @default(now()) @map("end_date") @db.Timestamp(6)
  companyId              String?     @map("company_id")
  smartPolicy            SmartPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  company                Company?    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([policyId, createdAt])
  @@map("policy_simulation_runs")
}

// ==================== Government Compliance Tracking ====================

// مُدد - Mudad Salary Protection Submissions
model MudadSubmission {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Reference to payroll run
  payrollRunId String     @map("payroll_run_id")
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id])

  // Submission Details
  period         String // YYYY-MM format
  submissionType String @default("SALARY") @map("submission_type") // SALARY, BONUS, EOS

  // Status Tracking
  status     MudadStatus @default(PENDING)
  wpsFileUrl String?     @map("wps_file_url") // رابط ملف WPS المرفوع
  mudadRef   String?     @map("mudad_ref") // رقم مرجع مُدد (من المنصة)

  // Amounts
  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  employeeCount Int     @map("employee_count")

  // Submission Workflow
  preparedAt    DateTime? @map("prepared_at")
  preparedBy    String?   @map("prepared_by")
  submittedAt   DateTime? @map("submitted_at")
  submittedBy   String?   @map("submitted_by")
  acceptedAt    DateTime? @map("accepted_at")
  rejectedAt    DateTime? @map("rejected_at")
  rejectionNote String?   @map("rejection_note")

  // File Integrity (للتدقيق)
  fileHashSha256   String? @map("file_hash_sha256") @db.VarChar(64)
  fileSize         Int?    @map("file_size")
  generatorVersion String? @map("generator_version")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([payrollRunId, submissionType])
  @@index([companyId, period])
  @@index([status])
  @@map("mudad_submissions")
}

enum MudadStatus {
  PENDING // في انتظار التحضير
  PREPARED // تم تحضير الملف
  SUBMITTED // تم الرفع على مُدد
  ACCEPTED // مقبول
  REJECTED // مرفوض
  RESUBMITTED // تم إعادة الرفع
  RESUBMIT_REQUIRED // يتطلب إعادة رفع (تغير الملف)
}

// WPS File Submissions (تتبع ملفات WPS المرفوعة)
model WpsSubmission {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Reference
  payrollRunId String     @map("payroll_run_id")
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id])

  // File Details
  filename   String
  fileFormat String  @default("WPS") @map("file_format") // WPS, SARIE
  fileUrl    String? @map("file_url")

  // Amounts
  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  employeeCount Int     @map("employee_count")

  // Status
  status   WpsStatus @default(GENERATED)
  bankName String?   @map("bank_name") // البنك المستلم
  bankRef  String?   @map("bank_ref") // رقم مرجع البنك

  // Workflow
  generatedAt  DateTime  @default(now()) @map("generated_at")
  generatedBy  String?   @map("generated_by")
  downloadedAt DateTime? @map("downloaded_at")
  downloadedBy String?   @map("downloaded_by")
  submittedAt  DateTime? @map("submitted_at") // تم الرفع للبنك
  submittedBy  String?   @map("submitted_by") // من قام بالرفع
  processedAt  DateTime? @map("processed_at") // تم التحويل

  // Attachments (receipts from bank)
  attachmentUrl String? @map("attachment_url") // إيصال البنك أو مستند التأكيد

  // File Integrity (للتدقيق)
  fileHashSha256   String? @map("file_hash_sha256") @db.VarChar(64)
  generatorVersion String? @map("generator_version")

  // Notes & Errors
  notes  String? @db.Text
  errors Json? // أخطاء التحقق

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([payrollRunId])
  @@map("wps_submissions")
}

enum WpsStatus {
  GENERATED // تم إنشاء الملف
  DOWNLOADED // تم تحميل الملف
  SUBMITTED // تم الرفع للبنك
  PROCESSING // قيد المعالجة
  PROCESSED // تم التحويل
  FAILED // فشل
}

// ==================== Module enum for Audit ====================
enum AuditModule {
  AUTH // تسجيل الدخول
  USER // إدارة الموظفين
  PAYROLL // الرواتب
  PAYSLIP // قسائم الرواتب
  BANK_ACCOUNT // الحسابات البنكية
  SALARY // هياكل الرواتب
  LEAVE // الإجازات
  ATTENDANCE // الحضور والانصراف
  ADVANCE // السلف
  GOSI // التأمينات
  EOS // نهاية الخدمة
  PERMISSION // الصلاحيات
  POLICY // السياسات
  RETRO_PAY // الفروقات
  LETTER // الخطابات
  SETTINGS // الإعدادات
  MUDAD // مُدد
  WPS // حماية الأجور
  CONTRACT // العقود
  DISCIPLINARY // الجزاءات
}

// ==================== موديول الجزاءات والتحقيقات ====================

enum DisciplinaryStage {
  MANAGER_REQUEST
  HR_INITIAL_REVIEW
  EMPLOYEE_INFORMAL_RESPONSE
  OFFICIAL_INVESTIGATION
  DECISION
  OBJECTION
  FINAL
}

enum DisciplinaryStatus {
  SUBMITTED_TO_HR
  HR_REJECTED
  HR_INFORMAL_SENT
  AWAITING_EMPLOYEE_INFORMAL
  EMPLOYEE_REJECTED_INFORMAL
  OFFICIAL_INVESTIGATION_OPENED
  HEARING_SCHEDULED
  INVESTIGATION_IN_PROGRESS
  AWAITING_HR_DECISION
  DECISION_ISSUED
  AWAITING_EMPLOYEE_ACK
  EMPLOYEE_OBJECTED
  HR_REVIEWING_OBJECTION
  FINALIZED_APPROVED
  FINALIZED_CANCELLED
  FINALIZED_CONTINUE_INVESTIGATION
}

enum DecisionType {
  NO_VIOLATION
  NOTICE
  WARNING
  FIRST_WARNING
  SECOND_WARNING
  FINAL_WARNING_TERMINATION
  FINAL_TERMINATION_ART80
  PROMOTION_DELAY
  SALARY_DEDUCTION
  SUSPENSION_WITH_PAY
  SUSPENSION_WITHOUT_PAY
}

enum PayrollAdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
  APPLIED
  POSTED
  REVERSED
  CANCELLED
}

enum AdjustmentUnit {
  DAYS
  HOURS
  AMOUNT
}

enum CaseEventType {
  CASE_CREATED
  HR_INITIAL_REVIEW
  INFORMAL_ACTION_SENT
  EMPLOYEE_INFORMAL_RESPONSE
  OFFICIAL_INVESTIGATION_OPENED
  HEARING_SCHEDULED
  MINUTES_UPLOADED
  DECISION_ISSUED
  EMPLOYEE_ACKNOWLEDGED
  EMPLOYEE_OBJECTED
  OBJECTION_REVIEWED
  FINALIZED
  CANCELLED
}

enum DeductionBasePolicy {
  BASIC_ONLY
  BASIC_FIXED
  GROSS
}

model CompanyDisciplinaryPolicy {
  id        String  @id @default(uuid())
  companyId String  @unique @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  incidentMaxAgeDays           Int                 @default(30) @map("incident_max_age_days")
  decisionDeadlineDays         Int                 @default(30) @map("decision_deadline_days")
  objectionWindowDays          Int                 @default(15) @map("objection_window_days")
  allowRetrospectiveIncidents  Boolean             @default(false) @map("allow_retrospective_incidents")
  autoApplyToOpenPayrollPeriod Boolean             @default(true) @map("auto_apply_to_open_payroll_period")
  deductionBasePolicy          DeductionBasePolicy @default(BASIC_FIXED) @map("deduction_base_policy")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("company_disciplinary_policies")
}

model DisciplinaryCase {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])
  caseCode  String  @map("case_code") // e.g., INV-2025-001

  employeeId String @map("employee_id")
  employee   User   @relation("EmployeeDisciplinaryCases", fields: [employeeId], references: [id])

  managerId String @map("manager_id")
  manager   User   @relation("ManagerCreatedCases", fields: [managerId], references: [id])

  title            String
  violationType    String?  @map("violation_type") // نوع المخالفة
  incidentDate     DateTime @map("incident_date")
  incidentLocation String   @map("incident_location")
  involvedParties  Json?    @map("involved_parties")
  description      String   @db.Text

  status DisciplinaryStatus @default(SUBMITTED_TO_HR)
  stage  DisciplinaryStage  @default(MANAGER_REQUEST)

  // Policy Snapshots
  incidentMaxAgeDaysSnapshot   Int                 @map("incident_max_age_days_snapshot")
  decisionDeadlineDaysSnapshot Int                 @map("decision_deadline_days_snapshot")
  objectionWindowDaysSnapshot  Int                 @map("objection_window_days_snapshot")
  allowRetrospectiveSnapshot   Boolean             @map("allow_retrospective_snapshot")
  deductionBasePolicySnapshot  DeductionBasePolicy @map("deduction_base_policy_snapshot")

  // Retrospective metadata
  isRetrospective     Boolean @default(false) @map("is_retrospective")
  retrospectiveReason String? @map("retrospective_reason") @db.Text

  // HR Review
  hrInitialAction String? @map("hr_initial_action")
  hrInitialReason String? @map("hr_initial_reason") @db.Text

  // Official Investigation
  officialInvestigationOpenedAt DateTime? @map("official_investigation_opened_at")
  hearingDatetime               DateTime? @map("hearing_datetime")
  hearingLocation               String?   @map("hearing_location")

  // Decision
  decisionType      DecisionType? @map("decision_type")
  decisionReason    String?       @map("decision_reason") @db.Text
  decisionCreatedAt DateTime?     @map("decision_created_at")

  // Penalty metadata (for SalDeduction or Suspension)
  penaltyUnit          AdjustmentUnit? @map("penalty_unit")
  penaltyValue         Decimal?        @map("penalty_value") @db.Decimal(10, 2)
  penaltyEffectiveDate DateTime?       @map("penalty_effective_date") @db.Date

  // Payroll Integration
  payrollPeriodId String?        @map("payroll_period_id")
  payrollPeriod   PayrollPeriod? @relation(fields: [payrollPeriodId], references: [id])

  // Employee Response
  employeeAckStatus String?   @map("employee_ack_status") // ACCEPTED, REJECTED
  employeeAckAt     DateTime? @map("employee_ack_at")

  // Objection
  objectionText        String?   @map("objection_text") @db.Text
  objectionSubmittedAt DateTime? @map("objection_submitted_at")

  // HR Post-Objection
  hrAfterObjectionAction String? @map("hr_after_objection_action")
  hrAfterObjectionReason String? @map("hr_after_objection_reason") @db.Text

  finalizedAt DateTime? @map("finalized_at")
  legalHold   Boolean   @default(false) @map("legal_hold")

  // Relationships
  events      CaseEvent[]
  attachments CaseAttachment[]
  minutes     CaseMinute[]
  records     EmployeeDisciplinaryRecord[]
  adjustments PayrollAdjustment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, caseCode])
  @@index([companyId, status])
  @@index([employeeId])
  @@index([companyId, employeeId])
  @@map("disciplinary_cases")
}

model CaseEvent {
  id     String           @id @default(uuid())
  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  actorUserId String?       @map("actor_user_id")
  eventType   CaseEventType @map("event_type")
  message     String?       @db.Text
  metadata    Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([caseId, createdAt])
  @@map("case_events")
}

model CaseAttachment {
  id     String           @id @default(uuid())
  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  uploaderUserId String @map("uploader_user_id")
  fileUrl        String @map("file_url")
  fileName       String @map("file_name")
  fileType       String @map("file_type")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("case_attachments")
}

model CaseMinute {
  id     String           @id @default(uuid())
  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  sessionNo      Int     @map("session_no")
  minutesText    String? @map("minutes_text") @db.Text
  minutesFileUrl String? @map("minutes_file_url")

  createdByHrId String   @map("created_by_hr_id")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("case_minutes")
}

model EmployeeDisciplinaryRecord {
  id         String @id @default(uuid())
  employeeId String @map("employee_id")
  employee   User   @relation(fields: [employeeId], references: [id])

  caseId String           @map("case_id")
  case   DisciplinaryCase @relation(fields: [caseId], references: [id])

  decisionType    DecisionType @map("decision_type")
  reason          String?      @db.Text
  effectiveDate   DateTime     @map("effective_date")
  penaltyMetadata Json?        @map("penalty_metadata")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("employee_disciplinary_records")
}

// ==================== Compliance: Status Change Audit Trail ====================

enum SubmissionEntityType {
  MUDAD
  WPS
  QIWA
}

// سجل تغيير الحالة (Audit Trail) - لكل تغيير status
model SubmissionStatusLog {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Reference to entity
  entityType SubmissionEntityType @map("entity_type")
  entityId   String               @map("entity_id")

  // Status change
  fromStatus String? @map("from_status") // null for initial creation
  toStatus   String  @map("to_status")

  // Actor
  changedByUserId String   @map("changed_by_user_id")
  changedAt       DateTime @default(now()) @map("changed_at")

  // Context
  reason      String? // سبب التغيير (اختياري)
  externalRef String? @map("external_ref") // مرجع خارجي إن وجد
  meta        Json? // بيانات إضافية

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId, entityType, entityId])
  @@index([changedAt])
  @@map("submission_status_logs")
}

// ==================== إعدادات سلاسل الموافقات ====================

enum ApprovalRequestType {
  LEAVE
  ADVANCE
  RAISE
  PAYROLL
  WPS
}

model ApprovalChainConfig {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // نوع الطلب
  requestType ApprovalRequestType @map("request_type")

  // شروط التطبيق (Threshold)
  minAmount Decimal? @map("min_amount") @db.Decimal(12, 2) // الحد الأدنى للمبلغ
  maxAmount Decimal? @map("max_amount") @db.Decimal(12, 2) // الحد الأقصى للمبلغ
  minDays   Int?     @map("min_days") // الحد الأدنى للأيام (للإجازات)
  maxDays   Int?     @map("max_days") // الحد الأقصى للأيام

  // سلسلة الموافقات (مرتبة)
  chain Json // ["MANAGER", "HR", "FINANCE", "CEO"]

  // الإعدادات
  name        String  @db.VarChar(100) // اسم السلسلة
  description String? @db.VarChar(500)
  priority    Int     @default(0) // الأولوية (الأعلى أولاً)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, requestType, isActive])
  @@map("approval_chain_configs")
}

// ==================== سيستم العهد (Custody Management System) ====================

// ==================== فئات العهد ====================
model CustodyCategory {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  name        String // اسم الفئة
  nameEn      String? @map("name_en")
  description String? // الوصف
  icon        String? // أيقونة للعرض

  // إعدادات الفئة
  requiresApproval     Boolean @default(true) @map("requires_approval")
  requiresSerialNumber Boolean @default(true) @map("requires_serial_number")
  depreciationYears    Int?    @map("depreciation_years") // سنوات الإهلاك

  isActive Boolean @default(true) @map("is_active")

  items CustodyItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, name])
  @@map("custody_categories")
}

// ==================== حالات العهدة ====================
enum CustodyItemStatus {
  AVAILABLE // متاحة للتسليم
  ASSIGNED // مسلمة لموظف
  IN_MAINTENANCE // في الصيانة
  LOST // مفقودة
  DAMAGED // تالفة
  DISPOSED // مستبعدة
  RESERVED // محجوزة
}

// ==================== حالة العهدة ====================
enum CustodyCondition {
  NEW // جديدة
  EXCELLENT // ممتازة
  GOOD // جيدة
  FAIR // مقبولة
  POOR // سيئة
}

// ==================== العهدة/الأصل ====================
model CustodyItem {
  id         String          @id @default(uuid())
  companyId  String          @map("company_id")
  company    Company         @relation(fields: [companyId], references: [id])
  categoryId String          @map("category_id")
  category   CustodyCategory @relation(fields: [categoryId], references: [id])

  // بيانات العهدة الأساسية
  code        String // كود العهدة (فريد داخل الشركة)
  name        String // اسم العهدة
  nameEn      String? @map("name_en")
  description String?

  // بيانات التعريف
  serialNumber String? @map("serial_number")
  model        String? // الموديل
  brand        String? // العلامة التجارية
  barcode      String? // باركود
  qrCode       String? @map("qr_code") // QR Code URL

  // بيانات الشراء
  purchaseDate   DateTime? @map("purchase_date")
  purchasePrice  Decimal?  @map("purchase_price") @db.Decimal(12, 2)
  warrantyExpiry DateTime? @map("warranty_expiry")
  vendor         String? // المورد
  invoiceNumber  String?   @map("invoice_number")

  // الحالة والموقع
  status          CustodyItemStatus @default(AVAILABLE)
  condition       CustodyCondition  @default(NEW)
  currentLocation String?           @map("current_location") // الموقع الحالي
  notes           String?

  // صورة العهدة
  imageUrl    String? @map("image_url")
  attachments Json?   @default("[]") // مرفقات إضافية

  // تتبع الفرع
  branchId String? @map("branch_id")
  branch   Branch? @relation(fields: [branchId], references: [id])

  // الموظف الحالي (للتتبع السريع)
  currentAssigneeId String? @map("current_assignee_id")

  // العلاقات
  assignments  CustodyAssignment[]
  returns      CustodyReturn[]
  transfers    CustodyTransfer[]
  maintenances CustodyMaintenance[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@index([companyId, status])
  @@index([categoryId])
  @@index([currentAssigneeId])
  @@map("custody_items")
}

// ==================== حالات التسليم ====================
enum CustodyAssignmentStatus {
  PENDING // في انتظار الموافقة
  APPROVED // تمت الموافقة
  REJECTED // مرفوض
  DELIVERED // تم التسليم
  RETURNED // تم الإرجاع
  TRANSFERRED // تم التحويل
}

// ==================== تسليم العهدة ====================
model CustodyAssignment {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة والموظف
  custodyItemId String      @map("custody_item_id")
  custodyItem   CustodyItem @relation(fields: [custodyItemId], references: [id])
  employeeId    String      @map("employee_id")
  employee      User        @relation("EmployeeCustody", fields: [employeeId], references: [id])

  // تواريخ التسليم
  assignedAt     DateTime  @default(now()) @map("assigned_at")
  expectedReturn DateTime? @map("expected_return") // تاريخ الإرجاع المتوقع
  actualReturn   DateTime? @map("actual_return") // تاريخ الإرجاع الفعلي

  // الحالة
  status            CustodyAssignmentStatus @default(PENDING)
  conditionOnAssign CustodyCondition?       @map("condition_on_assign")
  conditionOnReturn CustodyCondition?       @map("condition_on_return")

  // الموافقات
  assignedById String    @map("assigned_by_id") // من قام بالتسليم
  assignedBy   User      @relation("CustodyAssigner", fields: [assignedById], references: [id])
  approvedById String?   @map("approved_by_id") // من وافق
  approvedBy   User?     @relation("CustodyApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime? @map("approved_at")

  // ملاحظات وتوقيع
  notes             String?
  employeeSignature String?   @map("employee_signature") // توقيع الموظف (Base64)
  signatureDate     DateTime? @map("signature_date")

  // مرفقات (صور التسليم/استلام)
  attachments Json? @default("[]")

  // Audit
  approvalChain Json? @map("approval_chain")

  // إرجاع مرتبط
  returns CustodyReturn[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([employeeId])
  @@index([custodyItemId])
  @@map("custody_assignments")
}

// ==================== حالات الإرجاع ====================
enum CustodyReturnStatus {
  PENDING // في انتظار المراجعة
  INSPECTING // جاري الفحص
  APPROVED // تمت الموافقة
  REJECTED // مرفوض (الموظف يحتفظ بالعهدة)
  COMPLETED // تم الإرجاع بنجاح
}

// ==================== إرجاع العهدة ====================
model CustodyReturn {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة
  custodyItemId String            @map("custody_item_id")
  custodyItem   CustodyItem       @relation(fields: [custodyItemId], references: [id])
  assignmentId  String            @map("assignment_id") // التسليم المرتبط
  assignment    CustodyAssignment @relation(fields: [assignmentId], references: [id])

  // الموظف المرجع
  returnedById String @map("returned_by_id")
  returnedBy   User   @relation("CustodyReturner", fields: [returnedById], references: [id])

  // تفاصيل الإرجاع
  returnDate        DateTime         @default(now()) @map("return_date")
  returnReason      String?          @map("return_reason") // سبب الإرجاع
  conditionOnReturn CustodyCondition @map("condition_on_return")

  // الحالة والمراجعة
  status       CustodyReturnStatus @default(PENDING)
  reviewedById String?             @map("reviewed_by_id")
  reviewedBy   User?               @relation("CustodyReturnReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?           @map("reviewed_at")
  reviewNotes  String?             @map("review_notes")

  // في حالة التلف - ربط مع الرواتب
  damageDescription  String?  @map("damage_description")
  estimatedCost      Decimal? @map("estimated_cost") @db.Decimal(12, 2) // تكلفة الإصلاح/التعويض
  replacementValue   Decimal? @map("replacement_value") @db.Decimal(12, 2) // قيمة الاستبدال الكاملة للعهدة التالفة
  chargeEmployee     Boolean  @default(false) @map("charge_employee") // خصم من الراتب؟
  chargedToPayroll   Boolean  @default(false) @map("charged_to_payroll") // تم الخصم؟
  payrollDeductionId String?  @map("payroll_deduction_id") // رقم خصم الراتب

  // مرفقات (صور الحالة)
  attachments Json? @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("custody_returns")
}

// ==================== حالات التحويل ====================
enum CustodyTransferStatus {
  PENDING // في انتظار موافقة الموظف الجديد
  APPROVED // وافق الموظف الجديد
  REJECTED // رفض التحويل
  COMPLETED // تم التحويل
}

// ==================== تحويل العهدة ====================
model CustodyTransfer {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة
  custodyItemId String      @map("custody_item_id")
  custodyItem   CustodyItem @relation(fields: [custodyItemId], references: [id])

  // من/إلى
  fromEmployeeId String @map("from_employee_id")
  fromEmployee   User   @relation("CustodyTransferFrom", fields: [fromEmployeeId], references: [id])
  toEmployeeId   String @map("to_employee_id")
  toEmployee     User   @relation("CustodyTransferTo", fields: [toEmployeeId], references: [id])

  // التفاصيل
  transferDate DateTime              @default(now()) @map("transfer_date")
  reason       String? // سبب التحويل
  status       CustodyTransferStatus @default(PENDING)

  // الموافقات
  initiatedById String    @map("initiated_by_id") // من بدأ الطلب
  initiatedBy   User      @relation("CustodyTransferInitiator", fields: [initiatedById], references: [id])
  approvedById  String?   @map("approved_by_id")
  approvedBy    User?     @relation("CustodyTransferApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime? @map("approved_at")

  // توقيعات
  fromSignature String? @map("from_signature")
  toSignature   String? @map("to_signature")

  notes       String?
  attachments Json?   @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("custody_transfers")
}

// ==================== حالات الصيانة ====================
enum CustodyMaintenanceStatus {
  PENDING // في انتظار الصيانة
  IN_PROGRESS // جاري الصيانة
  COMPLETED // تمت الصيانة
  CANNOT_REPAIR // لا يمكن إصلاحها
}

enum MaintenanceType {
  PREVENTIVE // صيانة وقائية
  CORRECTIVE // صيانة علاجية
  EMERGENCY // صيانة طارئة
}

// ==================== صيانة العهدة ====================
model CustodyMaintenance {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // العهدة
  custodyItemId String      @map("custody_item_id")
  custodyItem   CustodyItem @relation(fields: [custodyItemId], references: [id])

  // نوع الصيانة
  type        MaintenanceType
  description String // وصف المشكلة

  // التواريخ
  reportedAt   DateTime  @default(now()) @map("reported_at")
  reportedById String    @map("reported_by_id")
  reportedBy   User      @relation("MaintenanceReporter", fields: [reportedById], references: [id])
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")

  // الحالة
  status CustodyMaintenanceStatus @default(PENDING)

  // التكاليف
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(12, 2)
  actualCost    Decimal? @map("actual_cost") @db.Decimal(12, 2)

  // مزود الصيانة الخارجي
  vendor        String? // مزود الصيانة
  vendorContact String? @map("vendor_contact") // رقم التواصل
  vendorEmail   String? @map("vendor_email")
  invoiceNumber String? @map("invoice_number")

  // النتيجة
  result         String? // نتيجة الصيانة
  conditionAfter CustodyCondition? @map("condition_after")

  // مرفقات
  attachments Json? @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@map("custody_maintenances")
}

// ==================== وثائق الموظفين ====================
enum DocumentType {
  ID_CARD // بطاقة الهوية
  IQAMA // الإقامة
  PASSPORT // جواز السفر
  CONTRACT // العقد
  CERTIFICATE // شهادة
  MEDICAL // تقرير طبي
  BANK_LETTER // خطاب بنكي
  DRIVING_LICENSE // رخصة قيادة
  QUALIFICATION // مؤهل علمي
  OTHER // أخرى
}

model EmployeeDocument {
  id        String @id @default(uuid())
  companyId String @map("company_id")
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        DocumentType
  title       String // عنوان المستند
  titleAr     String?      @map("title_ar") // العنوان بالعربي
  description String? // وصف المستند

  // بيانات الملف
  filePath      String  @map("file_path")
  fileType      String  @map("file_type") // pdf, jpg, png
  fileSize      Int     @map("file_size") // بالبايت
  originalName  String? @map("original_name") // اسم الملف الأصلي
  thumbnailPath String? @map("thumbnail_path") // مسار الصورة المصغرة للصور

  // معلومات إضافية
  documentNumber   String?   @map("document_number") // رقم المستند
  issueDate        DateTime? @map("issue_date") @db.Date // تاريخ الإصدار
  expiryDate       DateTime? @map("expiry_date") @db.Date // تاريخ الانتهاء
  issuingAuthority String?   @map("issuing_authority") // جهة الإصدار

  // التحقق
  isVerified   Boolean   @default(false) @map("is_verified")
  verifiedById String?   @map("verified_by_id")
  verifiedAt   DateTime? @map("verified_at")

  // من قام بالرفع
  uploadedById String  @map("uploaded_by_id")
  notes        String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([companyId, type])
  @@index([expiryDate])
  @@map("employee_documents")
}

model PayrollLedger {
  id        String     @id @default(uuid())
  runId     String     @unique @map("run_id")
  run       PayrollRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  companyId String     @map("company_id")

  totalGross     Decimal @default(0) @map("total_gross") @db.Decimal(12, 2)
  totalDeduction Decimal @default(0) @map("total_deduction") @db.Decimal(12, 2)
  totalNet       Decimal @default(0) @map("total_net") @db.Decimal(12, 2)

  // Employer Cost (Taxes, GOSI, Benefits)
  totalEmployerContribution Decimal @default(0) @map("total_employer_contribution") @db.Decimal(12, 2)

  status String @default("DRAFT") // DRAFT, POSTED, REVERSED

  entries JournalEntry[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payroll_ledgers")
}

model JournalEntry {
  id       String        @id @default(uuid())
  ledgerId String        @map("ledger_id")
  ledger   PayrollLedger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)

  accountCode String @map("account_code") // e.g., 5101 (Basic Salary Account)
  accountName String @map("account_name")

  debit  Decimal @default(0) @db.Decimal(12, 2)
  credit Decimal @default(0) @db.Decimal(12, 2)

  description String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("payroll_journal_entries")
}

// ==================== نظام تتبع الموقع (Location Tracking System) ====================

// سجل تحديثات موقع الموظف
model EmployeeLocationLog {
  id        String   @id @default(uuid())
  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])

  latitude  Decimal @db.Decimal(10, 8)
  longitude Decimal @db.Decimal(11, 8)
  accuracy  Float? // دقة GPS بالمتر

  // حالة الموقع
  isInsideGeofence   Boolean @default(true) @map("is_inside_geofence")
  distanceFromBranch Int?    @map("distance_from_branch") // بالمتر

  // معلومات إضافية
  batteryLevel Float?  @map("battery_level")
  deviceInfo   String? @map("device_info")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([companyId, createdAt])
  @@index([userId, isInsideGeofence])
  @@map("employee_location_logs")
}

// أحداث الخروج من نطاق الشركة
model GeofenceExitEvent {
  id           String     @id @default(uuid())
  companyId    String?    @map("company_id")
  company      Company?   @relation(fields: [companyId], references: [id])
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id])
  attendanceId String     @map("attendance_id")
  attendance   Attendance @relation(fields: [attendanceId], references: [id])

  // موقع الخروج
  exitLatitude       Decimal @map("exit_latitude") @db.Decimal(10, 8)
  exitLongitude      Decimal @map("exit_longitude") @db.Decimal(11, 8)
  distanceFromBranch Int     @map("distance_from_branch")

  // وقت الخروج والعودة
  exitTime   DateTime  @map("exit_time")
  returnTime DateTime? @map("return_time")

  // موقع العودة (اختياري)
  returnLatitude  Decimal? @map("return_latitude") @db.Decimal(10, 8)
  returnLongitude Decimal? @map("return_longitude") @db.Decimal(11, 8)

  // مدة الخروج بالدقائق
  durationMinutes Int? @map("duration_minutes")

  // هل تم إرسال إشعار؟
  notificationSent Boolean @default(false) @map("notification_sent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, exitTime])
  @@index([attendanceId])
  @@index([companyId, exitTime])
  @@map("geofence_exit_events")
}

// ==================== نظام ترحيب الموظفين (Employee Onboarding System) ====================

// نوع عملية الترحيب
enum OnboardingType {
  JOINING // انضمام موظف جديد
  OFFBOARDING // إنهاء خدمة
  RETURN // عودة من إجازة طويلة
}

// نوع المسؤول عن المهمة
enum AssigneeType {
  HR
  IT
  MANAGER
  FINANCE
  EMPLOYEE
}

// حالة العملية
enum OnboardingProcessStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// أولوية المهمة
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// حالة المهمة العامة
enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  COMPLETED
  CANCELLED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

// حالة المهمة
enum OnboardingTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// قوالب سير العمل للترحيب
model OnboardingTemplate {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  name        String
  nameEn      String?        @map("name_en")
  description String?
  type        OnboardingType @default(JOINING)
  isActive    Boolean        @default(true)

  tasks     OnboardingTemplateTask[]
  processes OnboardingProcess[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, type])
  @@map("onboarding_templates")
}

// مهام القالب
model OnboardingTemplateTask {
  id         String             @id @default(uuid())
  templateId String             @map("template_id")
  template   OnboardingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  title       String
  titleEn     String? @map("title_en")
  description String?

  assigneeType  AssigneeType @default(HR)
  dueDays       Int          @default(1) // عدد الأيام من تاريخ البدء
  priority      Int          @default(1) // ترتيب الأولوية
  requiresPhoto Boolean      @default(false) @map("requires_photo")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([templateId])
  @@map("onboarding_template_tasks")
}

// عملية الترحيب الفعلية للموظف
model OnboardingProcess {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  templateId String             @map("template_id")
  template   OnboardingTemplate @relation(fields: [templateId], references: [id])

  type        OnboardingType
  status      OnboardingProcessStatus @default(IN_PROGRESS)
  startDate   DateTime                @default(now()) @map("start_date")
  completedAt DateTime?               @map("completed_at")

  tasks OnboardingTask[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([userId])
  @@map("onboarding_processes")
}

// المهام الفعلية للموظف
model OnboardingTask {
  id        String            @id @default(uuid())
  processId String            @map("process_id")
  process   OnboardingProcess @relation(fields: [processId], references: [id], onDelete: Cascade)

  title       String
  titleEn     String? @map("title_en")
  description String?

  assigneeId   String?      @map("assignee_id")
  assigneeType AssigneeType

  status      OnboardingTaskStatus @default(PENDING)
  dueDate     DateTime             @map("due_date")
  completedAt DateTime?            @map("completed_at")
  completedBy String?              @map("completed_by")

  // توثيق بالصورة
  photoUrl String? @map("photo_url")
  notes    String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([processId, status])
  @@map("onboarding_tasks")
}

// ==================== AI Predictive Absence Analytics ====================

// مستوى المخاطر
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// نموذج التنبؤ بالغياب
model AbsencePrediction {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String  @map("user_id")
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // تاريخ التنبؤ
  predictionDate DateTime @map("prediction_date") @db.Date

  // احتمالية الغياب (0-100)
  absenceLikelihood Decimal @map("absence_likelihood") @db.Decimal(5, 2)

  // مستوى المخاطر
  riskLevel RiskLevel @map("risk_level")

  // العوامل المساهمة (JSON)
  contributingFactors Json @map("contributing_factors")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, predictionDate])
  @@index([userId, predictionDate])
  @@index([riskLevel])
  @@map("absence_predictions")
}

// ========== دقة النموذج (Model Accuracy Tracking) ==========

model PredictionAccuracy {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // إصدار النموذج
  modelVersion String @map("model_version")

  // مقاييس الأداء
  accuracy  Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  precision Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  recall    Decimal @db.Decimal(5, 4) // 0.0000 - 1.0000
  f1Score   Decimal @map("f1_score") @db.Decimal(5, 4) // 0.0000 - 1.0000

  // تاريخ التقييم
  evaluatedAt DateTime @map("evaluated_at")

  // عدد التنبؤات المستخدمة في التقييم
  predictionCount Int @map("prediction_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, evaluatedAt])
  @@index([modelVersion])
  @@map("prediction_accuracies")
}

// ========== أنماط الغياب (Absence Patterns) ==========

model AbsencePattern {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // نوع النمط
  patternType String @map("pattern_type") // MONDAY_ABSENCE, POST_HOLIDAY, SEASONAL, etc.

  // وصف النمط
  description String @db.Text

  // الموظفون المتأثرون (JSON array of user IDs)
  affectedEmployees Json @map("affected_employees")

  // مستوى الثقة (0.0000 - 1.0000)
  confidence Decimal @db.Decimal(5, 4)

  // تاريخ اكتشاف النمط
  detectedAt DateTime @map("detected_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, detectedAt])
  @@index([patternType])
  @@map("absence_patterns")
}

// ==================== إعدادات التوطين (Saudization Config) ====================

model SaudizationConfig {
  id        String  @id @default(uuid())
  companyId String  @unique @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // إعدادات نطاقات
  activityType String? @map("activity_type") // نوع النشاط التجاري لتحديد نسب التوطين
  nitaqatSize  String? @map("nitaqat_size") // حجم المنشأة في نظام نطاقات

  // العلاقات
  saudizationRecords     SaudizationRecord[]
  saudizationTargets     SaudizationTarget[]
  departmentSaudizations DepartmentSaudization[]
  nitaqatAlerts          NitaqatAlert[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("saudization_configs")
}

model SaudizationRecord {
  id                   String            @id @default(uuid())
  companyId            String            @map("company_id")
  configId             String            @map("config_id")
  recordDate           DateTime          @map("record_date") @db.Date
  month                Int
  year                 Int
  totalEmployees       Int               @map("total_employees")
  saudiEmployees       Int               @map("saudi_employees")
  nonSaudiEmployees    Int               @map("non_saudi_employees")
  saudiMales           Int               @default(0) @map("saudi_males")
  saudiFemales         Int               @default(0) @map("saudi_females")
  nonSaudiMales        Int               @default(0) @map("non_saudi_males")
  nonSaudiFemales      Int               @default(0) @map("non_saudi_females")
  partTimeSaudis       Int               @default(0) @map("part_time_saudis")
  partTimeNonSaudis    Int               @default(0) @map("part_time_non_saudis")
  saudiStudents        Int               @default(0) @map("saudi_students")
  saudiTrainees        Int               @default(0) @map("saudi_trainees")
  disabledSaudis       Int               @default(0) @map("disabled_saudis")
  calculatedPercentage Decimal           @map("calculated_percentage") @db.Decimal(5, 2)
  weightedPercentage   Decimal           @map("weighted_percentage") @db.Decimal(5, 2)
  zone                 NitaqatZone       @map("zone")
  previousZone         NitaqatZone?      @map("previous_zone")
  zoneChanged          Boolean           @default(false) @map("zone_changed")
  status               SaudizationStatus @map("status")
  gapToTarget          Decimal           @map("gap_to_target") @db.Decimal(5, 2)
  gapToNextZone        Decimal           @map("gap_to_next_zone") @db.Decimal(5, 2)
  requiredHires        Int               @default(0) @map("required_hires")
  allowedExits         Int               @default(0) @map("allowed_exits")
  notes                String?
  createdAt            DateTime          @default(now()) @map("created_at")
  config               SaudizationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([companyId, recordDate])
  @@index([companyId, year, month])
  @@map("saudization_records")
}

model SaudizationTarget {
  id                   String            @id @default(uuid())
  companyId            String            @map("company_id")
  configId             String            @map("config_id")
  targetYear           Int               @map("target_year")
  targetQuarter        Int?              @map("target_quarter")
  targetMonth          Int?              @map("target_month")
  targetPercentage     Decimal           @map("target_percentage") @db.Decimal(5, 2)
  targetZone           NitaqatZone       @map("target_zone")
  plannedSaudiHires    Int               @default(0) @map("planned_saudi_hires")
  plannedNonSaudiExits Int               @default(0) @map("planned_non_saudi_exits")
  actualSaudiHires     Int               @default(0) @map("actual_saudi_hires")
  actualNonSaudiExits  Int               @default(0) @map("actual_non_saudi_exits")
  achievedPercentage   Decimal?          @map("achieved_percentage") @db.Decimal(5, 2)
  isAchieved           Boolean           @default(false) @map("is_achieved")
  achievedAt           DateTime?         @map("achieved_at")
  notes                String?
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  config               SaudizationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, targetYear, targetQuarter, targetMonth])
  @@index([companyId, targetYear])
  @@map("saudization_targets")
}

model DepartmentSaudization {
  id               String            @id @default(uuid())
  companyId        String            @map("company_id")
  configId         String            @map("config_id")
  departmentId     String            @map("department_id")
  totalEmployees   Int               @map("total_employees")
  saudiEmployees   Int               @map("saudi_employees")
  saudiPercentage  Decimal           @map("saudi_percentage") @db.Decimal(5, 2)
  targetPercentage Decimal           @map("target_percentage") @db.Decimal(5, 2)
  gapToTarget      Decimal           @map("gap_to_target") @db.Decimal(5, 2)
  recommendedHires Int               @default(0) @map("recommended_hires")
  priority         String            @default("MEDIUM") @map("priority")
  lastCalculatedAt DateTime          @map("last_calculated_at")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  config           SaudizationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  department       Department        @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([configId, departmentId])
  @@index([companyId, departmentId])
  @@map("department_saudization")
}

model NitaqatAlert {
  id               String            @id @default(uuid())
  companyId        String            @map("company_id")
  configId         String            @map("config_id")
  alertType        String            @map("alert_type")
  severity         String            @map("severity")
  title            String
  titleAr          String            @map("title_ar")
  message          String
  messageAr        String            @map("message_ar")
  currentValue     Decimal?          @map("current_value") @db.Decimal(5, 2)
  thresholdValue   Decimal?          @map("threshold_value") @db.Decimal(5, 2)
  fromZone         NitaqatZone?      @map("from_zone")
  toZone           NitaqatZone?      @map("to_zone")
  actionRequired   String?           @map("action_required")
  actionRequiredAr String?           @map("action_required_ar")
  deadline         DateTime?         @map("deadline")
  isRead           Boolean           @default(false) @map("is_read")
  readAt           DateTime?         @map("read_at")
  isResolved       Boolean           @default(false) @map("is_resolved")
  resolvedAt       DateTime?         @map("resolved_at")
  resolvedBy       String?           @map("resolved_by")
  resolutionNote   String?           @map("resolution_note")
  createdAt        DateTime          @default(now()) @map("created_at")
  config           SaudizationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([companyId, isRead])
  @@index([companyId, severity])
  @@map("nitaqat_alerts")
}

model SaudizationRecommendation {
  id                 String       @id @default(uuid())
  companyId          String       @map("company_id")
  recommendationType String       @map("recommendation_type")
  title              String
  titleAr            String       @map("title_ar")
  description        String
  descriptionAr      String       @map("description_ar")
  impactOnPercentage Decimal      @map("impact_on_percentage") @db.Decimal(5, 2)
  impactOnZone       NitaqatZone? @map("impact_on_zone")
  estimatedCost      Decimal?     @map("estimated_cost") @db.Decimal(12, 2)
  estimatedTimeWeeks Int?         @map("estimated_time_weeks")
  priority           String       @map("priority")
  priorityScore      Int          @map("priority_score")
  targetDepartmentId String?      @map("target_department_id")
  suggestedJobTitles Json?        @map("suggested_job_titles")
  status             String       @default("PENDING") @map("status")
  implementedAt      DateTime?    @map("implemented_at")
  rejectedAt         DateTime?    @map("rejected_at")
  rejectionReason    String?      @map("rejection_reason")
  source             String       @default("AI") @map("source")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([companyId, priority])
  @@map("saudization_recommendations")
}

model ShiftTemplate {
  id                   String      @id @default(uuid())
  companyId            String      @map("company_id")
  name                 String
  nameAr               String      @map("name_ar")
  description          String?
  color                String?
  code                 String?
  shiftType            ShiftType   @default(REGULAR) @map("shift_type")
  defaultStartTime     String      @map("default_start_time")
  defaultEndTime       String      @map("default_end_time")
  defaultBreakMinutes  Int         @default(60) @map("default_break_minutes")
  workHours            Decimal     @map("work_hours") @db.Decimal(4, 2)
  isOvernight          Boolean     @default(false) @map("is_overnight")
  crossesMidnight      Boolean     @default(false) @map("crosses_midnight")
  payMultiplier        Decimal     @default(1) @map("pay_multiplier") @db.Decimal(3, 2)
  isOvertimeEligible   Boolean     @default(true) @map("is_overtime_eligible")
  minRestBetweenShifts Int         @default(11) @map("min_rest_between_shifts")
  maxConsecutiveDays   Int         @default(6) @map("max_consecutive_days")
  isActive             Boolean     @default(true) @map("is_active")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")
  shiftRules           ShiftRule[]
  company              Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shifts               Shift[]

  @@unique([companyId, name])
  @@index([companyId, isActive])
  @@map("shift_templates")
}

model ShiftSchedule {
  id                String      @id @default(uuid())
  companyId         String      @map("company_id")
  name              String
  nameAr            String      @map("name_ar")
  description       String?
  startDate         DateTime    @map("start_date") @db.Date
  endDate           DateTime    @map("end_date") @db.Date
  weekNumber        Int?        @map("week_number")
  branchId          String?     @map("branch_id")
  departmentId      String?     @map("department_id")
  status            ShiftStatus @default(DRAFT) @map("status")
  publishedAt       DateTime?   @map("published_at")
  publishedBy       String?     @map("published_by")
  totalShifts       Int         @default(0) @map("total_shifts")
  assignedShifts    Int         @default(0) @map("assigned_shifts")
  openShifts        Int         @default(0) @map("open_shifts")
  coveragePercent   Decimal     @default(0) @map("coverage_percent") @db.Decimal(5, 2)
  isAiOptimized     Boolean     @default(false) @map("is_ai_optimized")
  optimizationScore Decimal?    @map("optimization_score") @db.Decimal(5, 2)
  lastOptimizedAt   DateTime?   @map("last_optimized_at")
  createdBy         String      @map("created_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  branch            Branch?     @relation(fields: [branchId], references: [id])
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department        Department? @relation(fields: [departmentId], references: [id])
  shifts            Shift[]

  @@index([companyId, startDate, endDate])
  @@index([companyId, status])
  @@map("shift_schedules")
}

model Shift {
  id                 String             @id @default(uuid())
  companyId          String             @map("company_id")
  scheduleId         String             @map("schedule_id")
  templateId         String?            @map("template_id")
  shiftDate          DateTime           @map("shift_date") @db.Date
  startTime          DateTime           @map("start_time")
  endTime            DateTime           @map("end_time")
  breakMinutes       Int                @default(60) @map("break_minutes")
  assignedUserId     String?            @map("assigned_user_id")
  requiredSkills     Json?              @map("required_skills")
  requiredRole       String?            @map("required_role")
  minExperienceYears Int?               @map("min_experience_years")
  branchId           String?            @map("branch_id")
  departmentId       String?            @map("department_id")
  locationNote       String?            @map("location_note")
  status             ShiftStatus        @default(DRAFT) @map("status")
  isOpen             Boolean            @default(true) @map("is_open")
  actualStartTime    DateTime?          @map("actual_start_time")
  actualEndTime      DateTime?          @map("actual_end_time")
  attendanceId       String?            @map("attendance_id")
  notes              String?
  notesAr            String?            @map("notes_ar")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  bids               ShiftBid[]
  swapRequests       ShiftSwapRequest[] @relation("ShiftSwapOriginal")
  swapTargets        ShiftSwapRequest[] @relation("ShiftSwapTarget")
  assignedUser       User?              @relation("UserShifts", fields: [assignedUserId], references: [id])
  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  schedule           ShiftSchedule      @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  template           ShiftTemplate?     @relation(fields: [templateId], references: [id])

  @@index([companyId, shiftDate])
  @@index([scheduleId, shiftDate])
  @@index([assignedUserId, shiftDate])
  @@map("shifts")
}

model ShiftSwapRequest {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  originalShiftId   String    @map("original_shift_id")
  requesterId       String    @map("requester_id")
  targetShiftId     String?   @map("target_shift_id")
  targetUserId      String?   @map("target_user_id")
  reason            String?
  reasonAr          String?   @map("reason_ar")
  status            String    @default("PENDING") @map("status")
  targetAcceptedAt  DateTime? @map("target_accepted_at")
  managerApprovedAt DateTime? @map("manager_approved_at")
  managerId         String?   @map("manager_id")
  rejectionReason   String?   @map("rejection_reason")
  expiresAt         DateTime  @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  manager           User?     @relation("ShiftSwapManager", fields: [managerId], references: [id])
  originalShift     Shift     @relation("ShiftSwapOriginal", fields: [originalShiftId], references: [id], onDelete: Cascade)
  requester         User      @relation("ShiftSwapRequester", fields: [requesterId], references: [id])
  targetShift       Shift?    @relation("ShiftSwapTarget", fields: [targetShiftId], references: [id])
  targetUser        User?     @relation("ShiftSwapTarget", fields: [targetUserId], references: [id])

  @@index([companyId, status])
  @@index([requesterId])
  @@map("shift_swap_requests")
}

model ShiftBid {
  id         String    @id @default(uuid())
  companyId  String    @map("company_id")
  shiftId    String    @map("shift_id")
  userId     String    @map("user_id")
  bidNote    String?   @map("bid_note")
  priority   Int       @default(0) @map("priority")
  status     String    @default("PENDING") @map("status")
  reviewedAt DateTime? @map("reviewed_at")
  reviewedBy String?   @map("reviewed_by")
  createdAt  DateTime  @default(now()) @map("created_at")
  shift      Shift     @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  user       User      @relation("ShiftBidUser", fields: [userId], references: [id])

  @@unique([shiftId, userId])
  @@index([companyId, status])
  @@map("shift_bids")
}

model ShiftRule {
  id            String         @id @default(uuid())
  companyId     String         @map("company_id")
  templateId    String?        @map("template_id")
  ruleType      String         @map("rule_type")
  name          String
  nameAr        String         @map("name_ar")
  description   String?
  condition     Json           @map("condition")
  value         String         @map("value")
  severity      String         @default("WARNING") @map("severity")
  isActive      Boolean        @default(true) @map("is_active")
  appliesToAll  Boolean        @default(true) @map("applies_to_all")
  departmentIds Json?          @map("department_ids")
  roleIds       Json?          @map("role_ids")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  template      ShiftTemplate? @relation(fields: [templateId], references: [id])

  @@index([companyId, isActive])
  @@map("shift_rules")
}

model ShiftOptimizationRun {
  id                  String    @id @default(uuid())
  companyId           String    @map("company_id")
  scheduleId          String    @map("schedule_id")
  optimizationGoals   Json      @map("optimization_goals")
  constraints         Json      @map("constraints")
  status              String    @default("RUNNING") @map("status")
  totalChanges        Int       @default(0) @map("total_changes")
  costSavings         Decimal?  @map("cost_savings") @db.Decimal(12, 2)
  coverageImprovement Decimal?  @map("coverage_improvement") @db.Decimal(5, 2)
  fairnessScore       Decimal?  @map("fairness_score") @db.Decimal(5, 2)
  changesApplied      Json?     @map("changes_applied")
  suggestions         Json?     @map("suggestions")
  warnings            Json?     @map("warnings")
  startedAt           DateTime  @default(now()) @map("started_at")
  completedAt         DateTime? @map("completed_at")
  appliedAt           DateTime? @map("applied_at")
  appliedBy           String?   @map("applied_by")
  createdAt           DateTime  @default(now()) @map("created_at")
  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@map("shift_optimization_runs")
}

model PolicyViolationPrediction {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  policyId              String    @map("policy_id")
  userId                String    @map("user_id")
  predictionDate        DateTime  @map("prediction_date") @db.Date
  predictedDate         DateTime  @map("predicted_date") @db.Date
  violationType         String    @map("violation_type")
  probability           Decimal   @map("probability") @db.Decimal(5, 4)
  confidenceLevel       String    @map("confidence_level")
  riskFactors           Json      @map("risk_factors")
  historicalPattern     Json?     @map("historical_pattern")
  recommendedAction     String    @map("recommended_action")
  recommendedActionAr   String    @map("recommended_action_ar")
  preventionSuggestions Json?     @map("prevention_suggestions")
  status                String    @default("ACTIVE") @map("status")
  actuallyOccurred      Boolean   @default(false) @map("actually_occurred")
  preventedAt           DateTime? @map("prevented_at")
  preventedBy           String?   @map("prevented_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  user                  User      @relation("PolicyPredictionUser", fields: [userId], references: [id])

  @@index([companyId, status])
  @@index([userId, predictionDate])
  @@map("policy_violation_predictions")
}

model PolicySuggestion {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  suggestionType    String    @map("suggestion_type")
  title             String
  titleAr           String    @map("title_ar")
  description       String
  descriptionAr     String    @map("description_ar")
  relatedPolicyId   String?   @map("related_policy_id")
  proposedRules     Json      @map("proposed_rules")
  proposedConfig    Json?     @map("proposed_config")
  analysisReason    String    @map("analysis_reason")
  dataPoints        Json      @map("data_points")
  impactAnalysis    Json      @map("impact_analysis")
  industryBenchmark Json?     @map("industry_benchmark")
  complianceCheck   Json?     @map("compliance_check")
  priority          String    @map("priority")
  priorityScore     Int       @map("priority_score")
  urgency           String?   @map("urgency")
  status            String    @default("PENDING") @map("status")
  reviewedAt        DateTime? @map("reviewed_at")
  reviewedBy        String?   @map("reviewed_by")
  reviewNotes       String?   @map("review_notes")
  implementedAt     DateTime? @map("implemented_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([companyId, status])
  @@index([companyId, priority])
  @@map("policy_suggestions")
}

model PolicyChangeSimulation {
  id                   String    @id @default(uuid())
  companyId            String    @map("company_id")
  policyId             String    @map("policy_id")
  scenarioName         String    @map("scenario_name")
  scenarioNameAr       String    @map("scenario_name_ar")
  proposedChanges      Json      @map("proposed_changes")
  simulationPeriod     String    @map("simulation_period")
  employeeScope        String    @map("employee_scope")
  scopeFilter          Json?     @map("scope_filter")
  status               String    @default("PENDING") @map("status")
  affectedEmployees    Int?      @map("affected_employees")
  estimatedViolations  Int?      @map("estimated_violations")
  financialImpact      Decimal?  @map("financial_impact") @db.Decimal(12, 2)
  productivityImpact   Decimal?  @map("productivity_impact") @db.Decimal(5, 2)
  complianceRiskChange Decimal?  @map("compliance_risk_change") @db.Decimal(5, 2)
  detailedResults      Json?     @map("detailed_results")
  employeeBreakdown    Json?     @map("employee_breakdown")
  timelineImpact       Json?     @map("timeline_impact")
  recommendations      Json?     @map("recommendations")
  beforeMetrics        Json?     @map("before_metrics")
  afterMetrics         Json?     @map("after_metrics")
  comparisonSummary    String?   @map("comparison_summary")
  runAt                DateTime? @map("run_at")
  completedAt          DateTime? @map("completed_at")
  runBy                String    @map("run_by")
  createdAt            DateTime  @default(now()) @map("created_at")

  @@index([companyId, policyId])
  @@index([companyId, status])
  @@map("policy_change_simulations")
}

model PolicyBenchmark {
  id                 String   @id @default(uuid())
  companyId          String   @map("company_id")
  benchmarkDate      DateTime @map("benchmark_date") @db.Date
  industry           String   @map("industry")
  companySize        String   @map("company_size")
  region             String   @map("region")
  policyMetrics      Json     @map("policy_metrics")
  industryAverage    Json     @map("industry_average")
  percentileRanking  Json     @map("percentile_ranking")
  gapAnalysis        Json     @map("gap_analysis")
  recommendations    Json     @map("recommendations")
  priorityAreas      Json     @map("priority_areas")
  overallScore       Decimal  @map("overall_score") @db.Decimal(5, 2)
  complianceScore    Decimal  @map("compliance_score") @db.Decimal(5, 2)
  fairnessScore      Decimal  @map("fairness_score") @db.Decimal(5, 2)
  effectivenessScore Decimal  @map("effectiveness_score") @db.Decimal(5, 2)
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([companyId, benchmarkDate])
  @@map("policy_benchmarks")
}

model ProfileUpdateRequest {
  id                  String    @id @default(uuid())
  companyId           String    @map("company_id")
  userId              String    @map("user_id")
  updateType          String    @map("update_type")
  fieldName           String    @map("field_name")
  currentValue        String?   @map("current_value")
  requestedValue      String    @map("requested_value")
  supportingDocuments Json?     @map("supporting_documents")
  reason              String?
  reasonAr            String?   @map("reason_ar")
  status              String    @default("PENDING") @map("status")
  reviewedAt          DateTime? @map("reviewed_at")
  reviewedBy          String?   @map("reviewed_by")
  reviewNote          String?   @map("review_note")
  rejectionReason     String?   @map("rejection_reason")
  appliedAt           DateTime? @map("applied_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  reviewer            User?     @relation("ProfileUpdateReviewer", fields: [reviewedBy], references: [id])
  user                User      @relation("ProfileUpdateRequests", fields: [userId], references: [id])

  @@index([companyId, status])
  @@index([userId])
  @@map("profile_update_requests")
}

model EmergencyContact {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  name           String
  nameAr         String?  @map("name_ar")
  relationship   String
  phone          String
  alternatePhone String?  @map("alternate_phone")
  email          String?
  priority       Int      @default(1) @map("priority")
  address        String?
  city           String?
  country        String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  user           User     @relation("EmergencyContacts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("emergency_contacts")
}

model TrainingRequest {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  userId                String    @map("user_id")
  trainingType          String    @map("training_type")
  trainingName          String    @map("training_name")
  trainingNameAr        String?   @map("training_name_ar")
  provider              String?   @map("provider")
  description           String?
  startDate             DateTime? @map("start_date") @db.Date
  endDate               DateTime? @map("end_date") @db.Date
  durationHours         Int?      @map("duration_hours")
  location              String?   @map("location")
  isOnline              Boolean   @default(false) @map("is_online")
  estimatedCost         Decimal?  @map("estimated_cost") @db.Decimal(10, 2)
  currency              String    @default("SAR") @map("currency")
  isCostApproved        Boolean   @default(false) @map("is_cost_approved")
  businessJustification String    @map("business_justification")
  expectedOutcome       String?   @map("expected_outcome")
  skillsToGain          Json?     @map("skills_to_gain")
  status                String    @default("PENDING") @map("status")
  managerApprovedAt     DateTime? @map("manager_approved_at")
  managerApprovedBy     String?   @map("manager_approved_by")
  hrApprovedAt          DateTime? @map("hr_approved_at")
  hrApprovedBy          String?   @map("hr_approved_by")
  rejectionReason       String?   @map("rejection_reason")
  completedAt           DateTime? @map("completed_at")
  certificateUrl        String?   @map("certificate_url")
  feedbackScore         Int?      @map("feedback_score")
  feedbackNotes         String?   @map("feedback_notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  user                  User      @relation("TrainingRequests", fields: [userId], references: [id])

  @@index([companyId, status])
  @@index([userId])
  @@map("training_requests")
}

model EmployeeSurvey {
  id                String           @id @default(uuid())
  companyId         String           @map("company_id")
  title             String
  titleAr           String           @map("title_ar")
  description       String?
  descriptionAr     String?          @map("description_ar")
  surveyType        String           @map("survey_type")
  startDate         DateTime         @map("start_date")
  endDate           DateTime         @map("end_date")
  questions         Json             @map("questions")
  targetAll         Boolean          @default(true) @map("target_all")
  targetBranches    Json?            @map("target_branches")
  targetDepartments Json?            @map("target_departments")
  targetRoles       Json?            @map("target_roles")
  isAnonymous       Boolean          @default(true) @map("is_anonymous")
  isRequired        Boolean          @default(false) @map("is_required")
  allowMultiple     Boolean          @default(false) @map("allow_multiple")
  showResults       Boolean          @default(false) @map("show_results")
  status            String           @default("DRAFT") @map("status")
  totalInvited      Int              @default(0) @map("total_invited")
  totalResponses    Int              @default(0) @map("total_responses")
  responseRate      Decimal          @default(0) @map("response_rate") @db.Decimal(5, 2)
  createdBy         String           @map("created_by")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  company           Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  responses         SurveyResponse[]

  @@index([companyId, status])
  @@map("employee_surveys")
}

model SurveyResponse {
  id               String         @id @default(uuid())
  surveyId         String         @map("survey_id")
  userId           String?        @map("user_id")
  answers          Json           @map("answers")
  departmentId     String?        @map("department_id")
  branchId         String?        @map("branch_id")
  startedAt        DateTime       @map("started_at")
  completedAt      DateTime?      @map("completed_at")
  timeSpentSeconds Int?           @map("time_spent_seconds")
  isComplete       Boolean        @default(false) @map("is_complete")
  createdAt        DateTime       @default(now()) @map("created_at")
  survey           EmployeeSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  user             User?          @relation("SurveyResponses", fields: [userId], references: [id])

  @@index([surveyId])
  @@index([userId])
  @@map("survey_responses")
}

model KnowledgeBaseArticle {
  id              String            @id @default(uuid())
  companyId       String            @map("company_id")
  title           String
  titleAr         String            @map("title_ar")
  content         String
  contentAr       String            @map("content_ar")
  summary         String?
  summaryAr       String?           @map("summary_ar")
  category        String            @map("category")
  subcategory     String?           @map("subcategory")
  tags            Json?             @map("tags")
  visibility      String            @default("ALL") @map("visibility")
  customAccess    Json?             @map("custom_access")
  status          String            @default("DRAFT") @map("status")
  publishedAt     DateTime?         @map("published_at")
  publishedBy     String?           @map("published_by")
  viewCount       Int               @default(0) @map("view_count")
  helpfulCount    Int               @default(0) @map("helpful_count")
  notHelpfulCount Int               @default(0) @map("not_helpful_count")
  slug            String?           @map("slug")
  lastReviewedAt  DateTime?         @map("last_reviewed_at")
  nextReviewDate  DateTime?         @map("next_review_date")
  createdBy       String            @map("created_by")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  feedback        ArticleFeedback[]
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, slug])
  @@index([companyId, category, status])
  @@map("knowledge_base_articles")
}

model ArticleFeedback {
  id        String               @id @default(uuid())
  articleId String               @map("article_id")
  userId    String               @map("user_id")
  isHelpful Boolean              @map("is_helpful")
  comment   String?
  createdAt DateTime             @default(now()) @map("created_at")
  article   KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User                 @relation("ArticleFeedback", fields: [userId], references: [id])

  @@unique([articleId, userId])
  @@map("article_feedback")
}

model OfflineSyncQueue {
  id            String    @id @default(uuid())
  companyId     String    @map("company_id")
  userId        String    @map("user_id")
  deviceId      String    @map("device_id")
  operationType String    @map("operation_type")
  entityType    String    @map("entity_type")
  entityId      String?   @map("entity_id")
  payload       Json      @map("payload")
  timestamp     DateTime  @map("timestamp")
  latitude      Decimal?  @map("latitude") @db.Decimal(10, 7)
  longitude     Decimal?  @map("longitude") @db.Decimal(10, 7)
  syncStatus    String    @default("PENDING") @map("sync_status")
  syncAttempts  Int       @default(0) @map("sync_attempts")
  lastSyncAt    DateTime? @map("last_sync_at")
  syncedAt      DateTime? @map("synced_at")
  errorMessage  String?   @map("error_message")
  checksum      String?   @map("checksum")
  isValidated   Boolean   @default(false) @map("is_validated")
  createdAt     DateTime  @default(now()) @map("created_at")
  user          User      @relation("OfflineSyncQueue", fields: [userId], references: [id])

  @@index([userId, syncStatus])
  @@index([deviceId, syncStatus])
  @@map("offline_sync_queue")
}

model UserNotificationPreferences {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  pushEnabled       Boolean  @default(true) @map("push_enabled")
  emailEnabled      Boolean  @default(true) @map("email_enabled")
  smsEnabled        Boolean  @default(false) @map("sms_enabled")
  whatsappEnabled   Boolean  @default(false) @map("whatsapp_enabled")
  leaveApprovals    Boolean  @default(true) @map("leave_approvals")
  attendanceAlerts  Boolean  @default(true) @map("attendance_alerts")
  payslipAvailable  Boolean  @default(true) @map("payslip_available")
  taskAssignments   Boolean  @default(true) @map("task_assignments")
  policyUpdates     Boolean  @default(true) @map("policy_updates")
  shiftReminders    Boolean  @default(true) @map("shift_reminders")
  trainingReminders Boolean  @default(true) @map("training_reminders")
  surveyInvites     Boolean  @default(true) @map("survey_invites")
  announcements     Boolean  @default(true) @map("announcements")
  quietHoursEnabled Boolean  @default(false) @map("quiet_hours_enabled")
  quietHoursStart   String?  @map("quiet_hours_start")
  quietHoursEnd     String?  @map("quiet_hours_end")
  quietDays         Json?    @map("quiet_days")
  preferredLanguage String   @default("ar") @map("preferred_language")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  user              User     @relation("NotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_preferences")
}

model LocationProof {
  id             String    @id @default(uuid())
  companyId      String    @map("company_id")
  userId         String    @map("user_id")
  proofType      String    @map("proof_type")
  latitude       Decimal   @map("latitude") @db.Decimal(10, 7)
  longitude      Decimal   @map("longitude") @db.Decimal(10, 7)
  accuracy       Decimal?  @map("accuracy") @db.Decimal(10, 2)
  altitude       Decimal?  @map("altitude") @db.Decimal(10, 2)
  address        String?   @map("address")
  branchId       String?   @map("branch_id")
  photoUrl       String    @map("photo_url")
  photoHash      String?   @map("photo_hash")
  photoTakenAt   DateTime  @map("photo_taken_at")
  deviceId       String    @map("device_id")
  deviceModel    String?   @map("device_model")
  osVersion      String?   @map("os_version")
  appVersion     String?   @map("app_version")
  isMockLocation Boolean   @default(false) @map("is_mock_location")
  isRooted       Boolean   @default(false) @map("is_rooted")
  isVerified     Boolean   @default(false) @map("is_verified")
  verifiedAt     DateTime? @map("verified_at")
  verifiedBy     String?   @map("verified_by")
  attendanceId   String?   @map("attendance_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  user           User      @relation("LocationProofs", fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([companyId, proofType])
  @@map("location_proofs")
}

model TeamCalendarEvent {
  id             String   @id @default(uuid())
  companyId      String   @map("company_id")
  title          String
  titleAr        String?  @map("title_ar")
  description    String?
  eventType      String   @map("event_type")
  startDate      DateTime @map("start_date")
  endDate        DateTime @map("end_date")
  isAllDay       Boolean  @default(false) @map("is_all_day")
  timezone       String   @default("Asia/Riyadh") @map("timezone")
  userId         String?  @map("user_id")
  departmentId   String?  @map("department_id")
  branchId       String?  @map("branch_id")
  teamId         String?  @map("team_id")
  color          String?  @map("color")
  icon           String?  @map("icon")
  visibility     String   @default("TEAM") @map("visibility")
  sourceType     String?  @map("source_type")
  sourceId       String?  @map("source_id")
  isRecurring    Boolean  @default(false) @map("is_recurring")
  recurrenceRule String?  @map("recurrence_rule")
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user           User?    @relation("TeamCalendarEvents", fields: [userId], references: [id])

  @@index([companyId, startDate, endDate])
  @@index([userId, startDate])
  @@index([departmentId, startDate])
  @@map("team_calendar_events")
}

model Program {
  id             String        @id @default(uuid())
  companyId      String        @map("company_id")
  name           String
  nameEn         String?       @map("name_en")
  description    String?
  code           String?
  color          String?       @default("#3B82F6")
  icon           String?       @default("folder")
  ownerId        String?       @map("owner_id")
  managerId      String?       @map("manager_id")
  startDate      DateTime?     @map("start_date")
  endDate        DateTime?     @map("end_date")
  totalBudget    Decimal?      @map("total_budget") @db.Decimal(15, 2)
  budgetCurrency String?       @default("SAR") @map("budget_currency")
  status         ProgramStatus @default(PLANNING)
  healthStatus   HealthStatus  @default(ON_TRACK) @map("health_status")
  progress       Int           @default(0)
  isArchived     Boolean       @default(false) @map("is_archived")
  archivedAt     DateTime?     @map("archived_at")
  createdById    String        @map("created_by_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy      User          @relation("ProgramCreator", fields: [createdById], references: [id])
  manager        User?         @relation("ProgramManager", fields: [managerId], references: [id])
  owner          User?         @relation("ProgramOwner", fields: [ownerId], references: [id])
  projects       Project[]

  @@index([companyId, status])
  @@index([companyId, ownerId])
  @@map("programs")
}

model Project {
  id                String             @id @default(uuid())
  companyId         String             @map("company_id")
  programId         String?            @map("program_id")
  name              String
  nameEn            String?            @map("name_en")
  description       String?
  code              String?            @unique
  color             String?            @default("#10B981")
  icon              String?            @default("briefcase")
  templateId        String?            @map("template_id")
  ownerId           String?            @map("owner_id")
  managerId         String?            @map("manager_id")
  sponsorId         String?            @map("sponsor_id")
  startDate         DateTime?          @map("start_date")
  plannedEndDate    DateTime?          @map("planned_end_date")
  actualEndDate     DateTime?          @map("actual_end_date")
  baselineStartDate DateTime?          @map("baseline_start_date")
  baselineEndDate   DateTime?          @map("baseline_end_date")
  plannedBudget     Decimal?           @map("planned_budget") @db.Decimal(15, 2)
  actualBudget      Decimal?           @map("actual_budget") @db.Decimal(15, 2)
  budgetCurrency    String?            @default("SAR") @map("budget_currency")
  status            ProjectStatus      @default(INITIATION)
  phase             ProjectPhaseType   @default(INITIATION) @map("phase")
  healthStatus      HealthStatus       @default(ON_TRACK) @map("health_status")
  progress          Int                @default(0)
  priority          ProjectPriority    @default(MEDIUM)
  isPublic          Boolean            @default(false) @map("is_public")
  allowTimeLogging  Boolean            @default(true) @map("allow_time_logging")
  requireApproval   Boolean            @default(false) @map("require_approval")
  isArchived        Boolean            @default(false) @map("is_archived")
  archivedAt        DateTime?          @map("archived_at")
  archivedBy        String?            @map("archived_by")
  tags              String[]           @default([])
  customFields      Json?              @map("custom_fields")
  createdById       String             @map("created_by_id")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  activities        ProjectActivity[]
  budgets           ProjectBudget[]
  members           ProjectMember[]
  milestones        ProjectMilestone[]
  phases            ProjectPhase[]
  risks             ProjectRisk[]
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy         User               @relation("ProjectCreator", fields: [createdById], references: [id])
  manager           User?              @relation("ProjectManager", fields: [managerId], references: [id])
  owner             User?              @relation("ProjectOwner", fields: [ownerId], references: [id])
  program           Program?           @relation(fields: [programId], references: [id])
  sponsor           User?              @relation("ProjectSponsor", fields: [sponsorId], references: [id])
  template          ProjectTemplate?   @relation(fields: [templateId], references: [id])
  tasks             Task[]             @relation("ProjectTasks")

  @@index([companyId, status])
  @@index([companyId, managerId])
  @@index([companyId, programId])
  @@index([code])
  @@map("projects")
}

model ProjectTemplate {
  id                  String    @id @default(uuid())
  companyId           String?   @map("company_id")
  name                String
  nameEn              String?   @map("name_en")
  description         String?
  category            String?
  icon                String?
  color               String?
  defaultDurationDays Int?      @map("default_duration_days")
  defaultBudget       Decimal?  @map("default_budget") @db.Decimal(15, 2)
  phases              Json?
  milestones          Json?
  risks               Json?
  checklist           Json?
  isSystem            Boolean   @default(false) @map("is_system")
  isPublic            Boolean   @default(true) @map("is_public")
  createdById         String?   @map("created_by_id")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  company             Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects            Project[]

  @@index([companyId])
  @@map("project_templates")
}

model ProjectMember {
  id            String            @id @default(uuid())
  projectId     String            @map("project_id")
  userId        String            @map("user_id")
  role          ProjectMemberRole @default(MEMBER)
  allocationPct Int?              @map("allocation_pct")
  hourlyRate    Decimal?          @map("hourly_rate") @db.Decimal(10, 2)
  startDate     DateTime?         @map("start_date")
  endDate       DateTime?         @map("end_date")
  canEdit       Boolean           @default(true) @map("can_edit")
  canDelete     Boolean           @default(false) @map("can_delete")
  canManageTeam Boolean           @default(false) @map("can_manage_team")
  canViewBudget Boolean           @default(false) @map("can_view_budget")
  canApprove    Boolean           @default(false) @map("can_approve")
  joinedAt      DateTime          @default(now()) @map("joined_at")
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          User              @relation("ProjectMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@map("project_members")
}

model ProjectPhase {
  id               String      @id @default(uuid())
  projectId        String      @map("project_id")
  name             String
  nameEn           String?     @map("name_en")
  description      String?
  order            Int         @default(0)
  color            String?     @default("#6366F1")
  plannedStartDate DateTime?   @map("planned_start_date")
  plannedEndDate   DateTime?   @map("planned_end_date")
  actualStartDate  DateTime?   @map("actual_start_date")
  actualEndDate    DateTime?   @map("actual_end_date")
  status           PhaseStatus @default(NOT_STARTED)
  progress         Int         @default(0)
  plannedBudget    Decimal?    @map("planned_budget") @db.Decimal(15, 2)
  actualBudget     Decimal?    @map("actual_budget") @db.Decimal(15, 2)
  deliverables     String[]    @default([])
  dependencies     String[]    @default([])
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  project          Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, order])
  @@map("project_phases")
}

model ProjectMilestone {
  id              String          @id @default(uuid())
  projectId       String          @map("project_id")
  name            String
  nameEn          String?         @map("name_en")
  description     String?
  dueDate         DateTime        @map("due_date")
  completedDate   DateTime?       @map("completed_date")
  status          MilestoneStatus @default(PENDING)
  progress        Int             @default(0)
  ownerId         String?         @map("owner_id")
  deliverables    Json?
  isCritical      Boolean         @default(false) @map("is_critical")
  isPayment       Boolean         @default(false) @map("is_payment")
  paymentAmount   Decimal?        @map("payment_amount") @db.Decimal(15, 2)
  paymentCurrency String?         @default("SAR") @map("payment_currency")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  owner           User?           @relation("MilestoneOwner", fields: [ownerId], references: [id])
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, dueDate])
  @@index([projectId, status])
  @@map("project_milestones")
}

model ProjectRisk {
  id              String          @id @default(uuid())
  projectId       String          @map("project_id")
  title           String
  description     String?
  category        RiskCategory
  probability     RiskProbability @default(MEDIUM)
  impact          RiskImpact      @default(MODERATE)
  riskScore       Int             @default(0) @map("risk_score")
  response        RiskResponse    @default(MONITOR)
  mitigationPlan  String?         @map("mitigation_plan")
  contingencyPlan String?         @map("contingency_plan")
  ownerId         String?         @map("owner_id")
  status          RiskStatus      @default(OPEN)
  identifiedAt    DateTime        @default(now()) @map("identified_at")
  resolvedAt      DateTime?       @map("resolved_at")
  potentialCost   Decimal?        @map("potential_cost") @db.Decimal(15, 2)
  actualCost      Decimal?        @map("actual_cost") @db.Decimal(15, 2)
  expectedDate    DateTime?       @map("expected_date")
  createdById     String          @map("created_by_id")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  createdBy       User            @relation("RiskCreator", fields: [createdById], references: [id])
  owner           User?           @relation("RiskOwner", fields: [ownerId], references: [id])
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([projectId, riskScore])
  @@map("project_risks")
}

model ProjectBudget {
  id              String         @id @default(uuid())
  projectId       String         @map("project_id")
  category        BudgetCategory
  name            String
  description     String?
  plannedAmount   Decimal        @map("planned_amount") @db.Decimal(15, 2)
  actualAmount    Decimal        @default(0) @map("actual_amount") @db.Decimal(15, 2)
  committedAmount Decimal        @default(0) @map("committed_amount") @db.Decimal(15, 2)
  currency        String         @default("SAR")
  periodStart     DateTime?      @map("period_start")
  periodEnd       DateTime?      @map("period_end")
  status          BudgetStatus   @default(ACTIVE)
  approvedById    String?        @map("approved_by_id")
  approvedAt      DateTime?      @map("approved_at")
  createdById     String         @map("created_by_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  approvedBy      User?          @relation("BudgetApprover", fields: [approvedById], references: [id])
  createdBy       User           @relation("BudgetCreator", fields: [createdById], references: [id])
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, category])
  @@map("project_budgets")
}

model ProjectActivity {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  action      String
  description String?
  entityType  String?  @map("entity_type")
  entityId    String?  @map("entity_id")
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation("ProjectActivityUser", fields: [userId], references: [id])

  @@index([projectId, createdAt])
  @@index([userId])
  @@map("project_activities")
}

// ==================== مهام ومشاريع (Tasks & Projects) ====================

model Task {
  id                String              @id @default(uuid())
  companyId         String              @map("company_id")
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  title             String
  description       String?             @db.Text
  status            TaskStatus          @default(TODO)
  priority          TaskPriority        @default(MEDIUM)
  categoryId        String?             @map("category_id")
  category          TaskCategory?       @relation(fields: [categoryId], references: [id])
  templateId        String?             @map("template_id")
  template          TaskTemplate?       @relation(fields: [templateId], references: [id])
  dueDate           DateTime?           @map("due_date")
  startDate         DateTime?           @map("start_date")
  completedAt       DateTime?           @map("completed_at")
  createdById       String              @map("created_by_id")
  createdBy         User                @relation("tasks_created_by_idTousers", fields: [createdById], references: [id])
  assigneeId        String?             @map("assignee_id")
  assignee          User?               @relation("tasks_assignee_idTousers", fields: [assigneeId], references: [id])
  recurrenceType    TaskRecurrenceType? @map("recurrence_type")
  recurrenceEnd     DateTime?           @map("recurrence_end")
  parentTaskId      String?             @map("parent_task_id")
  parentTask        Task?               @relation("TaskToTask", fields: [parentTaskId], references: [id])
  subTasks          Task[]              @relation("TaskToTask")
  progress          Int                 @default(0)
  tags              String[]            @default([])
  customFields      Json?               @map("custom_fields")
  order             Int                 @default(0)
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  approvedAt        DateTime?           @map("approved_at")
  approverId        String?             @map("approver_id")
  approver          User?               @relation("tasks_approver_idTousers", fields: [approverId], references: [id])
  reviewerId        String?             @map("reviewer_id")
  reviewer          User?               @relation("tasks_reviewer_idTousers", fields: [reviewerId], references: [id])
  reviewedAt        DateTime?           @map("reviewed_at")
  reviewRequestedAt DateTime?           @map("review_requested_at")
  isEscalated       Boolean             @default(false) @map("is_escalated")
  escalatedAt       DateTime?           @map("escalated_at")
  rejectedAt        DateTime?           @map("rejected_at")
  rejectionReason   String?             @map("rejection_reason")
  slaHours          Int?                @map("sla_hours")
  storyPoints       Int?                @map("story_points")
  estimatedHours    Decimal?            @map("estimated_hours") @db.Decimal(10, 2)

  // Relations
  activityLogs TaskActivityLog[]
  approvals    TaskApproval[]
  assignments  TaskAssignment[]
  attachments  TaskAttachment[]
  checklists   TaskChecklist[]
  comments     TaskComment[]
  evidences    TaskEvidence[]
  timeLogs     TaskTimeLog[]
  watchers     TaskWatcher[]
  sprintId     String?           @map("sprint_id")
  sprint       Sprint?           @relation(fields: [sprintId], references: [id])
  projectId    String?           @map("project_id")
  project      Project?          @relation("ProjectTasks", fields: [projectId], references: [id])

  // Dependencies
  blockedTasks  TaskDependency[] @relation("BlockedTask")
  blockingTasks TaskDependency[] @relation("BlockingTask")

  @@index([companyId, assigneeId])
  @@index([companyId, categoryId])
  @@index([companyId, createdById])
  @@index([companyId, dueDate])
  @@index([companyId, status])
  @@map("tasks")
}

model TaskCategory {
  id          String           @id @default(uuid())
  companyId   String           @map("company_id")
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  nameEn      String?          @map("name_en")
  color       String           @default("#3B82F6")
  icon        String?
  order       Int              @default(0)
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  tasks       Task[]
  automations TaskAutomation[]
  templates   TaskTemplate[]

  @@unique([companyId, name])
  @@index([companyId, isActive])
  @@map("task_categories")
}

model TaskTemplate {
  id                String        @id @default(uuid())
  companyId         String        @map("company_id")
  company           Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name              String
  nameEn            String?       @map("name_en")
  description       String?       @db.Text
  categoryId        String?       @map("category_id")
  category          TaskCategory? @relation(fields: [categoryId], references: [id])
  defaultPriority   TaskPriority  @default(MEDIUM) @map("default_priority")
  defaultDueDays    Int?          @map("default_due_days")
  checklistTemplate Json?         @map("checklist_template")
  workflowType      String?       @map("workflow_type")
  isActive          Boolean       @default(true) @map("is_active")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  tasks             Task[]

  @@unique([companyId, name])
  @@index([companyId, isActive])
  @@map("task_templates")
}

model Sprint {
  id              String       @id @default(uuid())
  companyId       String       @map("company_id")
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name            String
  goal            String?      @db.Text
  description     String?      @db.Text
  status          SprintStatus @default(PLANNING)
  startDate       DateTime?    @map("start_date")
  endDate         DateTime?    @map("end_date")
  startedAt       DateTime?    @map("started_at")
  completedAt     DateTime?    @map("completed_at")
  plannedPoints   Int          @default(0) @map("planned_points")
  completedPoints Int          @default(0) @map("completed_points")
  velocity        Float?
  createdById     String       @map("created_by_id")
  createdBy       User         @relation("SprintCreator", fields: [createdById], references: [id])
  tasks           Task[]
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  @@index([companyId, startDate])
  @@index([companyId, status])
  @@map("sprints")
}

model TaskAssignment {
  id           String   @id @default(uuid())
  taskId       String   @map("task_id")
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedAt   DateTime @default(now()) @map("assigned_at")
  assignedById String?  @map("assigned_by_id")

  @@unique([taskId, userId])
  @@map("task_assignments")
}

model TaskWatcher {
  id            String   @id @default(uuid())
  taskId        String   @map("task_id")
  task          Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchingSince DateTime @default(now()) @map("watching_since")

  @@unique([taskId, userId])
  @@map("task_watchers")
}

model TaskComment {
  id        String        @id @default(uuid())
  taskId    String        @map("task_id")
  task      Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String        @map("author_id")
  author    User          @relation(fields: [authorId], references: [id])
  content   String        @db.Text
  mentions  String[]      @default([])
  isEdited  Boolean       @default(false) @map("is_edited")
  editedAt  DateTime?     @map("edited_at")
  parentId  String?       @map("parent_id")
  parent    TaskComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   TaskComment[] @relation("CommentReplies")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@index([authorId])
  @@index([parentId])
  @@index([taskId])
  @@map("task_comments")
}

model TaskActivityLog {
  id          String   @id @default(uuid())
  taskId      String   @map("task_id")
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  action      String // STATUS_CHANGE, ASSIGNEE_CHANGE, etc.
  oldValue    String?  @map("old_value")
  newValue    String?  @map("new_value")
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([taskId])
  @@index([userId])
  @@map("task_activity_logs")
}

model TaskEvidence {
  id                  String             @id @default(uuid())
  taskId              String             @map("task_id")
  task                Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  submittedById       String             @map("submitted_by_id")
  submittedBy         User               @relation("task_evidences_submitted_by_idTousers", fields: [submittedById], references: [id])
  description         String?            @db.Text
  fileUrl             String?            @map("file_url")
  fileName            String?            @map("file_name")
  fileType            String?            @map("file_type")
  fileSize            Int?               @map("file_size")
  latitude            Float?
  longitude           Float?
  locationName        String?            @map("location_name")
  status              TaskEvidenceStatus @default(PENDING)
  verifiedById        String?            @map("verified_by_id")
  verifiedBy          User?              @relation("task_evidences_verified_by_idTousers", fields: [verifiedById], references: [id])
  verifiedAt          DateTime?          @map("verified_at")
  verificationComment String?            @map("verification_comment") @db.Text
  createdAt           DateTime           @default(now()) @map("created_at")

  @@index([submittedById])
  @@index([taskId])
  @@map("task_evidences")
}

model TaskTimeLog {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id])
  startTime   DateTime  @map("start_time")
  endTime     DateTime? @map("end_time")
  duration    Int? // in seconds
  description String?   @db.Text
  isBillable  Boolean   @default(false) @map("is_billable")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([taskId])
  @@index([userId])
  @@map("task_time_logs")
}

model TaskDependency {
  id             String         @id @default(uuid())
  blockedTaskId  String         @map("blocked_task_id")
  blockedTask    Task           @relation("BlockedTask", fields: [blockedTaskId], references: [id], onDelete: Cascade)
  blockingTaskId String         @map("blocking_task_id")
  blockingTask   Task           @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)
  type           DependencyType @default(BLOCKS)
  createdAt      DateTime       @default(now()) @map("created_at")

  @@unique([blockedTaskId, blockingTaskId])
  @@map("task_dependencies")
}

model TaskChecklist {
  id        String              @id @default(uuid())
  taskId    String              @map("task_id")
  task      Task                @relation(fields: [taskId], references: [id], onDelete: Cascade)
  title     String
  order     Int                 @default(0)
  items     TaskChecklistItem[]
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  @@index([taskId])
  @@map("task_checklists")
}

model TaskChecklistItem {
  id            String        @id @default(uuid())
  checklistId   String        @map("checklist_id")
  checklist     TaskChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  content       String        @db.Text
  isCompleted   Boolean       @default(false) @map("is_completed")
  order         Int           @default(0)
  completedAt   DateTime?     @map("completed_at")
  completedById String?       @map("completed_by_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([checklistId])
  @@map("task_checklist_items")
}

model TaskAutomation {
  id            String            @id @default(uuid())
  companyId     String            @map("company_id")
  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdById   String            @map("created_by_id")
  createdBy     User              @relation(fields: [createdById], references: [id])
  name          String
  description   String?           @db.Text
  isActive      Boolean           @default(true) @map("is_active")
  trigger       AutomationTrigger
  triggerConfig Json?             @map("trigger_config")
  action        AutomationAction
  actionConfig  Json?             @map("action_config")
  categoryId    String?           @map("category_id")
  category      TaskCategory?     @relation(fields: [categoryId], references: [id])
  priority      TaskPriority?
  lastRunAt     DateTime?         @map("last_run_at")
  run_count     Int               @default(0) @map("run_count")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([isActive])
  @@map("task_automations")
}

model TaskAttachment {
  id           String   @id @default(uuid())
  taskId       String   @map("task_id")
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedById String   @map("uploaded_by_id")
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  fileName     String   @map("file_name")
  fileSize     Int      @map("file_size")
  mimeType     String   @map("mime_type")
  storagePath  String   @map("storage_path")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([taskId])
  @@map("task_attachments")
}

model TaskApproval {
  id        String             @id @default(uuid())
  taskId    String             @map("task_id")
  task      Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String             @map("user_id")
  user      User               @relation(fields: [userId], references: [id])
  action    TaskApprovalAction
  comment   String?            @db.Text
  createdAt DateTime           @default(now()) @map("created_at")

  @@index([taskId])
  @@index([userId])
  @@map("task_approvals")
}

// ==================== Enums (Restored) ====================

enum TaskRecurrenceType {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum TaskApprovalAction {
  SUBMITTED_FOR_REVIEW
  REVIEWED
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum TaskEvidenceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DependencyType {
  BLOCKS
  BLOCKED_BY
  RELATED
  DUPLICATES
}

enum AutomationTrigger {
  STATUS_CHANGED
  DUE_DATE_NEAR
  DUE_DATE_PASSED
  DUE_DATE_REACHED
  TASK_CREATED
  TASK_ASSIGNED
  TASK_COMPLETED
  TASK_UPDATED
  PRIORITY_CHANGED
  COMMENT_ADDED
  EVIDENCE_SUBMITTED
  ATTACHMENT_ADDED
  OVERDUE
  SUBTASK_COMPLETED
}

enum AutomationAction {
  SEND_NOTIFICATION
  CHANGE_STATUS
  ASSIGN_USER
  ASSIGN_TO_USER
  SET_PRIORITY
  ADD_WATCHER
  SEND_EMAIL
  CREATE_SUBTASK
  ADD_COMMENT
  MOVE_TO_CATEGORY
  ADD_TAG
  REMOVE_TAG
  SET_DUE_DATE
  ESCALATE
  ARCHIVE
  DUPLICATE
}

enum PerformanceReviewCycleType {
  ANNUAL
  SEMI_ANNUAL
  QUARTERLY
  MONTHLY
  PROJECT_BASED
  CONTINUOUS
}

enum PerformanceReviewCycleStatus {
  DRAFT
  PLANNING
  ACTIVE
  SELF_REVIEW
  MANAGER_REVIEW
  CALIBRATION
  COMPLETED
  CANCELLED
}

enum PerformanceReviewStatus {
  NOT_STARTED
  PENDING
  SELF_REVIEW
  SELF_REVIEW_PENDING
  SELF_REVIEW_COMPLETED
  MANAGER_REVIEW
  MANAGER_REVIEW_PENDING
  MANAGER_REVIEW_COMPLETED
  CALIBRATION
  COMPLETED
  CANCELLED
}

enum GoalType {
  INDIVIDUAL
  TEAM
  DEPARTMENT
  COMPANY
  OKR
}

enum GoalStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  IN_PROGRESS
  ON_TRACK
  AT_RISK
  EXCEEDED
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum GoalDataSource {
  ATTENDANCE
  LEAVES
  TASKS
  OVERTIME
  POLICIES
  TRAINING
  CUSTODY
  PERFORMANCE_REVIEWS
  RECOGNITION
  SALES
  CUSTOM
}

enum CompetencyCategory {
  CORE
  LEADERSHIP
  FUNCTIONAL
  TECHNICAL
  VALUE
}

enum FeedbackRequestStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  DECLINED
  EXPIRED
}

enum RecognitionType {
  KUDOS
  BADGE
  AWARD
  ACHIEVEMENT
  SPOT_BONUS
  PEER_TO_PEER
  MANAGER_TO_EMPLOYEE
  ANNIVERSARY
  BIRTHDAY
  PROJECT_COMPLETION
  TOP_PERFORMER
}

enum DevelopmentGoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CompanyType {
  OPERATIONAL
  TECH
  SALES
  CREATIVE
  ADMIN
  HYBRID
}

enum EvalPhilosophy {
  RESULTS_FIRST
  BALANCED
  CULTURE_FIRST
}

enum KPISourceType {
  MANUAL
  SYSTEM_SYNC
  API_IMPORT
  CSV_IMPORT
}

enum KPIFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum UPEECompetencyCategory {
  UPEE_CORE
  UPEE_FUNCTIONAL
  UPEE_LEADERSHIP
}

enum FeedbackQuestionType {
  RATING_1_5
  RATING_1_10
  TEXT
  MULTIPLE_CHOICE
}

enum FeedbackRaterType {
  SELF
  MANAGER
  PEER
  STAKEHOLDER
  CUSTOMER
}

enum UPEE360Status {
  UPEE_PENDING
  UPEE_SENT
  UPEE_IN_PROGRESS
  UPEE_COMPLETED
  UPEE_EXPIRED
}

enum ConductSeverity {
  MINOR
  MAJOR
  CRITICAL
}

enum EvidenceType {
  URL_LINK
  FILE_UPLOAD
  DASHBOARD_SNAPSHOT
  TICKET_REFERENCE
  PR_COMMIT
  CUSTOMER_FEEDBACK
}

enum RatingBand {
  EXCEPTIONAL
  EXCEEDS
  MEETS
  PARTIALLY_MEETS
  NEEDS_IMPROVEMENT
}

enum ResultStatus {
  DRAFT
  SUBMITTED
  CALIBRATED
  FINALIZED
  ARCHIVED
}

enum CalibrationStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  LOCKED
}

enum IDPStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PIPStatus {
  ACTIVE
  EXTENDED
  COMPLETED
  ESCALATED
}

enum PIPOutcome {
  PASSED
  EXTENDED
  TERMINATED
}

enum TripStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

enum NitaqatZone {
  PLATINUM
  GREEN_HIGH
  GREEN_MID
  GREEN_LOW
  YELLOW
  RED
}

enum SaudizationStatus {
  COMPLIANT
  AT_RISK
  NON_COMPLIANT
  EXEMPT
}

enum ShiftType {
  REGULAR
  ROTATING
  SPLIT
  FLEXIBLE
  ON_CALL
}

enum ShiftStatus {
  DRAFT
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProgramStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum HealthStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
  COMPLETED
}

enum ProjectStatus {
  INITIATION
  PLANNING
  EXECUTION
  MONITORING
  CLOSING
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum ProjectPhaseType {
  INITIATION
  PLANNING
  EXECUTION
  MONITORING
  CLOSING
}

enum ProjectPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ProjectMemberRole {
  OWNER
  MANAGER
  LEAD
  MEMBER
  STAKEHOLDER
  VIEWER
}

enum PhaseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  MISSED
  CANCELLED
}

enum RiskCategory {
  TECHNICAL
  SCHEDULE
  COST
  RESOURCE
  SCOPE
  QUALITY
  EXTERNAL
  ORGANIZATIONAL
  OTHER
}

enum RiskProbability {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum RiskImpact {
  NEGLIGIBLE
  MINOR
  MODERATE
  MAJOR
  SEVERE
}

enum RiskResponse {
  AVOID
  MITIGATE
  TRANSFER
  ACCEPT
  MONITOR
}

enum RiskStatus {
  OPEN
  MITIGATING
  RESOLVED
  OCCURRED
  CLOSED
}

enum BudgetCategory {
  LABOR
  MATERIALS
  EQUIPMENT
  TRAVEL
  TRAINING
  SOFTWARE
  CONSULTING
  CONTINGENCY
  OTHER
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  FROZEN
  CLOSED
}

// ============ INTEGRATIONS & WEBHOOKS ============

model Webhook {
  id              String    @id @default(cuid())
  name            String
  url             String
  secret          String?
  events          String[] // ['task.created', 'task.updated', 'task.completed']
  isActive        Boolean   @default(true) @map("is_active")
  companyId       String    @map("company_id")
  createdById     String?   @map("created_by_id")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  failureCount    Int       @default(0) @map("failure_count")
  lastError       String?   @map("last_error")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  logs WebhookLog[]

  @@index([companyId, isActive])
  @@map("webhooks")
}

model WebhookLog {
  id           String   @id @default(cuid())
  webhookId    String   @map("webhook_id")
  event        String
  payload      Json
  statusCode   Int?     @map("status_code")
  response     String?
  duration     Int? // ms
  isSuccess    Boolean  @map("is_success")
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@map("webhook_logs")
}

model Integration {
  id          String    @id @default(cuid())
  type        String // 'slack', 'teams', 'github', 'gitlab', 'jira', 'trello', 'google', 'zapier'
  name        String
  companyId   String    @map("company_id")
  isActive    Boolean   @default(true) @map("is_active")
  config      Json      @default("{}") // OAuth tokens, settings, etc.
  metadata    Json? // Additional data
  connectedAt DateTime  @default(now()) @map("connected_at")
  lastSyncAt  DateTime? @map("last_sync_at")
  createdById String?   @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([companyId, type])
  @@index([companyId, isActive])
  @@map("integrations")
}

// ============================================
// Employee Debt Ledger (دفتر ديون الموظفين)
// لتتبع الأرصدة السالبة عندما تتجاوز الخصومات الراتب
// ============================================

model EmployeeDebtLedger {
  id         String @id @default(uuid())
  companyId  String @map("company_id")
  employeeId String @map("employee_id")

  // المبالغ
  originalAmount   Decimal @map("original_amount") @db.Decimal(10, 2)
  remainingBalance Decimal @map("remaining_balance") @db.Decimal(10, 2)

  // مصدر الدين
  sourceType DebtSourceType @map("source_type")
  sourceId   String?        @map("source_id") // payrollRunId, payslipId, etc.
  periodId   String?        @map("period_id")

  // التفاصيل
  reason String?
  notes  String?

  // الحالة
  status DebtStatus @default(ACTIVE)

  // التواريخ
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  settledAt DateTime? @map("settled_at")

  // العلاقات
  company      Company?          @relation(fields: [companyId], references: [id])
  employee     User              @relation("EmployeeDebts", fields: [employeeId], references: [id])
  period       PayrollPeriod?    @relation(fields: [periodId], references: [id])
  transactions DebtTransaction[]

  @@index([companyId, employeeId, status])
  @@index([employeeId, status])
  @@index([companyId, status, createdAt])
  @@map("employee_debt_ledger")
}

model DebtTransaction {
  id     String @id @default(uuid())
  debtId String @map("debt_id")

  // المبلغ
  amount        Decimal @db.Decimal(10, 2)
  balanceBefore Decimal @map("balance_before") @db.Decimal(10, 2)
  balanceAfter  Decimal @map("balance_after") @db.Decimal(10, 2)

  // نوع العملية
  transactionType DebtTransactionType @map("transaction_type")

  // المصدر (من أين تم الخصم/السداد)
  sourceType String? @map("source_type") // PAYROLL, MANUAL, ADVANCE, etc.
  sourceId   String? @map("source_id")

  // التفاصيل
  description String?
  processedBy String? @map("processed_by")

  // التواريخ
  createdAt DateTime @default(now()) @map("created_at")

  // العلاقات
  debt EmployeeDebtLedger @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@index([debtId, createdAt])
  @@map("debt_transactions")
}

enum DebtStatus {
  ACTIVE // دين نشط - لم يتم سداده بالكامل
  PARTIALLY_PAID // تم سداد جزء منه
  SETTLED // تم تسويته بالكامل
  WRITTEN_OFF // تم شطبه
  SUSPENDED // معلق مؤقتاً
  PENDING
  PAID
  CANCELLED
}

enum DebtSourceType {
  PAYROLL_NEGATIVE_BALANCE // رصيد سالب من الرواتب
  ADVANCE_OVERPAYMENT // سلفة زائدة
  LOAN // قرض
  PENALTY // غرامة
  OVERPAYMENT_CORRECTION // تصحيح دفع زائد
  OTHER // أخرى
  ADVANCE
  CUSTODY
  PAYROLL_OVERPAYMENT
}

enum DebtTransactionType {
  INITIAL_DEBT // تسجيل الدين الأولي
  PAYROLL_DEDUCTION // خصم من الراتب
  MANUAL_PAYMENT // سداد يدوي
  ADJUSTMENT // تعديل
  WRITE_OFF // شطب
  REVERSAL // عكس عملية سابقة
  CREATION
  PAYMENT
  CANCELLATION
}

// ==================== نظام اكتشاف إيقاف التطبيق/الهاتف ====================

enum OfflineEventType {
  PHONE_OFF // الهاتف مغلق
  APP_CLOSED // التطبيق مغلق
  NO_SIGNAL // فقدان الإشارة
  APP_UNINSTALLED // التطبيق محذوف (مفترض بعد timeout طويل)
}

model EmployeeOfflineEvent {
  id        String @id @default(uuid())
  userId    String @map("user_id")
  companyId String @map("company_id")

  // نوع الحدث
  eventType OfflineEventType @map("event_type")

  // وقت البداية والنهاية
  startedAt DateTime  @map("started_at")
  endedAt   DateTime? @map("ended_at")

  // مدة الانقطاع (بالدقائق)
  durationMinutes Int? @map("duration_minutes")

  // آخر موقع معروف قبل الانقطاع
  lastLatitude  Decimal? @map("last_latitude") @db.Decimal(10, 8)
  lastLongitude Decimal? @map("last_longitude") @db.Decimal(11, 8)

  // هل تم الإشعار؟
  notified   Boolean   @default(false)
  notifiedAt DateTime? @map("notified_at")

  // هل الموظف عاد للاتصال؟
  isResolved Boolean @default(false) @map("is_resolved")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, startedAt])
  @@index([userId, isResolved])
  @@index([companyId, isResolved, notified])
  @@map("employee_offline_events")
}

enum HolidayApplicationType {
  ALL
  SAUDI_ONLY
  NON_SAUDI_ONLY
  SPECIFIC_BRANCH
  SPECIFIC_DEPT
  SPECIFIC_JOB_TITLE
  BRANCH
  DEPARTMENT
  SPECIFIC_EMPLOYEES
  EXCLUDE_EMPLOYEES
}

enum OccurrenceResetPeriod {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  NEVER
  YEARLY
  DAILY
  WEEKLY
}

enum RetroApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  APPLIED
  CANCELLED
  CALCULATING
  REVIEWED
}

enum PolicyApprovalAction {
  APPROVE
  REJECT
  REQUEST_CHANGES
  SUBMITTED
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum SalaryComponentType {
  EARNING
  DEDUCTION
}

enum SalaryComponentNature {
  FIXED
  VARIABLE
  FORMULA
}

enum PayrollFrequency {
  MONTHLY
  WEEKLY
  BIWEEKLY
  DAILY
}

enum PayrollStatus {
  DRAFT
  INPUTS_COLLECTED
  CALCULATED
  HR_REVIEWED
  FINANCE_APPROVED
  LOCKED
  PAID
  CANCELLED
  ARCHIVED
}

// ==================== Missing Production Models ====================

model CostCenterAllocation {
  id                  String    @id @default(uuid())
  companyId           String?   @map("company_id")
  userId              String    @map("user_id")
  costCenterId        String    @map("cost_center_id")
  primaryCostCenterId String?   @map("primary_cost_center_id")
  percentage          Decimal   @db.Decimal(5, 2)
  effectiveFrom       DateTime  @default(now()) @map("effective_from")
  effectiveTo         DateTime? @map("effective_to")
  allocationType      String    @default("POSITION") @map("allocation_type")
  reason              String?
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  company           Company?    @relation(fields: [companyId], references: [id])
  costCenter        CostCenter  @relation("cost_center_allocations_cost_center_idTocost_centers", fields: [costCenterId], references: [id])
  primaryCostCenter CostCenter? @relation("cost_center_allocations_primary_cost_center_idTocost_centers", fields: [primaryCostCenterId], references: [id])
  user              User        @relation(fields: [userId], references: [id])

  @@unique([userId, costCenterId, effectiveFrom])
  @@index([costCenterId])
  @@index([effectiveFrom, effectiveTo])
  @@index([userId, isActive])
  @@map("cost_center_allocations")
}

model Goal {
  id                   String          @id @default(uuid())
  companyId            String          @map("company_id")
  ownerId              String          @map("owner_id")
  managerId            String?         @map("manager_id")
  type                 GoalType        @default(INDIVIDUAL)
  status               GoalStatus      @default(DRAFT)
  title                String
  titleEn              String?         @map("title_en")
  description          String?
  startDate            DateTime?       @map("start_date") @db.Date
  dueDate              DateTime?       @map("due_date") @db.Date
  completedAt          DateTime?       @map("completed_at")
  targetValue          Decimal?        @map("target_value") @db.Decimal(10, 2)
  currentValue         Decimal?        @map("current_value") @db.Decimal(10, 2)
  unit                 String?
  progress             Int             @default(0)
  weight               Int             @default(100)
  category             String?
  isStretch            Boolean         @default(false) @map("is_stretch")
  parentGoalId         String?         @map("parent_goal_id")
  alignedCompanyGoalId String?         @map("aligned_company_goal_id")
  approvedBy           String?         @map("approved_by")
  approvedAt           DateTime?       @map("approved_at")
  rejectionReason      String?         @map("rejection_reason")
  aiGenerated          Boolean         @default(false) @map("ai_generated")
  aiPrompt             String?         @map("ai_prompt")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  autoCalculated       Boolean         @default(false) @map("auto_calculated")
  dataSource           GoalDataSource? @map("data_source")
  dataSourceConfig     Json?           @map("data_source_config")
  lastSyncAt           DateTime?       @map("last_sync_at")
  employeeId           String?         @map("employee_id") @db.VarChar(255)

  goalCheckIns GoalCheckIn[]
  goalRatings  GoalRating[]
  company      Company       @relation(fields: [companyId], references: [id])
  owner        User          @relation(fields: [ownerId], references: [id])
  parentGoal   Goal?         @relation("GoalToGoal", fields: [parentGoalId], references: [id])
  subGoals     Goal[]        @relation("GoalToGoal")
  keyResults   KeyResult[]

  @@index([companyId, ownerId])
  @@index([companyId, status])
  @@index([dataSource])
  @@index([type])
  @@map("goals")
}

model KeyResult {
  id                String             @id @default(uuid())
  goalId            String             @map("goal_id")
  title             String
  description       String?
  targetValue       Decimal            @map("target_value") @db.Decimal(10, 2)
  currentValue      Decimal            @default(0) @map("current_value") @db.Decimal(10, 2)
  unit              String             @default("%")
  progress          Int                @default(0)
  dueDate           DateTime?          @map("due_date") @db.Date
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  keyResultCheckIns KeyResultCheckIn[]
  goal              Goal               @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("key_results")
}

model KeyResultCheckIn {
  id            String    @id @default(uuid())
  keyResultId   String    @map("key_result_id")
  userId        String    @map("user_id")
  previousValue Decimal   @map("previous_value") @db.Decimal(10, 2)
  newValue      Decimal   @map("new_value") @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  keyResults    KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id])

  @@index([keyResultId])
  @@map("key_result_check_ins")
}

model GoalCheckIn {
  id            String   @id @default(uuid())
  goalId        String   @map("goal_id")
  userId        String   @map("user_id")
  previousValue Decimal  @map("previous_value") @db.Decimal(10, 2)
  newValue      Decimal  @map("new_value") @db.Decimal(10, 2)
  statusUpdate  String?  @map("status_update")
  blockers      String?
  nextSteps     String?  @map("next_steps")
  confidence    Int?
  createdAt     DateTime @default(now()) @map("created_at")
  goals         Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])

  @@index([goalId])
  @@map("goal_check_ins")
}

model GoalRating {
  id                String            @id @default(uuid())
  reviewId          String            @map("review_id")
  goalId            String            @map("goal_id")
  selfRating        Decimal?          @map("self_rating") @db.Decimal(3, 2)
  selfComments      String?           @map("self_comments")
  managerRating     Decimal?          @map("manager_rating") @db.Decimal(3, 2)
  managerComments   String?           @map("manager_comments")
  finalRating       Decimal?          @map("final_rating") @db.Decimal(3, 2)
  weight            Int               @default(100)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  goals             Goal              @relation(fields: [goalId], references: [id])
  performanceReview PerformanceReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, goalId])
  @@map("goal_ratings")
}

model KPIDefinition {
  id          String          @id @default(uuid())
  companyId   String          @map("company_id")
  jobFamilyId String?         @map("job_family_id")
  code        String
  name        String
  nameAr      String?         @map("name_ar")
  description String?
  unit        String
  formula     Json?
  thresholds  Json
  sourceType  KPISourceType   @default(MANUAL) @map("source_type")
  frequency   KPIFrequency    @default(MONTHLY)
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  assignments KPIAssignment[]
  company     Company         @relation(fields: [companyId], references: [id])

  @@unique([companyId, code])
  @@index([companyId])
  @@index([jobFamilyId])
  @@map("kpi_definitions")
}

model KPIAssignment {
  id              String                 @id @default(uuid())
  cycleId         String                 @map("cycle_id")
  employeeId      String                 @map("employee_id")
  kpiDefinitionId String                 @map("kpi_definition_id")
  target          Decimal                @db.Decimal(15, 2)
  weight          Int                    @default(100)
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")
  actualValue     Decimal?               @map("actual_value") @db.Decimal(10, 2)
  notes           String?
  score           Decimal?               @db.Decimal(5, 2)
  cycle           PerformanceReviewCycle @relation(fields: [cycleId], references: [id])
  user            User                   @relation(fields: [employeeId], references: [id])
  kpiDefinition   KPIDefinition          @relation(fields: [kpiDefinitionId], references: [id])
  kpiEntries      KPIEntry[]

  @@unique([cycleId, employeeId, kpiDefinitionId])
  @@index([cycleId, employeeId])
  @@index([employeeId])
  @@map("kpi_assignments")
}

model KPIEntry {
  id            String        @id @default(uuid())
  assignmentId  String        @map("assignment_id")
  periodStart   DateTime      @map("period_start")
  periodEnd     DateTime      @map("period_end")
  value         Decimal       @db.Decimal(15, 2)
  source        String?
  createdBy     String        @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  notes         String?
  kpiAssignment KPIAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@map("kpi_entries")
}

model PerformanceReviewCycle {
  id                      String                       @id @default(uuid())
  companyId               String                       @map("company_id")
  name                    String
  nameEn                  String?                      @map("name_en")
  type                    PerformanceReviewCycleType   @default(ANNUAL)
  status                  PerformanceReviewCycleStatus @default(DRAFT)
  periodStart             DateTime                     @map("period_start") @db.Date
  periodEnd               DateTime                     @map("period_end") @db.Date
  selfReviewStart         DateTime?                    @map("self_review_start")
  selfReviewEnd           DateTime?                    @map("self_review_end")
  managerReviewStart      DateTime?                    @map("manager_review_start")
  managerReviewEnd        DateTime?                    @map("manager_review_end")
  feedbackStart           DateTime?                    @map("feedback_start")
  feedbackEnd             DateTime?                    @map("feedback_end")
  calibrationStart        DateTime?                    @map("calibration_start")
  calibrationEnd          DateTime?                    @map("calibration_end")
  includeSelfReview       Boolean                      @default(true) @map("include_self_review")
  include360Feedback      Boolean                      @default(false) @map("include_360_feedback")
  includeGoalRating       Boolean                      @default(true) @map("include_goal_rating")
  includeCompetencyRating Boolean                      @default(true) @map("include_competency_rating")
  goalWeight              Int                          @default(40) @map("goal_weight")
  competencyWeight        Int                          @default(40) @map("competency_weight")
  valueWeight             Int                          @default(20) @map("value_weight")
  competencyFrameworkId   String?                      @map("competency_framework_id")
  createdAt               DateTime                     @default(now()) @map("created_at")
  updatedAt               DateTime                     @updatedAt @map("updated_at")

  kpiAssignments     KPIAssignment[]
  company            Company             @relation(fields: [companyId], references: [id])
  performanceReviews PerformanceReview[]

  @@index([companyId, status])
  @@map("performance_review_cycles")
}

model PerformanceReview {
  id                     String                  @id @default(uuid())
  companyId              String                  @map("company_id")
  cycleId                String                  @map("cycle_id")
  employeeId             String                  @map("employee_id")
  managerId              String                  @map("manager_id")
  status                 PerformanceReviewStatus @default(PENDING)
  selfRating             Decimal?                @map("self_rating") @db.Decimal(3, 2)
  selfComments           String?                 @map("self_comments")
  selfAchievements       Json?                   @map("self_achievements")
  selfChallenges         Json?                   @map("self_challenges")
  selfSubmittedAt        DateTime?               @map("self_submitted_at")
  managerRating          Decimal?                @map("manager_rating") @db.Decimal(3, 2)
  managerComments        String?                 @map("manager_comments")
  managerStrengths       Json?                   @map("manager_strengths")
  managerImprovements    Json?                   @map("manager_improvements")
  managerSubmittedAt     DateTime?               @map("manager_submitted_at")
  finalRating            Decimal?                @map("final_rating") @db.Decimal(3, 2)
  finalComments          String?                 @map("final_comments")
  calibrationNotes       String?                 @map("calibration_notes")
  calibratedBy           String?                 @map("calibrated_by")
  calibratedAt           DateTime?               @map("calibrated_at")
  performanceScore       Int?                    @map("performance_score")
  potentialScore         Int?                    @map("potential_score")
  nineBoxPosition        String?                 @map("nine_box_position")
  employeeAcknowledged   Boolean                 @default(false) @map("employee_acknowledged")
  employeeAcknowledgedAt DateTime?               @map("employee_acknowledged_at")
  employeeDisagreed      Boolean                 @default(false) @map("employee_disagreed")
  employeeDisagreeReason String?                 @map("employee_disagree_reason")
  aiSummary              String?                 @map("ai_summary")
  aiBiasFlags            Json?                   @map("ai_bias_flags")
  aiRecommendations      Json?                   @map("ai_recommendations")
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")

  cycle       PerformanceReviewCycle @relation(fields: [cycleId], references: [id])
  employee    User                   @relation("EmployeeReviews", fields: [employeeId], references: [id])
  manager     User                   @relation("ManagerReviews", fields: [managerId], references: [id])
  goalRatings GoalRating[]

  @@unique([cycleId, employeeId])
  @@index([companyId, status])
  @@index([employeeId])
  @@index([managerId])
  @@map("performance_reviews")
}

// ==================== Missing Production Models (Batch 2) ====================

model Recognition {
  id         String                @id @default(uuid())
  companyId  String                @map("company_id")
  senderId   String                @map("sender_id")
  receiverId String                @map("receiver_id")
  type       RecognitionType       @default(PEER_TO_PEER)
  message    String
  points     Int                   @default(0)
  createdAt  DateTime              @default(now()) @map("created_at")
  updatedAt  DateTime              @updatedAt @map("updated_at")
  company    Company               @relation(fields: [companyId], references: [id])
  sender     User                  @relation("RecognitionSender", fields: [senderId], references: [id])
  receiver   User                  @relation("RecognitionReceiver", fields: [receiverId], references: [id])
  reactions  RecognitionReaction[]

  @@index([companyId, createdAt])
  @@index([receiverId])
  @@map("recognitions")
}

model RecognitionReaction {
  id            String      @id @default(uuid())
  recognitionId String      @map("recognition_id")
  userId        String      @map("user_id")
  emoji         String
  createdAt     DateTime    @default(now()) @map("created_at")
  recognition   Recognition @relation(fields: [recognitionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id])

  @@unique([recognitionId, userId, emoji])
  @@map("recognition_reactions")
}

model SuccessionPlan {
  id         String                @id @default(uuid())
  companyId  String                @map("company_id")
  positionId String                @map("position_id")
  targetYear Int                   @map("target_year")
  createdAt  DateTime              @default(now()) @map("created_at")
  updatedAt  DateTime              @updatedAt @map("updated_at")
  company    Company               @relation(fields: [companyId], references: [id])
  candidates SuccessionCandidate[]

  @@unique([positionId, targetYear])
  @@map("succession_plans")
}

model SuccessionCandidate {
  id                 String         @id @default(uuid())
  planId             String         @map("plan_id")
  employeeId         String         @map("employee_id")
  readinessLevel     String         @map("readiness_level")
  riskOfLeaving      String?        @map("risk_of_leaving")
  developmentActions Json?          @map("development_actions")
  notes              String?
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  plan               SuccessionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  employee           User           @relation(fields: [employeeId], references: [id])

  @@unique([planId, employeeId])
  @@map("succession_candidates")
}

// ==================== Social Feed (المنشورات والتواصل الاجتماعي) ====================

// نوع المنشور
enum PostType {
  POST // منشور عادي
  ANNOUNCEMENT // إعلان رسمي
  PROMOTED // منشور مروج
}

// حالة المنشور
enum PostStatus {
  DRAFT // مسودة
  PENDING_APPROVAL // في انتظار الموافقة
  PUBLISHED // منشور
  ARCHIVED // مؤرشف
  REJECTED // مرفوض
}

// نوع الظهور/الرؤية
enum VisibilityType {
  PUBLIC // عام - للجميع في الشركة
  DEPARTMENT // للقسم فقط
  TEAM // للفريق فقط
  TARGETED // مستهدف بقواعد محددة
  MANAGERS_ONLY // للمدراء فقط
  HR_ONLY // للموارد البشرية فقط
  PRIVATE // خاص
}

// نوع الاستهداف (ABAC Targeting)
enum TargetType {
  BRANCH // فرع
  DEPARTMENT // قسم
  TEAM // فريق
  USER // مستخدم محدد
  ROLE // دور وظيفي
  JOB_TITLE // مسمى وظيفي
  GRADE // درجة وظيفية
  CONTRACT_TYPE // نوع العقد
  SHIFT // وردية
  LOCATION // موقع
  TAG // وسم
}

// نوع الإشارة (@mention)
enum MentionType {
  USER // إشارة لمستخدم
  TEAM // إشارة لفريق
  DEPARTMENT // إشارة لقسم
}

model Post {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  authorId  String  @map("author_id")
  author    User    @relation("PostAuthor", fields: [authorId], references: [id])

  // نوع المنشور
  type PostType @default(POST)

  // المحتوى (ثنائي اللغة)
  title     String? // عنوان المنشور (اختياري)
  titleEn   String? @map("title_en")
  content   String  @db.Text // محتوى المنشور
  contentEn String? @map("content_en") @db.Text

  // إعدادات الظهور
  visibilityType VisibilityType @default(PUBLIC) @map("visibility_type")
  isPinned       Boolean        @default(false) @map("is_pinned")
  pinnedUntil    DateTime?      @map("pinned_until")

  // التوقيت
  publishedAt DateTime? @map("published_at") // تاريخ النشر الفعلي
  scheduledAt DateTime? @map("scheduled_at") // تاريخ النشر المجدول
  expiresAt   DateTime? @map("expires_at") // تاريخ انتهاء الصلاحية

  // إعدادات التفاعل
  requireAcknowledge   Boolean @default(false) @map("require_acknowledge") // يتطلب تأكيد القراءة
  hideAfterAcknowledge Boolean @default(false) @map("hide_after_acknowledge") // إخفاء بعد التأكيد
  allowComments        Boolean @default(true) @map("allow_comments") // السماح بالتعليقات

  // حالة المنشور
  status PostStatus @default(DRAFT)

  // إحصائيات الوصول
  reachCount      Int @default(0) @map("reach_count") // عدد المستخدمين الذين شاهدوا
  impressionCount Int @default(0) @map("impression_count") // عدد مرات الظهور
  clickCount      Int @default(0) @map("click_count") // عدد النقرات

  // إعدادات الترويج
  priority       Int       @default(0) // أولوية الظهور (أعلى = أهم)
  maxImpressions Int?      @map("max_impressions") // الحد الأقصى للظهور
  promotedUntil  DateTime? @map("promoted_until") // تاريخ انتهاء الترويج

  // العلاقات - الاستهداف والتفاعلات
  targets   PostTarget[]
  reactions PostReaction[]
  comments  PostComment[]
  mentions  PostMention[]

  // العلاقات - التتبع والتحليلات
  views        PostView[]
  impressions  PostImpression[]
  acknowledges PostAcknowledge[]
  attachments  PostAttachment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, status, publishedAt])
  @@index([authorId])
  @@index([companyId, isPinned])
  @@map("posts")
}

// نموذج استهداف المنشور (ABAC Targeting)
model PostTarget {
  id     String @id @default(uuid())
  postId String @map("post_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  targetType  TargetType @map("target_type")
  targetValue String     @map("target_value") // قيمة الاستهداف (معرف الفرع، القسم، المستخدم، إلخ)

  // قواعد الشمول/الاستثناء
  isExclusion Boolean @default(false) @map("is_exclusion") // استثناء بدلاً من شمول

  createdAt DateTime @default(now()) @map("created_at")

  @@index([postId])
  @@index([targetType, targetValue])
  @@map("post_targets")
}

// نموذج التفاعلات على المنشور (Like, Love, Celebrate)
model PostReaction {
  id     String @id @default(uuid())
  postId String @map("post_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String @map("user_id")
  user   User   @relation("PostReactions", fields: [userId], references: [id])

  emoji String // رمز التفاعل (like, love, celebrate, support, insightful, etc.)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([postId, userId, emoji]) // مستخدم واحد يمكنه إضافة كل نوع تفاعل مرة واحدة
  @@index([postId])
  @@index([userId])
  @@map("post_reactions")
}

// نموذج التعليقات على المنشور
model PostComment {
  id       String @id @default(uuid())
  postId   String @map("post_id")
  post     Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId String @map("author_id")
  author   User   @relation("PostComments", fields: [authorId], references: [id])

  content  String   @db.Text // محتوى التعليق
  mentions String[] @default([]) // قائمة معرفات المستخدمين المذكورين

  // التعديل
  isEdited Boolean   @default(false) @map("is_edited")
  editedAt DateTime? @map("edited_at")

  // الردود المتسلسلة (Threading)
  parentId String?       @map("parent_id")
  parent   PostComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  PostComment[] @relation("CommentReplies")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@map("post_comments")
}

// نموذج الإشارات (@mentions) في المنشور
model PostMention {
  id     String @id @default(uuid())
  postId String @map("post_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  mentionType MentionType @map("mention_type")
  mentionId   String      @map("mention_id") // معرف المستخدم، الفريق، أو القسم

  // موقع الإشارة في المحتوى (لتمييزها بصرياً)
  startIndex Int? @map("start_index")
  endIndex   Int? @map("end_index")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([postId])
  @@index([mentionType, mentionId])
  @@map("post_mentions")
}

// نموذج مشاهدات المنشور (Unique Views Tracking)
model PostView {
  id     String @id @default(uuid())
  postId String @map("post_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String @map("user_id")
  user   User   @relation("PostViews", fields: [userId], references: [id])

  // معلومات المشاهدة
  viewedAt   DateTime @default(now()) @map("viewed_at") // وقت المشاهدة
  duration   Int? // مدة المشاهدة بالثواني (اختياري)
  deviceType String?  @map("device_type") // WEB, MOBILE, TABLET
  ipAddress  String?  @map("ip_address") // عنوان IP للتحليلات

  // unique constraint - كل مستخدم يُحسب مرة واحدة فقط
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([viewedAt])
  @@map("post_views")
}

// نموذج ظهورات المنشور (Impressions Tracking - للإحصائيات)
model PostImpression {
  id     String  @id @default(uuid())
  postId String  @map("post_id")
  post   Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String? @map("user_id") // قد يكون null للمستخدمين غير المسجلين
  user   User?   @relation("PostImpressions", fields: [userId], references: [id])

  // معلومات الظهور
  impressedAt DateTime @default(now()) @map("impressed_at") // وقت الظهور
  source      String? // مصدر الظهور: FEED, SEARCH, NOTIFICATION, DIRECT_LINK
  position    Int? // موقع المنشور في الـ Feed عند الظهور
  deviceType  String?  @map("device_type") // WEB, MOBILE, TABLET
  sessionId   String?  @map("session_id") // معرف الجلسة للتتبع

  @@index([postId])
  @@index([userId])
  @@index([impressedAt])
  @@index([source])
  @@map("post_impressions")
}

// نموذج تأكيد قراءة المنشور الرسمي (Acknowledgement Tracking)
model PostAcknowledge {
  id     String @id @default(uuid())
  postId String @map("post_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String @map("user_id")
  user   User   @relation("PostAcknowledges", fields: [userId], references: [id])

  // معلومات التأكيد
  acknowledgedAt DateTime @default(now()) @map("acknowledged_at") // وقت التأكيد
  deviceType     String?  @map("device_type") // WEB, MOBILE, TABLET
  ipAddress      String?  @map("ip_address") // عنوان IP للتوثيق

  // ملاحظة اختيارية (في حال طلب تعليق من المستخدم)
  note String? @db.Text

  // unique constraint - كل مستخدم يؤكد مرة واحدة فقط
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([acknowledgedAt])
  @@map("post_acknowledges")
}

// نموذج مرفقات المنشور (File Attachments)
model PostAttachment {
  id     String @id @default(uuid())
  postId String @map("post_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // معلومات الملف
  fileName     String  @map("file_name") // اسم الملف الأصلي
  fileUrl      String  @map("file_url") // رابط الملف المخزن
  fileType     String  @map("file_type") // نوع الملف: IMAGE, VIDEO, DOCUMENT, AUDIO, OTHER
  mimeType     String  @map("mime_type") // نوع MIME للملف
  fileSize     Int     @map("file_size") // حجم الملف بالبايت
  thumbnailUrl String? @map("thumbnail_url") // رابط الصورة المصغرة (للصور والفيديو)

  // بيانات إضافية
  altText     String? @map("alt_text") // نص بديل للصورة (accessibility)
  description String? // وصف المرفق
  sortOrder   Int     @default(0) @map("sort_order") // ترتيب العرض

  // إحصائيات
  downloadCount Int @default(0) @map("download_count") // عدد مرات التحميل

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([postId])
  @@index([fileType])
  @@map("post_attachments")
}

// ==================== أحداث التقويم (Calendar Events) ====================

// نوع الحدث
enum EventType {
  MEETING // اجتماع
  INTERVIEW // مقابلة
  PAYROLL // رواتب
  HOLIDAY // عطلة
  DEADLINE // موعد نهائي
  ANNOUNCEMENT // إعلان
  OTHER // أخرى
}

// حالة الحدث
enum EventStatus {
  SCHEDULED // مجدول
  CANCELLED // ملغي
  DONE // تم
}

// حالة RSVP للحضور
enum RSVPStatus {
  INVITED // مدعو
  GOING // سيحضر
  MAYBE // ربما
  DECLINED // رفض
}

// نموذج الحدث (Calendar Event)
model Event {
  id        String  @id @default(uuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creatorId String  @map("creator_id")
  creator   User    @relation("EventCreator", fields: [creatorId], references: [id])

  // معلومات الحدث (ثنائي اللغة)
  title         String
  titleEn       String? @map("title_en")
  description   String? @db.Text
  descriptionEn String? @map("description_en") @db.Text

  // التوقيت
  startAt  DateTime @map("start_at")
  endAt    DateTime @map("end_at")
  isAllDay Boolean  @default(false) @map("is_all_day")
  timezone String   @default("Asia/Riyadh")

  // الموقع والرابط
  location    String?
  meetingLink String? @map("meeting_link")

  // النوع والظهور
  eventType      EventType      @default(MEETING) @map("event_type")
  visibilityType VisibilityType @default(PUBLIC) @map("visibility_type")

  // الحالة
  status EventStatus @default(SCHEDULED)

  // إعدادات التكرار (اختياري)
  isRecurring    Boolean @default(false) @map("is_recurring")
  recurrenceRule String? @map("recurrence_rule") // قاعدة التكرار (RRULE format)

  // معلومات إضافية
  color String? // لون الحدث في التقويم
  icon  String? // أيقونة الحدث

  // العلاقات
  attendees EventAttendee[]
  targets   EventTarget[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId, startAt])
  @@index([companyId, status])
  @@index([creatorId])
  @@map("events")
}

// نموذج حضور الحدث (Event Attendees with RSVP)
model EventAttendee {
  id      String @id @default(uuid())
  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId  String @map("user_id")
  user    User   @relation("EventAttendee", fields: [userId], references: [id])

  // حالة RSVP
  rsvpStatus  RSVPStatus @default(INVITED) @map("rsvp_status")
  respondedAt DateTime?  @map("responded_at") // تاريخ الرد

  // ملاحظات الحضور
  note String? @db.Text

  // إشعار التذكير
  reminderSent   Boolean   @default(false) @map("reminder_sent")
  reminderSentAt DateTime? @map("reminder_sent_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // كل مستخدم يُدعى مرة واحدة فقط لكل حدث
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([rsvpStatus])
  @@map("event_attendees")
}

// نموذج استهداف الحدث (Event Targeting - similar to PostTarget)
model EventTarget {
  id      String @id @default(uuid())
  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // نوع وقيمة الاستهداف
  targetType  TargetType @map("target_type")
  targetValue String     @map("target_value") // قيمة الاستهداف (معرف الفرع، القسم، المستخدم، إلخ)

  // قواعد الشمول/الاستثناء
  isExclusion Boolean @default(false) @map("is_exclusion") // استثناء بدلاً من شمول

  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventId])
  @@index([targetType, targetValue])
  @@map("event_targets")
}

// ==================== Odoo ERP Integration ====================

// سجل مزامنة Odoo
model OdooSyncLog {
  id           String  @id @default(uuid())
  companyId    String  @map("company_id")
  operation    String // EMPLOYEE_SYNC, ATTENDANCE_PUSH, LEAVE_SYNC, PAYROLL_EXPORT
  direction    String // INBOUND, OUTBOUND
  status       String // SUCCESS, FAILED, PARTIAL
  recordCount  Int     @default(0) @map("record_count")
  successCount Int     @default(0) @map("success_count")
  failedCount  Int     @default(0) @map("failed_count")
  errors       Json?
  duration     Int? // milliseconds
  triggeredBy  String? @map("triggered_by") // USER, SCHEDULED, WEBHOOK
  metadata     Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([operation])
  @@index([status])
  @@index([createdAt])
  @@map("odoo_sync_logs")
}

// طابور إعادة المحاولة
model OdooRetryQueue {
  id          String    @id @default(uuid())
  companyId   String    @map("company_id")
  operation   String
  payload     Json
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  lastError   String?   @map("last_error") @db.Text
  nextRetryAt DateTime? @map("next_retry_at")
  status      String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  priority    Int       @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("odoo_retry_queue")
}

// ربط الحقول بين النظامين
model OdooFieldMapping {
  id          String  @id @default(uuid())
  companyId   String  @map("company_id")
  entityType  String  @map("entity_type") // EMPLOYEE, ATTENDANCE, LEAVE, PAYROLL
  localField  String  @map("local_field")
  odooField   String  @map("odoo_field")
  odooModel   String  @map("odoo_model") // hr.employee, hr.attendance, etc.
  transformer String? // DATE_FORMAT, ENUM_MAP, CONCAT, SPLIT
  config      Json? // Transformer configuration
  isRequired  Boolean @default(false) @map("is_required")
  isActive    Boolean @default(true) @map("is_active")
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, entityType, localField])
  @@index([companyId])
  @@index([entityType])
  @@map("odoo_field_mappings")
}

// تكوين Odoo لكل شركة
model OdooCompanyConfig {
  id         String @id @default(uuid())
  companyId  String @unique @map("company_id")
  odooUrl    String @map("odoo_url")
  database   String
  username   String
  apiKey     String @map("api_key")
  odooUserId Int?   @map("odoo_user_id")

  // Sync Settings
  syncInterval   Int     @default(5) @map("sync_interval") // minutes
  autoSync       Boolean @default(true) @map("auto_sync")
  syncEmployees  Boolean @default(true) @map("sync_employees")
  syncAttendance Boolean @default(true) @map("sync_attendance")
  syncLeaves     Boolean @default(true) @map("sync_leaves")
  syncPayroll    Boolean @default(false) @map("sync_payroll")

  // Conflict Resolution
  conflictStrategy String @default("LATEST_WINS") @map("conflict_strategy") // ODOO_WINS, LOCAL_WINS, LATEST_WINS, MANUAL

  // Webhook Settings
  webhookUrl    String? @map("webhook_url")
  webhookSecret String? @map("webhook_secret")

  isActive   Boolean   @default(true) @map("is_active")
  lastSyncAt DateTime? @map("last_sync_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([companyId])
  @@map("odoo_company_configs")
}

// ربط الموظفين بين النظامين
model OdooEmployeeMapping {
  id             String    @id @default(uuid())
  companyId      String    @map("company_id")
  userId         String    @map("user_id")
  odooEmployeeId Int       @map("odoo_employee_id")
  odooData       Json?     @map("odoo_data") // Cached Odoo employee data
  lastSyncedAt   DateTime? @map("last_synced_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, userId])
  @@unique([companyId, odooEmployeeId])
  @@index([companyId])
  @@index([userId])
  @@map("odoo_employee_mappings")
}

// Webhooks من/إلى Odoo
model OdooWebhookEvent {
  id          String    @id @default(uuid())
  companyId   String    @map("company_id")
  direction   String // INBOUND, OUTBOUND
  eventType   String    @map("event_type") // attendance.created, employee.updated, etc.
  payload     Json
  status      String    @default("PENDING") // PENDING, DELIVERED, FAILED
  attempts    Int       @default(0)
  lastError   String?   @map("last_error") @db.Text
  processedAt DateTime? @map("processed_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@map("odoo_webhook_events")
}

// سجل التعارضات للمراجعة اليدوية
model OdooConflict {
  id           String    @id @default(uuid())
  companyId    String    @map("company_id")
  entityType   String    @map("entity_type") // EMPLOYEE, ATTENDANCE, LEAVE
  entityId     String    @map("entity_id")
  localData    Json      @map("local_data")
  odooData     Json      @map("odoo_data")
  conflictType String    @map("conflict_type") // DATA_MISMATCH, MISSING_LOCAL, MISSING_ODOO
  resolution   String? // KEEP_LOCAL, KEEP_ODOO, MERGED, SKIPPED
  resolvedBy   String?   @map("resolved_by")
  resolvedAt   DateTime? @map("resolved_at")
  notes        String?   @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([entityType])
  @@index([resolution])
  @@map("odoo_conflicts")
}

// ==================== Muqeem Platform Integration ====================

enum MuqeemTransactionType {
  IQAMA_ISSUE
  IQAMA_RENEW
  IQAMA_TRANSFER
  VISA_EXIT_REENTRY_ISSUE
  VISA_EXIT_REENTRY_CANCEL
  VISA_EXIT_REENTRY_EXTEND
  VISA_EXIT_REENTRY_REPRINT
  VISA_FINAL_EXIT_ISSUE
  VISA_FINAL_EXIT_CANCEL
  PASSPORT_EXTEND
  PASSPORT_RENEW
}

enum MuqeemTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model MuqeemTransaction {
  id        String                  @id @default(uuid())
  companyId String                  @map("company_id")
  company   Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String                  @map("user_id")
  user      User                    @relation("MuqeemUserTransactions", fields: [userId], references: [id])
  type      MuqeemTransactionType
  status    MuqeemTransactionStatus @default(PENDING)

  // Transaction Details
  payload      Json? // Data sent to Muqeem
  response     Json? // Data received from Muqeem
  externalRef  String? @map("external_ref") // Transaction ID in Muqeem
  errorMessage String? @map("error_message")

  // File attachments (e.g. PDF Visa, PDF Iqama)
  fileUrl String? @map("file_url")

  createdById String? @map("created_by_id")
  createdBy   User?   @relation("MuqeemCreatedTransactions", fields: [createdById], references: [id])

  executedAt DateTime? @map("executed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("muqeem_transactions")
}

model MuqeemConfig {
  id        String  @id @default(uuid())
  companyId String  @unique @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  username String
  password String // Should be encrypted
  isActive Boolean @default(true) @map("is_active")

  // Notification settings
  iqamaExpiryDays     Int     @default(30) @map("iqama_expiry_days")
  passportExpiryDays  Int     @default(60) @map("passport_expiry_days")
  enableNotifications Boolean @default(true) @map("enable_notifications")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("muqeem_configs")
}

// ==================== نهاية الخدمة (End of Service) ====================

enum TerminationReason {
  RESIGNATION // استقالة
  TERMINATION // إنهاء خدمات من الشركة
  END_OF_CONTRACT // انتهاء العقد
  RETIREMENT // تقاعد
  DEATH // وفاة
}

enum TerminationStatus {
  PENDING // في انتظار التأكيد
  APPROVED // تم التأكيد
  PAID // تم الصرف
  CANCELLED // ملغي
}

model EmployeeTermination {
  id         String @id @default(uuid())
  employeeId String @map("employee_id")
  companyId  String @map("company_id")

  reason         TerminationReason
  lastWorkingDay DateTime          @map("last_working_day")

  // المبالغ المحسوبة
  baseSalary       Decimal @map("base_salary") @db.Decimal(18, 2)
  yearsOfService   Decimal @map("years_of_service") @db.Decimal(10, 4)
  totalEos         Decimal @map("total_eos") @db.Decimal(18, 2)
  adjustedEos      Decimal @map("adjusted_eos") @db.Decimal(18, 2)
  leavePayout      Decimal @map("leave_payout") @db.Decimal(18, 2)
  remainingLeave   Int     @default(0) @map("remaining_leave")
  outstandingLoans Decimal @map("outstanding_loans") @db.Decimal(18, 2)
  netSettlement    Decimal @map("net_settlement") @db.Decimal(18, 2)

  // حالة المعالجة
  status    TerminationStatus @default(PENDING)
  payslipId String?           @map("payslip_id")

  // تفاصيل إضافية
  notes           String?
  calculationJson Json?   @map("calculation_json")

  createdById  String    @map("created_by_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  approvedById String?   @map("approved_by_id")
  approvedAt   DateTime? @map("approved_at")
  paidAt       DateTime? @map("paid_at")

  employee   User     @relation("EmployeeTerminations", fields: [employeeId], references: [id])
  company    Company  @relation(fields: [companyId], references: [id])
  createdBy  User     @relation("TerminationCreator", fields: [createdById], references: [id])
  approvedBy User?    @relation("TerminationApprover", fields: [approvedById], references: [id])
  payslip    Payslip? @relation(fields: [payslipId], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@map("employee_terminations")
}
